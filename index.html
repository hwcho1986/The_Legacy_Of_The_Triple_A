<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Legacy Of The Triple A - 대괴도 AAA의 유산 v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-red: #b91c1c;
            --accent-gold: #d4af37;
            --glass-bg: rgba(0, 0, 0, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Outfit', 'Noto Serif KR', serif;
            color: #fff;
            user-select: none;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            background: #000;
            position: relative;
        }

        /* Layer System */
        .layer {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .layer-interactive {
            pointer-events: auto;
        }

        /* Effects & Animations */
        .fade-in {
            animation: fadeIn var(--duration, 1s) ease forwards;
        }

        .fade-out {
            animation: fadeOut var(--duration, 1s) ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .shake {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-5px, 5px);
            }

            50% {
                transform: translate(5px, -5px);
            }

            75% {
                transform: translate(-5px, -5px);
            }
        }

        .blind-in {
            clip-path: inset(0 0 100% 0);
            animation: blindIn var(--duration, 1s) ease forwards;
        }

        @keyframes blindIn {
            to {
                clip-path: inset(0 0 0 0);
            }
        }

        /* Glassmorphism UI */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .premium-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .premium-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        /* Typewriter & Icon */
        .cursor-blink::after {
            content: '▼';
            margin-left: 8px;
            color: var(--accent-gold);
            animation: blink 0.8s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Character Transitions */
        .char-obj {
            transition: all 1s ease-in-out;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- bgcolor -->
        <div id="bgcolor-layer" class="layer" style="z-index: 0; background-color: #000000;"></div>

        <!-- onbgimage (multiple) -->
        <div id="bgimage-layer" class="layer" style="z-index: 10;"></div>

        <!-- oncharacter -->
        <div id="character-layer" class="layer"
            style="z-index: 20; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5%;">
        </div>

        <!-- dialogue / speak -->
        <div id="dialogue-layer" class="layer layer-interactive" style="z-index: 40; display: none;">
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[1400px] glass p-8 rounded-3xl cursor-pointer"
                id="dialogue-box">
                <div id="speaker-name"
                    class="text-3xl font-bold text-accent-gold mb-4 border-l-4 border-primary-red pl-4"></div>
                <div id="dialogue-text" class="text-2xl leading-relaxed font-serif min-h-[100px]"></div>
            </div>
        </div>

        <!-- oncolor / onimage -->
        <div id="overlay-layer" class="layer" style="z-index: 50;"></div>

        <!-- title / ontitle -->
        <div id="title-layer" class="layer" style="z-index: 70;"></div>

        <!-- choice / quiz -->
        <div id="interaction-layer" class="layer layer-interactive" style="z-index: 80;"></div>

        <!-- System UI (Always on top) -->
        <div id="system-ui" class="absolute top-0 w-full p-6 flex justify-between items-center" style="z-index: 100;">
            <button onclick="Engine.toggleBacklog()"
                class="premium-btn px-6 py-2 rounded-full text-sm tracking-widest uppercase text-white">Log</button>
            <div class="flex gap-4">
                <button onclick="Engine.toggleAuto()" id="auto-btn"
                    class="premium-btn px-6 py-2 rounded-full text-sm text-white">AUTO: OFF</button>
                <button onclick="Engine.showSettings()"
                    class="premium-btn px-6 py-2 rounded-full text-sm text-white">SETTING</button>
                <button onclick="Engine.toMenu()"
                    class="premium-btn px-6 py-2 rounded-full text-sm text-white">EXIT</button>
            </div>
        </div>

        <!-- Backlog Modal -->
        <div id="backlog-modal" class="absolute inset-0 glass z-[200] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel">HISTORY</h2>
                <button onclick="Engine.toggleBacklog()" class="text-2xl">✕</button>
            </div>
            <div id="backlog-content" class="flex-1 overflow-y-auto pr-4 space-y-6 text-xl"></div>
        </div>

        <!-- Debug Overlay -->
        <div id="debug-overlay"
            class="absolute top-20 right-6 w-80 p-4 glass rounded-xl text-xs font-mono text-red-400 hidden"
            style="z-index: 1000;"></div>
    </div>

    <script>
        const State = {
            currentIndex: 0,
            eventHistory: [],
            events: [],
            localization: {},
            backlog: [],
            characters: {}, // { id: { el, pos, expression, ... } }
            backgrounds: {}, // { num: { el, ... } }
            audio: {
                bgm: new Audio(),
                amb: new Audio(),
                sfx: new Audio()
            },
            settings: {
                textSpeed: 'normal',
                autoMode: false,
                opacity: 0.7,
                bgmVol: 0.5,
                sfxVol: 0.5,
                voiceVol: 0.8
            },
            isTextAnimating: false,
            currentVoice: null,
            stats: { hp: 100, keywords: [] }
        };

        const Engine = {
            async init() {
                try {
                    const [resP, resL] = await Promise.all([
                        fetch('assets/Table/PLAY.JSON'),
                        fetch('assets/Table/LOCALIZATION.JSON')
                    ]);
                    State.events = await resP.json();
                    State.events.sort((a, b) => a.Index - b.Index);
                    State.localization = await resL.json();

                    this.executeEvent(State.events[0].Index);
                } catch (e) {
                    this.debug(`Failed to load tables: ${e.message}`);
                    // Fallback to manual event if files missing
                }
            },

            debug(msg) {
                const el = document.getElementById('debug-overlay');
                el.innerText = `[DEBUG] ${msg}`;
                el.classList.remove('hidden');
                setTimeout(() => el.classList.add('hidden'), 5000);
            },

            t(key) {
                if (!key) return '';
                if (typeof key !== 'string') return JSON.stringify(key);
                if (key.startsWith('"') && key.endsWith('"')) return key.slice(1, -1);
                if (State.localization[key]) {
                    const entry = State.localization[key];
                    return entry['KO'] || entry['EN'] || key;
                }
                return key;
            },

            async executeEvent(index) {
                const event = State.events.find(e => e.Index === index);
                if (!event) {
                    this.debug(`Index ${index} not found`);
                    return;
                }
                const currentRelIdx = State.events.indexOf(event);
                State.currentIndex = currentRelIdx;

                console.log("Executing:", event.type, event);

                switch (event.type) {
                    case 'bgcolor':
                        const bgLayer = document.getElementById('bgcolor-layer');
                        bgLayer.style.transition = `background-color ${event.Value02 || 0}s`;
                        bgLayer.style.backgroundColor = event.Value01 || '#000000';
                        this.next(event.Index, 'Read');
                        break;

                    case 'onbgimage':
                        this.handleBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgimage':
                        this.handleOffBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'oncharacter':
                        this.handleCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcharacter':
                        this.handleOffCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'speak':
                        this.handleSpeak(event);
                        break;

                    case 'oncolor':
                        this.handleOverlayColor(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcolor':
                        this.handleOverlayColor(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onimage':
                        this.handleOverlayImage(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offimage':
                        this.handleOverlayImage(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'title':
                        this.handleTitle(event);
                        break;

                    case 'ontitle':
                        this.handleTitle(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offtitle':
                        document.getElementById('title-layer').innerHTML = '';
                        this.next(event.Index, 'Read');
                        break;

                    case 'choice':
                        this.handleChoice(event);
                        break;

                    case 'quiz01':
                        this.handleQuiz(event);
                        break;

                    case 'onbgm':
                        this.playAudio('bgm', event.Value01, event.Value02 === 'loop', event.Value03);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgm':
                        this.stopAudio('bgm', event.Value01);
                        this.next(event.Index, 'Read');
                        break;

                    case 'jump':
                        this.executeEvent(parseInt(event.Value01));
                        break;

                    case 'Wait':
                        setTimeout(() => this.next(event.Index, 'Read'), (event.Value01 || 0) * 1000);
                        break;

                    case 'anieffect':
                        this.handleAniEffect(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'next':
                        this.initNextChapter(event.Value01);
                        break;

                    case 'end':
                        alert("END OF CHAPTER");
                        location.reload();
                        break;

                    default:
                        this.debug(`Unknown type: ${event.type}`);
                        this.next(event.Index, 'Read');
                }
            },

            next(index, mode) {
                if (mode === 'Read') {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) {
                        this.executeEvent(State.events[nextRelIdx].Index);
                    }
                }
            },

            // --- Handlers ---
            handleBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const img = document.createElement('img');
                img.src = data.Value01;
                img.className = `layer object-cover w-full h-full fade-in`;
                img.style.setProperty('--duration', `${data.Value03 || 0}s`);
                img.dataset.num = data.Value04 || 1;

                layer.appendChild(img);
                const sorted = [...layer.querySelectorAll('img')].sort((a, b) => b.dataset.num - a.dataset.num);
                layer.innerHTML = '';
                sorted.forEach(el => layer.appendChild(el));
            },

            handleOffBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const target = layer.querySelector(`img[data-num="${data.Value01}"]`);
                if (target) {
                    target.classList.add('fade-out');
                    setTimeout(() => target.remove(), (data.Value03 || 0.5) * 1000);
                }
            },

            handleCharacter(data) {
                const layer = document.getElementById('character-layer');
                let char = State.characters[data.Value01];
                if (!char) {
                    const el = document.createElement('img');
                    el.className = 'char-obj h-full object-contain mx-[-10%]';
                    char = { el, id: data.Value01 };
                    State.characters[data.Value01] = char;
                    layer.appendChild(el);
                }

                char.el.src = `assets/images/character/${data.Value01}.png`;
                if (data.Value02 && data.Value02 !== 'normal') char.el.src = `assets/images/character/${data.Value01}_${data.Value02}.png`;

                if (data.Value04 === 'fadein') {
                    char.el.classList.add('fade-in');
                    char.el.style.setProperty('--duration', `${data.Value05 || 1}s`);
                }
            },

            handleOffCharacter(data) {
                const char = State.characters[data.Value01];
                if (char) {
                    char.el.classList.add('fade-out');
                    setTimeout(() => {
                        char.el.remove();
                        delete State.characters[data.Value01];
                    }, (data.Value05 || 0.5) * 1000);
                }
            },

            handleSpeak(data) {
                const layer = document.getElementById('dialogue-layer');
                const speaker = document.getElementById('speaker-name');
                const text = document.getElementById('dialogue-text');
                const box = document.getElementById('dialogue-box');

                layer.style.display = 'block';
                const nameStr = this.t(data.Value02);
                speaker.innerText = nameStr;

                // Highlight character
                Object.values(State.characters).forEach(c => {
                    if (c.id === data.Value01) {
                        c.el.style.transform = 'scale(1.15)';
                        c.el.style.filter = 'brightness(1.1)';
                        c.el.style.zIndex = '30';
                    } else {
                        c.el.style.transform = 'scale(1)';
                        c.el.style.filter = 'brightness(0.7)';
                        c.el.style.zIndex = '20';
                    }
                });

                const content = this.t(data.Value03);
                State.backlog.push({ name: nameStr, text: content });

                this.typeText(text, content, () => {
                    if (State.settings.autoMode) {
                        const autoWait = 1000 + (content.length * 50);
                        setTimeout(() => {
                            if (State.settings.autoMode && !State.isTextAnimating) this.next(data.Index, 'Read');
                        }, autoWait);
                    }
                });

                if (data.Value04) {
                    this.playAudio('voice', data.Value04);
                }

                box.onclick = (e) => {
                    e.stopPropagation();
                    if (State.isTextAnimating) {
                        State.isTextAnimating = false;
                    } else {
                        box.onclick = null;
                        this.next(data.Index, 'Read');
                    }
                };
            },

            typeText(el, str, cb) {
                el.innerText = '';
                el.classList.remove('cursor-blink');
                State.isTextAnimating = true;
                let i = 0;
                const speeds = { slow: 100, normal: 30, fast: 10 };
                const speed = speeds[State.settings.textSpeed] || 30;

                const timer = setInterval(() => {
                    if (!State.isTextAnimating) {
                        el.innerText = str;
                        clearInterval(timer);
                        el.classList.add('cursor-blink');
                        cb();
                        return;
                    }
                    el.innerText += str[i++];
                    if (i >= str.length) {
                        clearInterval(timer);
                        State.isTextAnimating = false;
                        el.classList.add('cursor-blink');
                        cb();
                    }
                }, speed);
            },

            handleOverlayColor(data, on) {
                const layer = document.getElementById('overlay-layer');
                if (on) {
                    layer.style.pointerEvents = 'auto';
                    const el = document.createElement('div');
                    el.className = 'layer fade-in';
                    el.style.backgroundColor = data.Value01;
                    const opacityStr = data.Value03 || '100%';
                    el.style.opacity = opacityStr.includes('%') ? parseInt(opacityStr) / 100 : opacityStr;
                    el.style.setProperty('--duration', `${data.Value02 || 0.5}s`);
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                    layer.style.pointerEvents = 'none';
                }
            },

            handleOverlayImage(data, on) {
                const layer = document.getElementById('overlay-layer');
                if (on) {
                    const el = document.createElement('img');
                    el.src = data.Value01;
                    el.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 fade-in';
                    if (data.Value02) {
                        const parts = String(data.Value02).split(',');
                        if (parts.length === 2) {
                            el.style.width = parts[0] + 'px';
                            el.style.height = parts[1] + 'px';
                        }
                    }
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                }
            },

            handleTitle(data, keep = false) {
                const layer = document.getElementById('title-layer');
                const el = document.createElement('div');
                el.className = 'absolute inset-0 flex items-center justify-center text-center p-20 z-10';
                el.style.fontFamily = data.Value01 || 'Cinzel, serif';
                el.style.fontSize = (data.Value02 || 48) + 'px';
                el.style.color = data.Value03 || '#fff';
                el.innerText = '';
                layer.appendChild(el);

                this.typeText(el, this.t(data.Value04), () => {
                    if (!keep) {
                        setTimeout(() => {
                            el.classList.add('fade-out');
                            setTimeout(() => { el.remove(); this.next(data.Index, 'Read'); }, 1000);
                        }, 2000);
                    }
                });
            },

            handleChoice(data) {
                const layer = document.getElementById('interaction-layer');
                const container = document.createElement('div');
                container.className = 'flex flex-col gap-6 items-center justify-center h-full bg-black/40';

                const addBtn = (txt, target) => {
                    const btn = document.createElement('button');
                    btn.className = 'premium-btn glass px-20 py-8 rounded-2xl text-2xl w-[600px] text-white';
                    btn.innerText = this.t(txt);
                    btn.onclick = () => {
                        layer.innerHTML = '';
                        this.executeEvent(target);
                    };
                    container.appendChild(btn);
                };

                addBtn(data.Value01, data.Value02);
                if (data.Value03) addBtn(data.Value03, data.Value04);

                layer.appendChild(container);
            },

            handleQuiz(data) {
                const layer = document.getElementById('interaction-layer');
                layer.innerHTML = '';
                const quizBox = document.createElement('div');
                quizBox.className = 'absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm';
                quizBox.innerHTML = `
                    <div class="glass p-12 rounded-[3rem] w-[800px] text-center">
                        <div class="text-xl opacity-60 mb-8 border-b border-white/10 pb-4 tracking-[0.5em]">QUERY NODE</div>
                        <div class="text-3xl mb-12 font-serif">${this.t(data.Value01)}</div>
                        <input id="quiz-input" autocomplete="off" class="w-full bg-white/5 border border-white/20 p-6 rounded-xl text-3xl mb-8 focus:border-accent-gold outline-none text-center" placeholder="...">
                        <div class="flex gap-4 mb-8">
                            <button id="hint-1" class="premium-btn p-4 rounded-xl flex-1 text-xs text-white">HINT 1</button>
                            ${data.Value04 ? `<button id="hint-2" class="premium-btn p-4 rounded-xl flex-1 text-xs text-white">HINT 2</button>` : ''}
                            ${data.Value05 ? `<button id="hint-3" class="premium-btn p-4 rounded-xl flex-1 text-xs text-white">HINT 3</button>` : ''}
                        </div>
                        <button id="quiz-submit" class="premium-btn w-full p-6 rounded-xl text-2xl bg-primary-red/20 border-primary-red text-white">EXECUTE</button>
                    </div>
                `;
                layer.appendChild(quizBox);

                const input = quizBox.querySelector('#quiz-input');
                input.focus();

                const answers = Array.isArray(data.Value02) ? data.Value02 : [data.Value02];

                const check = () => {
                    const val = input.value.toLowerCase().replace(/\s/g, '');
                    const isCorrect = answers.some(a => String(a).toLowerCase().replace(/\s/g, '') === val);
                    if (isCorrect) {
                        layer.innerHTML = '';
                        this.next(data.Index, 'Read');
                    } else {
                        quizBox.querySelector('.glass').classList.add('shake');
                        setTimeout(() => quizBox.querySelector('.glass').classList.remove('shake'), 500);
                        input.value = '';
                    }
                };

                quizBox.querySelector('#quiz-submit').onclick = check;
                input.onkeydown = (e) => { if (e.key === 'Enter') check(); };
                quizBox.querySelector('#hint-1').onclick = () => alert(this.t(data.Value03));
                if (data.Value04) quizBox.querySelector('#hint-2').onclick = () => alert(this.t(data.Value04));
                if (data.Value05) quizBox.querySelector('#hint-3').onclick = () => alert(this.t(data.Value05));
            },

            handleAniEffect(data) {
                const target = data.Value01 === 'all' ? document.getElementById('game-container') : (State.characters[data.Value01]?.el);
                if (target) {
                    target.classList.add(data.Value02);
                    setTimeout(() => target.classList.remove(data.Value02), (data.Value03 || 1) * 1000);
                }
            },

            playAudio(type, path, loop = false, delay = 0) {
                setTimeout(() => {
                    let aud = State.audio[type];
                    if (!aud) aud = new Audio();
                    aud.src = path;
                    aud.loop = loop;
                    aud.volume = (State.settings[type + 'Vol'] || 0.5);
                    aud.play().catch(e => console.log("Audio play blocked", e));
                }, delay * 1000);
            },

            stopAudio(type, fade = 0) {
                const aud = State.audio[type];
                if (!aud) return;
                if (fade > 0) {
                    let vol = aud.volume;
                    const interval = setInterval(() => {
                        vol -= 0.05;
                        if (vol <= 0) {
                            aud.pause();
                            clearInterval(interval);
                        } else aud.volume = vol;
                    }, fade * 100);
                } else aud.pause();
            },

            // --- UI ---
            toggleAuto() {
                State.settings.autoMode = !State.settings.autoMode;
                document.getElementById('auto-btn').innerText = `AUTO: ${State.settings.autoMode ? 'ON' : 'OFF'}`;
                if (State.settings.autoMode && !State.isTextAnimating) {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) this.executeEvent(State.events[nextRelIdx].Index);
                }
            },
            toggleBacklog() {
                const modal = document.getElementById('backlog-modal');
                const content = document.getElementById('backlog-content');
                if (modal.classList.contains('hidden')) {
                    content.innerHTML = State.backlog.map(item => `
                        <div class="border-b border-white/5 pb-4">
                            <span class="text-accent-gold font-bold mr-4">[${item.name || 'SYSTEM'}]</span>
                            <span>${item.text}</span>
                        </div>
                    `).join('');
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },
            showSettings() { alert("Volume and Speed settings in progress..."); },
            toMenu() { if (confirm("Quit to main menu?")) location.reload(); }
        }

        window.onload = () => Engine.init();
    </script>
</body>

</html>