<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Legacy Of The Triple A - 괴도 AAA의 유산</title>

    <!-- Social Media Meta Tags (OG, Twitter) -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://hwcho1986.github.io/The_Legacy_Of_The_Triple_A/">
    <meta property="og:title" content="[The Legacy Of The Triple A - 괴도 AAA의 유산]">
    <meta property="og:description" content="대괴도 AAA의 유산을 찾아 떠나는 미스터리 추리 비주얼 노벨">
    <meta property="og:image"
        content="https://hwcho1986.github.io/The_Legacy_Of_The_Triple_A/assets/images/og-image.jpg?v=1.1">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="[The Legacy Of The Triple A - 괴도 AAA의 유산]">
    <meta name="twitter:description" content="대괴도 AAA의 유산을 찾아 떠나는 미스터리 추리 비주얼 노벨">
    <meta name="twitter:image"
        content="https://hwcho1986.github.io/The_Legacy_Of_The_Triple_A/assets/images/og-image.jpg?v=1.1">

    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&family=Nanum+Pen+Script&display=swap"
        rel="stylesheet">
    <script src="assets/js/data_loader.js"></script>
    <style>
        :root {
            --primary-red: #8b0000;
            --accent-gold: #c5a059;
            --bg-deep: #121212;
            --glass-bg: rgba(18, 18, 18, 0.85);
            --glass-border: rgba(197, 160, 89, 0.2);
            --text-main: #e0e0e0;
            --font-serif: 'Cinzel', 'Noto Serif KR', serif;
            --font-sans: 'Outfit', sans-serif;

            /* Responsive Scale Base */
            --fluid-8-32: clamp(0.5rem, 1vw, 2rem);
            --fluid-16-48: clamp(1rem, 2vw, 3rem);
            --fluid-24-64: clamp(1.5rem, 3vw, 4rem);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            word-break: keep-all;
            /* KR: 어절 단위 줄바꿈 유지 */
            overflow-wrap: break-word;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-deep);
            font-family: var(--font-sans);
            color: var(--text-main);
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            height: 100vh;
            /* Fallback for older browsers */
            height: 100dvh;
            /* Dynamic viewport height for mobile */
            width: 100vw;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #000;
            position: relative;
        }

        /* Layer System */
        .layer {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .layer-interactive {
            pointer-events: auto;
        }

        /* Effects & Animations */
        .fade-in {
            animation: fadeIn var(--duration, 1s) ease forwards;
        }

        .fade-out {
            animation: fadeOut var(--duration, 1s) ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .logo-anim {
            animation: logoSwing 6s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(197, 160, 89, 0.3));
        }

        @keyframes logoSwing {

            0%,
            100% {
                transform: rotate(-3deg) translateY(0);
            }

            50% {
                transform: rotate(3deg) translateY(-5px);
            }
        }

        .premium-btn-highlight {
            background: linear-gradient(135deg, rgba(197, 160, 89, 0.25), rgba(197, 160, 89, 0.1));
            border: 2px solid var(--accent-gold) !important;
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.4);
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .premium-btn-highlight:hover,
        .premium-btn-highlight.active {
            box-shadow: 0 0 35px rgba(197, 160, 89, 0.7);
            transform: scale(1.08);
            background: linear-gradient(135deg, rgba(197, 160, 89, 0.4), rgba(197, 160, 89, 0.2));
        }

        .menu-item.active:not(.premium-btn-highlight) {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
            color: #fff;
            transform: scale(1.02);
        }

        .shake {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-5px, 0);
            }

            75% {
                transform: translate(5px, 0);
            }
        }

        .blind-in {
            clip-path: inset(0 0 100% 0);
            animation: blindIn var(--duration, 1s) ease forwards;
        }

        @keyframes blindIn {
            to {
                clip-path: inset(0 0 0 0);
            }
        }

        /* Glassmorphism UI */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* Characters */
        .char-container {
            position: absolute;
            bottom: 0;
            width: fit-content;
            height: clamp(65%, 85dvh, 95%);
            /* 4K 대응을 위한 유동적 높이 */
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transform: translateX(-50%);
            transition: all var(--duration, 0.5s) cubic-bezier(0.2, 1, 0.3, 1);
            z-index: 20;
            will-change: transform, left, filter;
        }

        .char-obj {
            height: 100%;
            width: auto;
            max-width: none;
            object-fit: contain;
            display: block;
            transition: transform 0.3s ease, filter 0.3s ease;
            transform: scale(var(--char-scale, 1)) translateY(var(--char-y-offset, 0%));
        }

        .premium-btn {
            background: linear-gradient(135deg, rgba(197, 160, 89, 0.1), transparent);
            border: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .premium-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(197, 160, 89, 0.2), transparent);
            transition: 0.5s;
        }

        .premium-btn:hover {
            background: rgba(197, 160, 89, 0.15);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(197, 160, 89, 0.2);
        }

        .premium-btn:hover::after {
            left: 100%;
        }

        /* Typewriter & Icon */
        .cursor-blink::after {
            content: '▼';
            margin-left: 8px;
            color: var(--accent-gold);
            animation: blink 0.8s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Character Transitions & Framing */
        /* Character Transitions & Framing - Optimized for V-Rule */
        /*
        .char-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: auto;
            height: 85vh;
            max-height: 90vh;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
            pointer-events: none;
            z-index: 20;
            will-change: transform, left;

            transform: translateX(-50%);

            --char-scale: 1;
            --char-y-offset: 0%;
        }

        .char-obj {
            height: 100% !important;
            width: auto !important;
            object-fit: contain;
            object-position: bottom center;
            filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.9));
            pointer-events: none;
            display: block;

            transform: scale(var(--char-scale)) translateY(var(--char-y-offset));
            transform-origin: center center;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        */

        @media (max-width: 768px) {
            .char-container {
                /* Mobile: Height slightly smaller to avoid header conflict, but still huge enough to show chest */
                height: 80vh;
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }

            20% {
                opacity: 0.1;
            }

            80% {
                opacity: 0.1;
            }

            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .floating-shape {
            position: absolute;
            background: var(--accent-gold);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            animation: float 15s linear infinite;
        }

        .note-popup {
            position: absolute;
            background: #fff;
            color: #000;
            padding: 20px 40px;
            border-radius: 4px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.05);
            font-family: 'Noto Serif KR', serif;
            font-size: 1.25rem;
            z-index: 2200;
            /* 퀴즈 상단보다 위 */
            max-width: 300px;
            pointer-events: auto;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .note-popup::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(transparent, transparent 24px, rgba(0, 0, 0, 0.05) 25px);
            pointer-events: none;
        }

        /* Menu Selection */
        .menu-item.active,
        .menu-item:hover {
            color: var(--accent-gold);
            transform: scale(1.05);
            text-shadow: 0 0 25px rgba(197, 160, 89, 0.6);
            border-color: var(--accent-gold);
            background: rgba(197, 160, 89, 0.1);
        }

        .menu-item.active::before,
        .menu-item:hover::before {
            content: '▶';
            position: absolute;
            left: -30px;
            color: var(--accent-gold);
            animation: bounceLeft 0.5s infinite alternate;
        }

        @keyframes bounceLeft {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-10px);
            }
        }

        .backlog-choice-selected {
            color: #4ade80;
            font-weight: bold;
            text-decoration: underline;
        }

        .backlog-choice-unselected {
            text-decoration: line-through;
            opacity: 0.4;
        }

        /* Tabs */
        .tab-btn.active {
            border-bottom: 2px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Mobile Responsive Overrides - Optimized for 832px (6.2") */
        @media (max-width: 832px) {
            .text-8xl {
                font-size: clamp(3rem, 10vw, 5rem) !important;
            }

            .text-7xl {
                font-size: clamp(2.5rem, 8vw, 4rem) !important;
            }

            .text-6xl {
                font-size: clamp(2rem, 6vw, 3rem) !important;
            }

            .text-5xl {
                font-size: clamp(1.75rem, 5vw, 2.5rem) !important;
            }

            .text-4xl {
                font-size: clamp(1.5rem, 4vw, 2rem) !important;
            }

            .text-3xl {
                font-size: clamp(1.25rem, 3.5vw, 1.75rem) !important;
            }

            .text-2xl {
                font-size: clamp(1.1rem, 3vw, 1.4rem) !important;
            }

            .text-xl {
                font-size: clamp(1rem, 2.5vw, 1.25rem) !important;
            }

            .p-20 {
                padding: 5vw !important;
            }

            .p-12 {
                padding: 4vw !important;
            }

            .p-10 {
                padding: 3vw !important;
            }

            #main-menu-list {
                width: 85%;
            }

            #dialogue-box {
                padding: 1.25rem;
                bottom: clamp(1rem, 4dvh, 2.5rem);
                width: 94% !important;
                border-left-width: 4px;
            }

            #speaker-name {
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
            }

            #dialogue-text {
                font-size: clamp(1rem, 4.5vw, 1.25rem);
                min-height: 60px;
                line-height: 1.6;
            }

            .modal-content {
                width: 95% !important;
                padding: 1.25rem !important;
            }

            .premium-btn {
                padding: 0.8rem 1rem !important;
            }

            .menu-item {
                font-size: clamp(1.1rem, 5vw, 1.4rem) !important;
                padding: 0.6rem 0 !important;
            }

            .char-container {
                height: 85%;
                /* Ensure character visible on taller mobile screens */
            }
        }

        /* ultra-wide / 4K optimization */
        @media (min-width: 2560px) {
            body {
                font-size: 24px;
            }

            #main-menu-list {
                max-width: 600px;
            }

            #dialogue-box {
                max-width: 1800px;
                padding: 3rem;
            }

            #dialogue-text {
                font-size: 2.5rem;
            }

            #speaker-name {
                font-size: 2rem;
            }
        }

        /* Modal Styles */
        .modal-popup {
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), 0 0 20px rgba(197, 160, 89, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 1000px) {
            .modal-popup {
                width: 95%;
                max-width: 95%;
            }
        }

        /* Ambient Pattern */
        .ambient-pattern {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l30 30-30 30L0 30z' fill-opacity='0.02' fill='%23c5a059' fill-rule='evenodd'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 5;
            opacity: 0.5;
        }

        #ambient-canvas {
            position: absolute;
            inset: 0;
            z-index: 15;
            /* Behind characters */
            pointer-events: none;
            mix-blend-mode: screen;
        }

        /* Press Any Key Animation */
        #press-any-key {
            animation: pulse 1.5s infinite ease-in-out;
            text-shadow: 0 0 15px rgba(197, 160, 89, 0.5);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.3;
                transform: scale(0.98);
            }

            50% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Menu Stagger Animation */
        .menu-stagger {
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.6s cubic-bezier(0.2, 1, 0.3, 1) forwards;
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Music Player Modal */
        #music-player-modal .modal-popup {
            background: linear-gradient(180deg, #1a1a1a 0%, #0d0d0d 100%);
            border-color: var(--accent-gold);
        }

        .music-item {
            transition: all 0.2s ease;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .music-item:hover,
        .music-item.active {
            background: rgba(197, 160, 89, 0.1);
            color: var(--accent-gold);
        }

        .music-item.active::before {
            content: '♬';
            margin-right: 10px;
        }

        .progress-bar-container {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--accent-gold);
            border-radius: 3px;
            width: 0%;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- Ambient Layers -->
        <div class="ambient-pattern"></div>
        <div id="shapes-container" class="layer" style="z-index: 2; pointer-events: none;"></div>
        <canvas id="ambient-canvas"></canvas>

        <!-- disclaimer -->
        <div id="disclaimer-layer" class="layer" style="z-index: 1000; background: #000; display: none;">
            <div class="flex items-center justify-center h-full p-20 text-center">
                <p id="disclaimer-text" class="text-2xl leading-loose font-serif max-w-4xl"></p>
            </div>
        </div>

        <!-- bgcolor -->
        <div id="bgcolor-layer" class="layer" style="z-index: 0; background-color: #000000;"></div>

        <!-- onbgimage (multiple) -->
        <div id="bgimage-layer" class="layer" style="z-index: 10;"></div>

        <!-- LV 2: oncharacter -->
        <div id="character-layer" class="layer"
            style="z-index: 20; display: flex; align-items: flex-end; justify-content: center;">
        </div>

        <!-- LV 3: oncolor (below dialogue) -->
        <div id="oncolor-layer" class="layer" style="z-index: 70;"></div>

        <!-- LV 4: dialogue / onspeak -->
        <div id="dialogue-layer" class="layer layer-interactive" style="z-index: 400; display: none;">
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-[95%] max-w-[1200px] glass p-10 rounded-2xl border-l-[6px] border-primary-red shadow-2xl"
                id="dialogue-box">
                <div id="speaker-name"
                    class="text-2xl font-bold text-accent-gold mb-3 tracking-widest uppercase border-b border-accent-gold/20 pb-2 inline-block">
                </div>
                <div id="dialogue-text" class="text-xl leading-relaxed font-serif min-h-[100px] text-white/90"
                    style="word-break: keep-all; overflow-wrap: break-word;"></div>
            </div>
        </div>

        <!-- LV 5: onovercolor / offovercolor -->
        <div id="cover-overlay-layer" class="layer" style="z-index: 450;"></div>

        <!-- LV 5.5: onimage (Above dialogue) -->
        <div id="onimage-layer" class="layer" style="z-index: 500;"></div>

        <!-- LV 6: title / ontitle -->
        <div id="title-layer" class="layer" style="z-index: 600;"></div>

        <!-- LV 8: Main Menu Layer -->
        <div id="menu-layer" class="layer layer-interactive" style="z-index: 2000; background: #000; display: none;">
            <!-- Background Image Removed as requested -->

            <div class="relative z-10 flex flex-col items-center justify-center h-full pt-8">
                <!-- Title Group -->
                <div class="flex flex-col items-center mb-10 select-none">
                    <!-- English Title -->
                    <h1
                        class="text-5xl md:text-7xl font-cinzel text-accent-gold tracking-widest drop-shadow-[0_4px_10px_rgba(0,0,0,0.8)] mb-2">
                        The Legacy Of The Triple A
                    </h1>

                    <!-- Subtitle Group (Logo + Korean) -->
                    <div class="flex items-center justify-center space-x-4 -mt-2">
                        <img src="assets/images/title/Triple_A_Logo.png" class="w-24 md:w-32 logo-anim drop-shadow-lg"
                            alt="Logo">
                        <h2
                            class="text-4xl md:text-5xl font-['Nanum_Pen_Script'] text-white tracking-widest drop-shadow-md pt-4">
                            괴도 트리플 A의 유산
                        </h2>
                    </div>
                </div>

                <!-- Menu Buttons -->
                <div id="main-menu-list" class="flex flex-col space-y-2 w-full max-w-[420px] px-6 hidden">
                    <button data-menu="start"
                        class="menu-item premium-btn premium-btn-highlight py-4 md:py-5 rounded-2xl text-xl md:text-2xl font-bold tracking-[0.2em] text-white uppercase mb-1">게임
                        시작</button>
                    <button data-menu="options"
                        class="menu-item premium-btn py-3 md:py-4 rounded-xl text-lg md:text-xl text-white/90 font-medium">옵션</button>
                    <button data-menu="score"
                        class="menu-item premium-btn py-3 md:py-4 rounded-xl text-lg md:text-xl text-white/90 font-medium">스코어</button>
                    <button data-menu="music"
                        class="menu-item premium-btn py-3 md:py-4 rounded-xl text-lg md:text-xl text-white/90 font-medium">음악
                        감상</button>
                    <button data-menu="credits"
                        class="menu-item premium-btn py-3 md:py-4 rounded-xl text-lg md:text-xl text-white/90 font-medium">제작진</button>
                </div>

                <!-- Press Any Key -->
                <div id="press-any-key"
                    class="text-xl md:text-2xl text-accent-gold/80 tracking-[0.4em] uppercase font-cinzel mt-10 hidden">
                    - Press Any Key -
                </div>
            </div>
        </div>

        <!-- Music Player Modal -->
        <div id="music-player-modal"
            class="layer layer-interactive items-center justify-center bg-black/80 backdrop-blur-md hidden"
            style="z-index: 3000;">
            <div
                class="modal-popup glass rounded-3xl p-8 max-w-2xl w-full translate-y-0 opacity-100 transition-all duration-500">
                <div class="flex justify-between items-center mb-6 border-b border-accent-gold/20 pb-4">
                    <h2 class="text-3xl font-cinzel text-accent-gold tracking-widest">MUSIC PLAYER</h2>
                    <button onclick="Engine.closeMusicPlayer()"
                        class="text-white/50 hover:text-white transition-colors text-3xl font-light">&times;</button>
                </div>

                <div class="flex flex-col md:flex-row gap-8 min-h-[40vh] max-h-[55vh]">
                    <!-- Playlist -->
                    <div id="music-playlist"
                        class="flex-1 overflow-y-auto space-y-1 pr-2 custom-scrollbar bg-black/20 rounded-xl p-2">
                        <!-- Items injected by JS -->
                    </div>

                    <!-- Album Art & Info -->
                    <div class="w-full md:w-60 flex flex-col items-center justify-center space-y-6">
                        <div
                            class="w-44 h-44 rounded-3xl bg-gradient-to-br from-accent-gold/20 via-black to-accent-gold/5 border border-accent-gold/30 flex items-center justify-center shadow-[0_0_30px_rgba(197,160,89,0.15)] music-visualizer">
                            <span class="text-6xl text-accent-gold/40 drop-shadow-lg">♬</span>
                        </div>
                        <div class="text-center w-full">
                            <h3 id="current-music-title" class="text-xl font-bold text-white truncate px-2">-</h3>
                            <p class="text-sm text-white/50 tracking-widest uppercase mt-1">AAA Original Soundtrack</p>
                        </div>
                    </div>
                </div>

                <!-- Controls -->
                <div
                    class="mt-8 bg-gradient-to-r from-black/60 to-black/30 p-6 rounded-2xl border border-white/5 shadow-inner">
                    <div class="flex items-center justify-between mb-4 text-[10px] font-mono text-accent-gold/70 group">
                        <span id="music-time-current">00:00</span>
                        <div class="flex-1 mx-6 progress-bar-container group-hover:h-2" id="music-progress-container"
                            onclick="Engine.seekMusic(event)">
                            <div class="progress-bar-fill shadow-[0_0_10px_rgba(197,160,89,0.5)]"
                                id="music-progress-fill"></div>
                        </div>
                        <span id="music-time-total">00:00</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="w-24">
                            <button onclick="Engine.setMusicLoop()" id="music-loop-btn"
                                class="text-[10px] text-white/40 hover:text-accent-gold transition-all font-bold border border-white/10 px-3 py-1 rounded-full uppercase tracking-tighter">LOOP:
                                OFF</button>
                        </div>
                        <div class="flex items-center gap-6">
                            <button onclick="Engine.prevMusic()"
                                class="text-xl text-white/60 hover:text-accent-gold hover:scale-125 transition-all">⏮</button>
                            <button onclick="Engine.toggleMusicPlay()" id="music-play-btn"
                                class="w-14 h-14 rounded-full bg-accent-gold text-white text-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-[0_0_20px_rgba(197,160,89,0.4)]">▶</button>
                            <button onclick="Engine.nextMusic()"
                                class="text-xl text-white/60 hover:text-accent-gold hover:scale-125 transition-all">⏭</button>
                        </div>
                        <div class="w-24 flex justify-end">
                            <button onclick="Engine.stopMusicPlayerAudio()"
                                class="text-white/30 hover:text-primary-red transition-colors text-lg"
                                title="Stop">⏹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LV 7: interaction -->
        <div id="interaction-layer" class="layer layer-interactive" style="z-index: 1000;"></div>

        <!-- System UI (Always on top - LV 8) -->
        <div id="system-ui" class="absolute top-0 w-full p-3 md:p-6 flex justify-between items-center hidden"
            style="z-index: 2000;">
            <button onclick="Engine.toggleBacklog()"
                class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm tracking-widest uppercase text-white">Log</button>
            <div class="flex gap-2 md:gap-4">
                <button onclick="Engine.toggleAuto()" id="auto-btn"
                    class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm text-white">AUTO:
                    OFF</button>
                <button onclick="Engine.showSettings()"
                    class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm text-white">SETTING</button>
                <button onclick="Engine.toMenu()"
                    class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm text-white">EXIT</button>
            </div>
        </div>

        <!-- Modals -->
        <div id="options-modal"
            class="absolute inset-0 bg-black/60 backdrop-blur-md z-[2000] hidden flex items-center justify-center p-4">
            <div class="modal-popup glass rounded-[2rem] p-8 md:p-12">
                <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                    <h2 class="text-3xl md:text-4xl font-cinzel tracking-widest" id="options-header">OPTIONS</h2>
                    <button onclick="Engine.closeModal('options-modal')" class="text-3xl md:text-4xl">✕</button>
                </div>
                <div class="flex gap-6 md:gap-10 mb-10 border-b border-white/5 pb-2">
                    <button onclick="Engine.switchTab('sound')" id="tab-sound"
                        class="tab-btn text-xl md:text-2xl font-bold pb-2 active uppercase">Sound</button>
                    <button onclick="Engine.switchTab('display')" id="tab-display"
                        class="tab-btn text-xl md:text-2xl font-bold pb-2 uppercase">Display</button>
                </div>
                <div id="tab-content" class="flex-1 overflow-y-auto pr-4 custom-scrollbar">
                    <!-- Content injection -->
                </div>
            </div>
        </div>

        <div id="score-modal"
            class="absolute inset-0 bg-black/60 backdrop-blur-md z-[2000] hidden flex items-center justify-center p-4">
            <div class="modal-popup glass rounded-[2rem] p-8 md:p-12">
                <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                    <h2 class="text-3xl md:text-4xl font-cinzel tracking-widest" id="score-header">SCOREBOARD</h2>
                    <button onclick="Engine.closeModal('score-modal')" class="text-3xl md:text-4xl">✕</button>
                </div>
                <div id="score-summary"
                    class="grid grid-cols-2 gap-4 md:gap-10 mb-10 p-6 md:p-8 bg-white/5 rounded-3xl text-center">
                    <!-- Summary injection -->
                </div>
                <div id="score-list" class="flex-1 overflow-y-auto space-y-4 pr-4 custom-scrollbar">
                    <!-- List injection -->
                </div>
            </div>
        </div>

        <div id="credits-modal"
            class="absolute inset-0 bg-black/60 backdrop-blur-md z-[2000] hidden flex items-center justify-center p-4">
            <div class="modal-popup glass rounded-[2rem] p-12 text-center">
                <div class="w-full text-center space-y-8 md:space-y-12 overflow-y-auto custom-scrollbar">
                    <h2 class="text-4xl md:text-6xl font-cinzel text-accent-gold" id="credits-header">CREDITS</h2>
                    <div class="space-y-6 md:space-y-8 text-lg md:text-2xl leading-loose" id="credits-body">
                        <p><span class="opacity-50">Director</span><br><b>Joe</b></p>
                        <p><span class="opacity-50">Engine Development</span><br><b>Joe(With. Gemini)</b></p>
                        <p><span class="opacity-50">Scenario</span><br><b>Joe</b></p>
                        <p><span class="opacity-50">Design</span><br><b>Joe(With. Nano Banana)</b></p>
                        <p><span class="opacity-50">Sound</span><br><b>Joe(With. Suno)</b></p>
                        <p><span class="opacity-50">Globalization</span><br><b>Joe(With. Chat GPT)</b></p>
                        <p><span class="opacity-50">Donation</span><br><b>(기업) 040-086067-01-014</b></p>
                    </div>
                    <button onclick="Engine.closeModal('credits-modal')"
                        class="premium-btn px-12 md:px-20 py-4 rounded-xl text-xl mt-8">CLOSE</button>
                </div>
            </div>
        </div>

        <!-- Universal Confirm Modal -->
        <div id="universal-confirm"
            class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[2100] hidden flex items-center justify-center">
            <div class="glass p-12 rounded-3xl text-center space-y-10 max-w-2xl">
                <p id="confirm-msg" class="text-3xl leading-relaxed"></p>
                <div class="flex gap-6 justify-center">
                    <button id="confirm-yes"
                        class="premium-btn px-16 py-4 rounded-xl text-2xl bg-primary-red/20 border-primary-red uppercase">YES</button>
                    <button id="confirm-no" class="premium-btn px-16 py-4 rounded-xl text-2xl uppercase">NO</button>
                </div>
            </div>
        </div>

        <!-- Universal Alert Modal -->
        <div id="universal-alert"
            class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[2100] hidden flex items-center justify-center">
            <div class="glass p-12 rounded-3xl text-center space-y-10 max-w-xl">
                <p id="alert-msg" class="text-3xl leading-relaxed"></p>
                <div class="flex justify-center">
                    <button id="alert-ok"
                        class="premium-btn px-20 py-4 rounded-xl text-2xl bg-accent-gold/20 border-accent-gold text-accent-gold uppercase">OK</button>
                </div>
            </div>
        </div>

        <div id="backlog-modal" class="absolute inset-0 glass z-[2000] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest">LOG</h2>
                <button onclick="Engine.closeModal('backlog-modal')" class="text-4xl">✕</button>
            </div>
            <div id="backlog-content" class="flex-1 overflow-y-auto space-y-6 pr-4 font-serif text-xl leading-relaxed">
                <!-- Log injection -->
            </div>
        </div>

        <!-- Debug Overlay -->
        <div id="debug-overlay"
            class="absolute top-20 right-6 w-80 p-4 glass rounded-xl text-xs font-mono text-red-400 hidden"
            style="z-index: 1000;"></div>
    </div>

    <script>
        const State = {
            lang: 'KO',
            currentIndex: 0,
            eventHistory: [],
            audio: { bgm: null, amb: null, voice: null, sfx: null, masterMute: false },
            audioIntervals: {}, // KR: 타입별 페이드 인터벌 관리
            events: [],
            localization: {},
            backlog: [],
            characters: {},
            backgrounds: {},
            isChoiceActive: false,
            isQuizActive: false,
            isWaitActive: false, // Prevents skipping during Wait events
            isInteractionWaiting: false,
            currentEvent: null,
            settings: {
                difficulty: 'very-hard', // default: very-hard
                textSpeed: 30, // 10, 30, 100
                autoMode: false,
                opacity: 0.8,
                bgmVol: 0.5,
                sfxVol: 0.5,
                voiceVol: 0.8
            },
            currentVoice: null,
            stats: {
                hp: 100,
                keywords: [],
                startTime: null,
                totalTime: 0
            },
            menuIndex: 0,
            isNoteVisible: false,
            activeTimers: [],
            audioPlayTimeouts: {},
            pendingTitleBGM: false, // KR: 기본적으로 타이틀 BGM 재생 대기 상태로 시작 (DISCLAIMER 종료 후 활성화)
            isTitleStarted: false,
            musicList: [
                "01. 트리플 A(AAA).mp3",
                "02. 피곤한 오후(A tired afternoon).mp3",
                "03. 기이한 티 파티(Odd Tea Party).mp3",
                "04. 질문(question).mp3",
                "05. 진실을 찾아서(Seeking the truth).mp3",
                "06. 여정의 시작(The beginning of the journey).mp3",
                "07. 성의 주변길(Around the castle).mp3",
                "08. 계속되는 탐색(Continued exploration).mp3",
                "09. 가벼운 발걸음(light footsteps).mp3",
                "10. 가벼운 발걸음(light footsteps)_Ver.2.mp3",
                "11. 즐거운 스릴(A fun thrill).mp3",
                "12. 험난한 여정(A rough journey).mp3",
                "13. 방랑자(The wandering one).mp3",
                "14. 퀴즈(Quiz).mp3",
                "15. 긴장 속에서(In the midst of tension).mp3",
                "16. 긴장 속에서(In the midst of tension)_Ver.2.mp3",
                "17. 미궁(Dungeon).mp3",
                "18. 계단 아래로(under the stairs).mp3",
                "19. 계단 아래로(under the stairs)_Ver.2.mp3",
                "20. 질문을 품은 질의(The question begs the question).mp3",
                "21. 모험 속으로(Into the adventure).mp3",
                "22. 스릴러(thriller).mp3",
                "23. 거대한 의지(Great Will).mp3",
                "24. 모나리자(Mona Lisa).mp3",
                "25. 다음 이야기로(Next Step).mp3",
                "26. 다음 이야기로(Next Step)_Ver.2.mp3"
            ],
            currentMusicIndex: 0,
            musicLoopMode: 'none', // none, one, all
            isMusicPlaying: false
        };

        const Engine = {
            async init() {
                try {
                    // Set language from browser
                    const browserLang = navigator.language.slice(0, 2).toUpperCase();
                    const supported = ['KO', 'EN', 'JP', 'ES'];
                    const fullSupported = { 'zh-CN': 'CN_S', 'zh-TW': 'CN_T', 'zh-HK': 'CN_T' };

                    if (fullSupported[navigator.language]) State.lang = fullSupported[navigator.language];
                    else if (supported.includes(browserLang)) State.lang = browserLang;
                    else State.lang = 'KO';

                    // Use DataLoader to fetch data (Google Sheets or Local fallback)
                    const data = await DataLoader.loadData();
                    State.events = data.events;
                    State.localization = data.localization;

                    // Key listeners
                    window.addEventListener('keydown', (e) => this.handleKeyDown(e));

                    document.getElementById('game-container').addEventListener('mousedown', (e) => {
                        this.handleMouseDown(e);
                    });

                    this.initAmbient();

                    // KR: 타이틀 화면 상호작용 리스너 (Press Any Key 단계 처리)
                    const onTitleInput = (e) => {
                        if (document.getElementById('menu-layer').style.display !== 'none' && !State.isTitleStarted) {
                            this.handleTitleInteraction();
                        }
                    };
                    document.addEventListener('mousedown', onTitleInput);
                    document.addEventListener('keydown', onTitleInput);

                    this.showDisclaimer();

                } catch (e) {
                    this.debug(`Failed to load tables: ${e.message}`);
                }
            },

            initAmbient() {
                const canvas = document.getElementById('ambient-canvas');
                const ctx = canvas.getContext('2d');
                let w, h, particles = [];

                const resize = () => {
                    w = canvas.width = window.innerWidth;
                    h = canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', resize);
                resize();

                class Particle {
                    constructor() {
                        this.init();
                    }
                    init() {
                        this.x = Math.random() * w;
                        this.y = Math.random() * h;
                        this.size = Math.random() * 2 + 0.5;
                        this.speedX = Math.random() * 0.5 - 0.25;
                        this.speedY = Math.random() * 0.5 - 0.25;
                        this.opacity = Math.random() * 0.5;
                    }
                    update() {
                        this.x += this.speedX;
                        this.y += this.speedY;
                        if (this.x < 0 || this.x > w || this.y < 0 || this.y > h) this.init();
                    }
                    draw() {
                        ctx.fillStyle = `rgba(197, 160, 89, ${this.opacity})`;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                for (let i = 0; i < 50; i++) particles.push(new Particle());

                const animate = () => {
                    ctx.clearRect(0, 0, w, h);
                    particles.forEach(p => {
                        p.update();
                        p.draw();
                    });
                    requestAnimationFrame(animate);
                };
                animate();

                // Add geometric shapes
                const container = document.getElementById('shapes-container');
                for (let i = 0; i < 15; i++) {
                    const shape = document.createElement('div');
                    shape.className = 'floating-shape';
                    const size = Math.random() * 40 + 10;
                    shape.style.width = size + 'px';
                    shape.style.height = size + 'px';
                    shape.style.left = Math.random() * 100 + 'vw';
                    shape.style.top = '110vh';
                    shape.style.animationDelay = Math.random() * 20 + 's';
                    shape.style.clipPath = Math.random() > 0.5 ? 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)' : 'none';
                    container.appendChild(shape);
                }
            },

            showDisclaimer() {
                const layer = document.getElementById('disclaimer-layer');
                const text = document.getElementById('disclaimer-text');
                layer.style.display = 'block';
                text.innerHTML = this.formatText(this.t('DISCLAIMER'));
                text.classList.add('fade-in');

                setTimeout(() => {
                    text.classList.remove('fade-in');
                    text.classList.add('fade-out');
                    setTimeout(() => {
                        layer.classList.add('fade-out');
                        setTimeout(() => {
                            layer.style.display = 'none';
                            this.showTitle();
                        }, 1000);
                    }, 1000);
                }, 5000);
            },

            showTitle() {
                const menu = document.getElementById('menu-layer');
                if (!menu) return;
                menu.style.display = 'block';
                menu.classList.remove('fade-out');

                // KR: 초기 상태 - Press Any Key만 표시
                State.isTitleStarted = false;
                State.isInteractionWaiting = false;
                document.getElementById('main-menu-list').classList.add('hidden');

                const pak = document.getElementById('press-any-key');
                pak.innerText = this.t('PRESS_ANY_KEY');
                pak.classList.remove('hidden');

                State.pendingTitleBGM = true;
            },

            handleTitleInteraction() {
                if (State.isTitleStarted) return;
                State.isTitleStarted = true;

                // 1. 소리 재생
                this.playAudio('sfx', 'assets/audio/sfx/click.mp3');
                const bgmPath = 'assets/audio/bgm/25. 다음 이야기로(Next Step).mp3';
                this.playAudio('bgm', bgmPath, true);

                // 2. UI 전환
                document.getElementById('press-any-key').classList.add('hidden');
                const menuList = document.getElementById('main-menu-list');
                menuList.classList.remove('hidden');

                // 3. 버튼 순차 등장 애니메이션
                const buttons = menuList.querySelectorAll('.menu-item');
                buttons.forEach((btn, i) => {
                    btn.style.animationDelay = `${i * 0.1}s`;
                    btn.classList.add('menu-stagger');
                });

                this.updateTitleMenu();
            },

            updateTitleMenu() {
                const items = document.querySelectorAll('.menu-item');
                const keys = ['START_GAME', 'OPTIONS', 'SCORE', 'MUSIC_PLAYER', 'CREDITS'];

                items.forEach((item, i) => {
                    if (item) {
                        item.innerText = this.t(keys[i]);
                        item.classList.toggle('active', i === State.menuIndex);
                        item.classList.toggle('premium-btn-highlight', i === State.menuIndex && i === 0);

                        item.onclick = (e) => {
                            e.stopPropagation();
                            this.playAudio('sfx', 'assets/audio/sfx/click.mp3');
                            State.menuIndex = i;
                            this.executeMenuAction();
                        };
                        item.onmouseenter = () => {
                            if (State.isTitleStarted) {
                                State.menuIndex = i;
                                this.updateTitleMenu();
                            }
                        };
                    }
                });
            },

            handleKeyDown(e) {
                // Title Interaction (Press Any Key)
                if (document.getElementById('menu-layer').style.display !== 'none' && !State.isTitleStarted) {
                    this.handleTitleInteraction();
                    return;
                }

                // Menu Navigation (5 items now)
                if (document.getElementById('menu-layer').style.display !== 'none' && !State.isInteractionWaiting) {
                    if (e.code === 'ArrowDown' || e.code === 'KeyS') {
                        State.menuIndex = (State.menuIndex + 1) % 5;
                        this.updateTitleMenu();
                    } else if (e.code === 'ArrowUp' || e.code === 'KeyW') {
                        State.menuIndex = (State.menuIndex - 1 + 5) % 5;
                        this.updateTitleMenu();
                    } else if (e.code === 'Enter' || e.code === 'Space') {
                        this.executeMenuAction();
                    }
                    return;
                }

                // Global interaction
                if (e.code === 'Space' || e.code === 'Enter') {
                    if (State.isInteractionWaiting) this.handleGlobalInteraction();
                }
            },

            handleMouseDown(e) {
                // KR: 타이틀 메뉴가 활성화된 상태에서는 게임 내 클릭 상호작용(오디오 전환 등) 차단
                if (document.getElementById('menu-layer').style.display !== 'none') return;

                // Interaction Layer (Choices, Quiz) takes priority
                if (State.isInteractionWaiting) {
                    const cx = window.innerWidth / 2;
                    const cy = window.innerHeight / 2;
                    const dist = Math.sqrt((e.clientX - cx) ** 2 + (e.clientY - cy) ** 2);
                    if (dist < 200) { // Center click
                        this.handleGlobalInteraction();
                        return;
                    }
                }

                if (State.isInteractionWaiting) this.handleGlobalInteraction();
            },

            executeMenuAction() {
                this.playAudio('sfx', 'assets/audio/sfx/click.mp3');
                const actions = ['startGame', 'showOptions', 'showScore', 'showMusicPlayer', 'showCredits'];
                const action = actions[State.menuIndex];
                if (action && this[action]) this[action]();
            },

            startGame() {
                this.playAudio('sfx', 'assets/audio/sfx/click.mp3');
                this.clearAllTimers(); // KR: 시작 시 모든 예약된 오디오/타이머 정리
                const menu = document.getElementById('menu-layer');
                menu.classList.add('fade-out');
                State.stats.startTime = Date.now();
                // KR: 게임 시작 시 타이틀 BGM 정지
                this.stopAudio('bgm', 0.5);
                setTimeout(() => {
                    menu.style.display = 'none';
                    document.getElementById('system-ui').classList.remove('hidden');
                    this.executeEvent(State.events[0].Index);
                }, 1000);
            },

            // --- Music Player Logic ---
            showMusicPlayer() {
                const modal = document.getElementById('music-player-modal');
                modal.style.display = 'flex';
                modal.classList.remove('hidden');

                // 리스트 렌더링
                const playlist = document.getElementById('music-playlist');
                playlist.innerHTML = '';
                State.musicList.forEach((file, i) => {
                    const item = document.createElement('div');
                    item.className = `music-item p-3 rounded-lg flex items-center justify-between text-sm ${State.currentMusicIndex === i ? 'active' : ''}`;
                    // 파일명에서 확장자 및 번호 제거하여 깔끔하게 표시
                    const displayName = file.replace(/^\d+\.\s*/, '').replace(/\.mp3$/, '');
                    item.innerHTML = `<span>${displayName}</span><span class="opacity-30 text-[10px] uppercase font-mono">BGM</span>`;
                    item.onclick = () => this.playMusicItem(i);
                    playlist.appendChild(item);
                });

                this.updateMusicPlayerUI();
            },

            closeMusicPlayer() {
                const modal = document.getElementById('music-player-modal');
                modal.classList.add('hidden');
                modal.style.display = 'none';

                // 플레이어가 켜져있을 때 메인 메뉴 BGM이 꺼졌다면 다시 켜주기
                if (!State.isMusicPlaying && State.isTitleStarted) {
                    const bgmPath = 'assets/audio/bgm/25. 다음 이야기로(Next Step).mp3';
                    this.playAudio('bgm', bgmPath, true);
                }
            },

            playMusicItem(index) {
                State.currentMusicIndex = index;
                const file = State.musicList[index];
                const bgmPath = `assets/audio/bgm/${file}`;

                // 기존 BGM 중단
                this.stopAudio('bgm', 0);

                // 새 곡 재생
                this.playAudio('bgm', bgmPath, false); // 루프는 setMusicLoop에서 관리
                State.isMusicPlaying = true;

                // 폰 인터페이스 등 대응을 위한 전역 오디오 객체 이벤트 리스너 추가
                const aud = State.audio.bgm;
                if (aud) {
                    aud.onended = () => this.handleMusicEnded();
                    aud.ontimeupdate = () => this.updateMusicProgress();
                }

                this.showMusicPlayer(); // 리스트 갱신
            },

            handleMusicEnded() {
                if (State.musicLoopMode === 'one') {
                    this.playMusicItem(State.currentMusicIndex);
                } else if (State.musicLoopMode === 'all') {
                    this.nextMusic();
                } else {
                    State.isMusicPlaying = false;
                    this.updateMusicPlayerUI();
                }
            },

            toggleMusicPlay() {
                const aud = State.audio.bgm;
                if (!aud) {
                    this.playMusicItem(State.currentMusicIndex);
                    return;
                }

                if (aud.paused) {
                    aud.play();
                    State.isMusicPlaying = true;
                } else {
                    aud.pause();
                    State.isMusicPlaying = false;
                }
                this.updateMusicPlayerUI();
            },

            nextMusic() {
                let next = (State.currentMusicIndex + 1) % State.musicList.length;
                this.playMusicItem(next);
            },

            prevMusic() {
                let prev = (State.currentMusicIndex - 1 + State.musicList.length) % State.musicList.length;
                this.playMusicItem(prev);
            },

            setMusicLoop() {
                const modes = ['none', 'one', 'all'];
                let idx = (modes.indexOf(State.musicLoopMode) + 1) % modes.length;
                State.musicLoopMode = modes[idx];

                const btn = document.getElementById('music-loop-btn');
                btn.innerText = `LOOP: ${State.musicLoopMode.toUpperCase()}`;
                btn.classList.toggle('text-accent-gold', State.musicLoopMode !== 'none');
            },

            seekMusic(e) {
                const aud = State.audio.bgm;
                if (!aud || isNaN(aud.duration)) return;
                const container = document.getElementById('music-progress-container');
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const pct = Math.max(0, Math.min(1, x / rect.width));
                aud.currentTime = pct * aud.duration;
                this.updateMusicProgress();
                if (!State.isMusicPlaying) {
                    this.toggleMusicPlay();
                }
            },

            updateMusicProgress() {
                const aud = State.audio.bgm;
                if (!aud || !State.isMusicPlaying) return;

                const progress = (aud.currentTime / aud.duration) * 100;
                document.getElementById('music-progress-fill').style.width = `${progress}%`;

                const format = (s) => {
                    const m = Math.floor(s / 60);
                    const sec = Math.floor(s % 60);
                    return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                };

                document.getElementById('music-time-current').innerText = format(aud.currentTime);
                if (!isNaN(aud.duration)) {
                    document.getElementById('music-time-total').innerText = format(aud.duration);
                }
            },

            updateMusicPlayerUI() {
                const playBtn = document.getElementById('music-play-btn');
                if (playBtn) playBtn.innerText = State.isMusicPlaying ? 'Ⅱ' : '▶'; // 폰트 아이콘 대신 텍스트

                const title = document.getElementById('current-music-title');
                const currentFile = State.musicList[State.currentMusicIndex];
                title.innerText = currentFile ? currentFile.replace(/^\d+\.\s*/, '').replace(/\.mp3$/, '') : '-';
            },

            stopMusicPlayerAudio() {
                this.stopAudio('bgm', 0.5);
                State.isMusicPlaying = false;
                this.updateMusicPlayerUI();
                document.getElementById('music-progress-fill').style.width = '0%';
            },

            t(key) {
                if (!key) return '';
                if (typeof key !== 'string') return JSON.stringify(key);

                // --- 난이도 및 신규 기능 로컬라이제이션 폴백 ---
                const localFallbacks = {
                    'DIFFICULTY_LEVEL': { 'KO': '난이도', 'EN': 'Difficulty Level' },
                    'DIFF_VERY_HARD': { 'KO': '매우 어려움 (힌트 불가)', 'EN': 'Very Hard (No Hints)' },
                    'DIFF_HARD': { 'KO': '어려움 (힌트1 가능)', 'EN': 'Hard (Hint 1)' },
                    'DIFF_NORMAL': { 'KO': '보통 (힌트1,2 가능)', 'EN': 'Normal (Hint 1,2)' },
                    'DIFF_EASY': { 'KO': '쉬움 (모두 가능)', 'EN': 'Easy (All Hints)' },
                    'HINT_NOT_AVAILABLE': { 'KO': '현재 난이도에서는 힌트를 볼 수 없습니다.', 'EN': 'Hints are not available at the current difficulty.' },
                    'MUSIC_PLAYER': { 'KO': '음악 감상', 'EN': 'Music Player' }
                };

                if (localFallbacks[key]) {
                    let text = localFallbacks[key][State.lang] || localFallbacks[key]['KO'] || key;
                    if (key === 'HINT_NOT_AVAILABLE') {
                        // KR: Diff key mismatch fix (very-hard -> VERY_HARD)
                        const diffKey = `DIFF_${State.settings.difficulty.toUpperCase().replace('-', '_')}`;
                        const diffName = this.t(diffKey).split('(')[0].trim(); // "매우 어려움 (힌트 불가)" -> "매우 어려움"
                        text = text.replace('현재 난이도', diffName);
                    }
                    return text;
                }

                if (State.localization[key]) {
                    const entry = State.localization[key];
                    return entry[State.lang] || entry['KO'] || entry['EN'] || key;
                }
                return key;
            },

            formatText(str) {
                if (!str) return '';
                let formatted = str.replace(/\/n|\\n/g, '<br>');
                // 색상 태그 처리: [#RRGGBB][텍스트][-] 또는 [RRGGBB][텍스트][-] 형식
                formatted = formatted.replace(/\[(#?[A-Za-z0-9]+)\](.*?)\[-\]/g, (match, p1, p2) => {
                    // #이 이미 포함되어 있으면 그대로 사용, 6자리 hex면 # 추가
                    let color = p1;
                    if (p1.startsWith('#')) {
                        color = p1; // #ff0000 형식
                    } else if (/^[0-9A-Fa-f]{6}$/.test(p1)) {
                        color = `#${p1}`; // ff0000 형식 -> #ff0000
                    }
                    // 그 외는 색상 이름으로 간주 (red, blue 등)
                    return `<span style="color: ${color}">${p2}</span>`;
                });
                return formatted;
            },

            async executeEvent(index) {
                const event = State.events.find(e => e.Index === index);
                if (!event) {
                    this.debug(`Index ${index} not found`);
                    return;
                }
                const currentRelIdx = State.events.indexOf(event);
                State.currentIndex = currentRelIdx;

                const type = (event.type || '').toLowerCase();
                this.debug(`Execute Event [${index}]: ${type}`);

                switch (type) {
                    case 'bgcolor':
                        const bgLayer = document.getElementById('bgcolor-layer');
                        bgLayer.style.transition = `background-color ${event.Value02 || 0}s`;
                        bgLayer.style.backgroundColor = event.Value01 || '#000000';
                        this.next(event.Index, 'Read');
                        break;

                    case 'onbgimage':
                        this.handleBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgimage':
                        this.handleOffBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'oncharacter':
                        this.handleCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcharacter':
                        this.handleOffCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onspeak':
                        this.handleOnSpeak(event);
                        break;

                    case 'offspeak':
                        this.handleOffSpeak(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'oncolor':
                        this.handleOverlayColor(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcolor':
                        this.handleOverlayColor(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onimage':
                        this.handleOverlayImage(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offimage':
                        this.handleOverlayImage(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onovercolor':
                        this.handleCoverOverlayColor(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offovercolor':
                        this.handleCoverOverlayColor(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'title':
                        this.handleTitle(event);
                        break;

                    case 'ontitle':
                        this.handleTitle(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offtitle':
                        document.getElementById('title-layer').innerHTML = '';
                        this.next(event.Index, 'Read');
                        break;

                    case 'choice':
                        this.forceAutoOff();
                        this.handleChoice(event);
                        break;

                    case 'quiz01':
                        this.forceAutoOff();
                        this.handleQuiz(event);
                        break;

                    case 'onbgm':
                        this.playAudio('bgm', event.Value01, event.Value02 === 'loop', event.Value03);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgm':
                        this.stopAudio('bgm', event.Value01);
                        this.next(event.Index, 'Read');
                        break;

                    case 'jump':
                        this.executeEvent(parseInt(event.Value01));
                        break;

                    case 'onamb':
                        this.playAudio('amb', event.Value01, true, event.Value03); // AMB는 기본적으로 반복
                        this.next(event.Index, 'Read');
                        break;

                    case 'offamb':
                        this.stopAudio('amb', event.Value01);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onsfx':
                    case 'sfx': // 'sfx'는 'onsfx'의 별칭으로 사용
                        this.playAudio('sfx', event.Value01, false, event.Value03);
                        this.next(event.Index, 'Read');
                        break;

                    case 'wait':
                        State.isWaitActive = true;
                        const waitSec = parseFloat(event.Value01 || 0);
                        this.debug(`Wait Start: ${waitSec}s`);
                        this.setSafeTimeout(() => {
                            State.isWaitActive = false;
                            this.debug(`Wait End: Proceeding to next.`);
                            this.next(event.Index, 'Read');
                        }, waitSec * 1000);
                        break;

                    case 'anieffect':
                        this.handleAniEffect(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'move':
                        this.handleMove(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'editcharacter':
                        this.handleEditCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'transform':
                        this.handleTransform(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'gifeffect':
                        this.handleGifEffect(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'next':
                        this.initNextChapter(event.Value01);
                        break;

                    case 'end':
                        this.showAlert(this.t('END_OF_CHAPTER'), () => location.reload());
                        break;

                    case 'goodend':
                        this.handleGoodEnd(event);
                        break;

                    default:
                        this.debug(`Unknown type: ${event.type}`);
                        this.next(event.Index, 'Read');
                }
            },

            next(index, mode) {
                if (mode === 'Read') {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) {
                        this.executeEvent(State.events[nextRelIdx].Index);
                    }
                }
            },

            // --- Handlers ---
            handleBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const img = document.createElement('img');
                img.src = data.Value01;
                img.className = `layer object-cover w-full h-full fade-in`;
                img.style.setProperty('--duration', `${data.Value03 || 0}s`);
                img.dataset.num = data.Value04 || 1;

                layer.appendChild(img);
                // KR: 레이어 순서 수정 (오름차순: 숫자가 클수록 위로 올라옴)
                const sorted = [...layer.querySelectorAll('img')].sort((a, b) => a.dataset.num - b.dataset.num);
                layer.innerHTML = '';
                sorted.forEach(el => layer.appendChild(el));
            },

            handleOffBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const target = layer.querySelector(`img[data-num="${data.Value01}"]`);
                if (target) {
                    target.classList.remove('fade-in'); // KR: 사라질 때 기존 fade-in 제거
                    target.classList.add('fade-out');
                    setTimeout(() => target.remove(), (data.Value03 || 0.5) * 1000);
                }
            },

            handleCharacter(data) {
                const layer = document.getElementById('character-layer');
                const charId = String(data.Value01).toLowerCase();
                let char = State.characters[charId];
                if (!char) {
                    const container = document.createElement('div');
                    container.className = 'char-container';

                    // Wrapper for effects (shake etc) to avoid conflict with positioning
                    const wrapper = document.createElement('div');
                    wrapper.className = 'char-effect-wrap';
                    wrapper.style.width = '100%';
                    wrapper.style.height = '100%';
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'flex-end';
                    wrapper.style.justifyContent = 'center';

                    const el = document.createElement('img');
                    el.className = 'char-obj';
                    // el.style.opacity = 0; // KR: opacity 0 제거 (container의 fade-in 클래스가 처리)

                    wrapper.appendChild(el);
                    container.appendChild(wrapper);
                    layer.appendChild(container);

                    State.characters[charId] = {
                        el: container,
                        wrapper: wrapper,
                        img: el,
                        id: charId,
                        name: data.Value01 // KR: Value01을 캐릭터 이름으로 선언
                    };
                }
                char = State.characters[charId];
                char.name = data.Value01; // KR: 상시 업데이트

                // KR: Value02가 파일명인 경우 해당 파일을 직접 매칭
                const imgPath = data.Value02 ?
                    `assets/images/character/${data.Value02}.png` :
                    `assets/images/character/${data.Value01}.png`;

                char.img.src = imgPath;

                // X좌표 설정 (반응형 대응)
                let pos = data.Value03 || '50%';
                // Normalize keywords to percentages
                if (pos === 'center') pos = '50%';
                if (pos === 'left') pos = '15%'; // More strict on mobile
                if (pos === 'right') pos = '85%';

                // PC override for wider spacing if needed, but percentages work well generally
                if (window.innerWidth > 768) {
                    if (pos === '15%') pos = '20%';
                    if (pos === '85%') pos = '80%';
                }

                char.el.style.left = pos;

                if (data.Value04 === 'fadein') {
                    char.el.classList.add('fade-in');
                    char.el.style.setProperty('--duration', `${data.Value05 || 1}s`);
                }
            },
            handleOffCharacter(data) {
                const charId = String(data.Value01).toLowerCase();
                const char = State.characters[charId];
                if (char) {
                    this.debug(`Off-Character: ${charId}`);
                    const duration = parseFloat(data.Value05 || 0.5);
                    char.el.style.setProperty('--duration', `${duration}s`);
                    char.el.classList.remove('fade-in');
                    char.el.classList.add('fade-out');
                    this.setSafeTimeout(() => {
                        if (char.el.parentNode) char.el.remove();
                        delete State.characters[charId];
                    }, duration * 1000);
                } else {
                    this.debug(`Off-Character failed: ${charId} not found.`);
                }
            },

            handleOnSpeak(data) {
                const layer = document.getElementById('dialogue-layer');
                const speaker = document.getElementById('speaker-name');
                const text = document.getElementById('dialogue-text');
                const box = document.getElementById('dialogue-box');

                layer.style.display = 'block';
                layer.classList.remove('fade-out');
                layer.style.opacity = '1';

                const nameStr = this.t(data.Value02);
                speaker.innerText = nameStr;

                // Highlight character (CSS 변수 활용하여 기존 변환 상태 유지)
                Object.values(State.characters).forEach(c => {
                    if (c.id === data.Value01) {
                        c.el.style.setProperty('--char-scale', '1.05'); // Active speaker slight zoom
                        c.el.style.setProperty('--char-y-offset', '0%');
                        c.el.style.filter = 'brightness(1.1) drop-shadow(0 0 30px rgba(197, 160, 89, 0.4))';
                        c.el.style.zIndex = '30';
                    } else {
                        c.el.style.setProperty('--char-scale', '0.95');
                        c.el.style.setProperty('--char-y-offset', '2%'); // Inactive slightly down
                        c.el.style.filter = 'brightness(0.5) constrast(1.2)';
                        c.el.style.zIndex = '20';
                    }
                });

                const content = this.t(data.Value03);
                State.backlog.push({ name: nameStr, text: content });

                const dialogueTextEl = document.getElementById('dialogue-text');
                if (data.Value04) {
                    dialogueTextEl.style.color = data.Value04; // Value04: 대사 본문 색상
                } else {
                    dialogueTextEl.style.color = '#fff';
                }

                this.typeText(text, content, () => {
                    if (State.settings.autoMode) {
                        const autoWait = 1000 + (content.length * 50);
                        this.setSafeTimeout(() => {
                            if (State.settings.autoMode && !State.isTextAnimating) this.next(data.Index, 'Read');
                        }, autoWait);
                    }
                });

                if (data.Value05) {
                    this.playAudio('voice', data.Value05); // Value05: 보이스 경로
                }

                State.isInteractionWaiting = true;
                State.currentEvent = data;
            },

            handleOffSpeak(data) {
                const layer = document.getElementById('dialogue-layer');
                const duration = data.Value01 || 0.5;
                layer.style.setProperty('--duration', `${duration}s`);
                layer.classList.add('fade-out');
                setTimeout(() => {
                    layer.style.display = 'none';
                    layer.classList.remove('fade-out');
                }, duration * 1000);
            },

            handleGlobalInteraction() {
                if (State.isWaitActive) return; // Block skip during Wait
                if (State.isTextAnimating) {
                    State.isTextAnimating = false;
                } else if (State.isInteractionWaiting) {
                    State.isInteractionWaiting = false;
                    this.next(State.currentEvent.Index, 'Read');
                }
            },

            typeText(el, str, cb) {
                el.innerHTML = '';
                el.classList.remove('cursor-blink');
                State.isTextAnimating = true;

                let formatted = this.formatText(str);

                // 모든 일반 텍스트 문자를 개별 스판으로 래핑하여 초기에는 숨김 처리
                const temp = document.createElement('div');
                temp.innerHTML = formatted;

                const wrapLetters = (node) => {
                    if (node.nodeType === 3) {
                        const text = node.textContent;
                        const fragment = document.createDocumentFragment();
                        for (let char of text) {
                            const span = document.createElement('span');
                            span.style.opacity = '0';
                            span.style.transition = 'opacity 0.1s';
                            span.className = 'typing-char';
                            span.textContent = char;
                            fragment.appendChild(span);
                        }
                        node.parentNode.replaceChild(fragment, node);
                    } else if (node.nodeType === 1) {
                        Array.from(node.childNodes).forEach(wrapLetters);
                    }
                };
                wrapLetters(temp);
                el.innerHTML = temp.innerHTML;

                const chars = el.querySelectorAll('.typing-char');
                let i = 0;
                const speeds = { slow: 100, normal: 30, fast: 10 };
                const speed = speeds[State.settings.textSpeed] || 30;

                const timer = setInterval(() => {
                    if (!State.isTextAnimating) {
                        chars.forEach(c => c.style.opacity = '1');
                        clearInterval(timer);
                        el.classList.add('cursor-blink');
                        cb();
                        return;
                    }

                    if (i < chars.length) {
                        chars[i++].style.opacity = '1';
                    } else {
                        clearInterval(timer);
                        State.isTextAnimating = false;
                        el.classList.add('cursor-blink');
                        cb();
                    }
                }, speed);
            },

            handleOverlayColor(data, on) {
                const layer = document.getElementById('oncolor-layer');
                if (on) {
                    this.debug(`On-Color: ${data.Value01}`);
                    layer.style.pointerEvents = 'auto';
                    const el = document.createElement('div');
                    el.className = 'layer fade-in';
                    el.style.backgroundColor = data.Value01;
                    const opacityStr = String(data.Value03 || '100%');
                    el.style.opacity = opacityStr.includes('%') ? parseInt(opacityStr) / 100 : opacityStr;
                    el.style.setProperty('--duration', `${data.Value02 || 0.5}s`);
                    layer.appendChild(el);
                } else {
                    this.debug(`Off-Color`);
                    const duration = parseFloat(data.Value01 || 0.5);
                    const children = Array.from(layer.children);
                    if (children.length > 0) {
                        children.forEach(el => {
                            el.style.setProperty('--duration', `${duration}s`);
                            el.classList.remove('fade-in');
                            el.classList.add('fade-out');
                        });
                        this.setSafeTimeout(() => {
                            layer.innerHTML = '';
                            layer.style.pointerEvents = 'none';
                        }, duration * 1000);
                    } else {
                        layer.innerHTML = '';
                        layer.style.pointerEvents = 'none';
                    }
                }
            },

            handleOverlayImage(data, on) {
                const layer = document.getElementById('onimage-layer');
                if (!on) {
                    const children = Array.from(layer.children);
                    if (children.length > 0) {
                        children.forEach(el => {
                            el.style.setProperty('--duration', '2s');
                            el.classList.remove('fade-in');
                            el.classList.add('fade-out');
                        });
                        setTimeout(() => layer.innerHTML = '', 2000);
                    } else {
                        layer.innerHTML = '';
                    }
                    return;
                }

                const el = document.createElement('img');
                el.src = data.Value01;
                // KR: Value03은 좌표로 변경됨에 따라 지속 시간은 Value04로 상속
                const duration = data.Value04 || 1;
                el.style.setProperty('--duration', `${duration}s`);
                el.className = 'absolute pointer-events-none fade-in';

                // 1. Size (Value02)
                if (data.Value02) {
                    const sizeParts = String(data.Value02).split(/[,xX*]/).map(p => p.trim());
                    if (sizeParts.length >= 1) {
                        el.style.width = isNaN(sizeParts[0]) ? sizeParts[0] : sizeParts[0] + 'px';
                        if (sizeParts.length >= 2) el.style.height = isNaN(sizeParts[1]) ? sizeParts[1] : sizeParts[1] + 'px';
                        else el.style.height = 'auto';
                    }
                    el.classList.remove('w-full', 'h-full', 'object-contain');
                } else {
                    el.classList.add('inset-0', 'w-full', 'h-full', 'object-contain');
                }

                // 2. Position (Value03)
                const posStr = String(data.Value03 || '');
                if (posStr.includes(',')) {
                    const posParts = posStr.replace(/[() ]/g, '').split(',').map(p => p.trim());
                    if (posParts.length === 2 && posParts[0] !== '' && posParts[1] !== '') {
                        el.style.left = isNaN(posParts[0]) ? posParts[0] : posParts[0] + 'px';
                        el.style.top = isNaN(posParts[1]) ? posParts[1] : posParts[1] + 'px';
                    } else {
                        applyCenter();
                    }
                } else {
                    applyCenter();
                }

                function applyCenter() {
                    if (data.Value02) {
                        el.classList.add('left-1/2', 'top-1/2', '-translate-x-1/2', '-translate-y-1/2');
                    }
                }

                layer.appendChild(el);
            },

            handleCoverOverlayColor(data, on) {
                const layer = document.getElementById('cover-overlay-layer');
                if (on) {
                    this.debug(`On-CoverColor: ${data.Value01}`);
                    layer.style.pointerEvents = 'auto';
                    const el = document.createElement('div');
                    el.className = 'layer fade-in';
                    el.style.backgroundColor = data.Value01;
                    const opacityStr = String(data.Value03 || '100%');
                    el.style.opacity = opacityStr.includes('%') ? parseInt(opacityStr) / 100 : opacityStr;
                    el.style.setProperty('--duration', `${data.Value02 || 0.5}s`);
                    layer.appendChild(el);
                } else {
                    this.debug(`Off-CoverColor`);
                    const duration = parseFloat(data.Value01 || 0.5);
                    const children = Array.from(layer.children);
                    if (children.length > 0) {
                        children.forEach(el => {
                            el.style.setProperty('--duration', `${duration}s`);
                            el.classList.remove('fade-in');
                            el.classList.add('fade-out');
                        });
                        this.setSafeTimeout(() => {
                            layer.innerHTML = '';
                            layer.style.pointerEvents = 'none';
                        }, duration * 1000);
                    } else {
                        layer.innerHTML = '';
                        layer.style.pointerEvents = 'none';
                    }
                }
            },

            handleTitle(data, keep = false) {
                const layer = document.getElementById('title-layer');
                layer.innerHTML = ''; // Fix stacking

                const el = document.createElement('div');
                el.className = 'absolute inset-0 flex items-center justify-center text-center p-6 md:p-20 z-10 pointer-events-none';

                const inner = document.createElement('div');
                inner.className = 'w-full max-w-[90vw]';
                inner.style.whiteSpace = 'pre-wrap';
                inner.style.wordBreak = 'keep-all';
                inner.style.overflowWrap = 'break-word';
                inner.style.fontFamily = data.Value01 || 'Cinzel, serif';
                inner.style.color = data.Value03 || '#fff';

                // Responsive font sizing
                const baseSize = data.Value02 || 48;
                if (window.innerWidth < 1080) {
                    inner.style.fontSize = `clamp(1.1rem, ${(baseSize * 0.6) / 10.8}vw, 3.5rem)`;
                } else {
                    inner.style.fontSize = `clamp(1.5rem, ${baseSize / 19.2}vw, 8rem)`;
                }

                el.appendChild(inner);
                layer.appendChild(el);

                const titleText = this.formatText(this.t(data.Value04));
                // Log title
                State.backlog.push({ name: 'TITLE', text: titleText });

                this.typeText(inner, titleText, () => {
                    if (!keep) {
                        State.isInteractionWaiting = true;
                        State.currentEvent = data;

                        if (State.settings.autoMode) {
                            const autoWait = 2000;
                            this.setSafeTimeout(() => {
                                if (State.settings.autoMode && State.isInteractionWaiting && State.currentEvent === data) {
                                    this.handleGlobalInteraction();
                                }
                            }, autoWait);
                        }
                    }
                });
            },

            handleChoice(data) {
                // Force Auto-off and block it
                State.settings.autoMode = false;
                State.isChoiceActive = true;
                document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                const layer = document.getElementById('interaction-layer');
                const container = document.createElement('div');
                container.className = 'flex flex-col gap-6 items-center justify-center h-full bg-black/40';

                const choices = [];
                choices.push({ text: this.t(data.Value01), target: data.Value02 });
                if (data.Value03) choices.push({ text: this.t(data.Value03), target: data.Value04 });

                const addBtn = (choice, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'premium-btn glass px-12 py-6 md:px-20 md:py-8 rounded-2xl text-xl md:text-2xl w-[90%] max-w-[600px] text-white transition-all';
                    // KR: 선택지 텍스트도 포맷팅(색상, 줄바꿈 등) 적용
                    btn.innerHTML = this.formatText(choice.text);
                    btn.onclick = () => {
                        State.isChoiceActive = false; // Reset flag

                        // Record to backlog with selection info
                        State.backlog.push({
                            type: 'choice',
                            choices: choices.map(c => c.text),
                            selectedIndex: idx
                        });

                        layer.innerHTML = '';
                        this.executeEvent(choice.target);
                    };
                    container.appendChild(btn);
                };

                choices.forEach((c, idx) => addBtn(c, idx));
                layer.appendChild(container);
            },

            handleQuiz(data) {
                // Force Auto-off and block it
                State.settings.autoMode = false;
                State.isQuizActive = true;

                // Log Quiz
                const qText = this.t(data.Value01);
                State.backlog.push({ name: 'QUIZ', text: qText });

                document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                const layer = document.getElementById('interaction-layer');
                layer.innerHTML = '';
                const quizBox = document.createElement('div');
                quizBox.className = 'absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4';
                quizBox.innerHTML = `
                    <div class="glass p-8 md:p-12 rounded-[2rem] md:rounded-[3rem] w-full max-w-[800px] text-center">
                        <div class="text-xs md:text-xl opacity-60 mb-6 border-b border-white/10 pb-4 tracking-[0.3em] md:tracking-[0.5em]">QUERY NODE</div>
                        <div class="text-xl md:text-3xl mb-8 md:mb-12 font-serif px-2">${this.formatText(this.t(data.Value01))}</div>
                        <input id="quiz-input" autocomplete="off" class="w-full bg-white/5 border border-white/20 p-5 md:p-6 rounded-xl text-xl md:text-3xl mb-6 focus:border-accent-gold outline-none text-center" placeholder="...">
                        <div class="flex gap-2 md:gap-4 mb-6 md:mb-8">
                            <button id="hint-1" class="premium-btn p-3 md:p-4 rounded-xl flex-1 text-[10px] md:text-xs text-white">HINT 1</button>
                            ${data.Value04 ? `<button id="hint-2" class="premium-btn p-3 md:p-4 rounded-xl flex-1 text-[10px] md:text-xs text-white">HINT 2</button>` : ''}
                            ${data.Value05 ? `<button id="hint-3" class="premium-btn p-3 md:p-4 rounded-xl flex-1 text-[10px] md:text-xs text-white">HINT 3</button>` : ''}
                        </div>
                        <button id="quiz-submit" class="premium-btn w-full p-4 md:p-6 rounded-xl text-lg md:text-2xl bg-primary-red/20 border-primary-red text-white">EXECUTE</button>
                    </div>
                `;
                layer.appendChild(quizBox);

                const input = quizBox.querySelector('#quiz-input');
                input.focus();

                const answers = Array.isArray(data.Value02) ? data.Value02 : [data.Value02];

                const check = () => {
                    const val = input.value.toLowerCase().replace(/\s/g, '');
                    const isCorrect = answers.some(a => String(a).toLowerCase().replace(/\s/g, '') === val);
                    if (isCorrect) {
                        State.isQuizActive = false; // Reset flag
                        layer.innerHTML = '';
                        this.next(data.Index, 'Read');
                    } else {
                        quizBox.querySelector('.glass').classList.add('shake');
                        setTimeout(() => quizBox.querySelector('.glass').classList.remove('shake'), 500);
                        input.value = '';
                    }
                };

                quizBox.querySelector('#quiz-submit').onclick = check;
                input.onkeydown = (e) => { if (e.key === 'Enter') check(); };

                const showHint = (hintKey) => {
                    // Difficulty Check
                    const diff = State.settings.difficulty;
                    let isAllowed = false;

                    if (diff === 'easy') isAllowed = true;
                    else if (diff === 'normal' && (hintKey === 'Value03' || hintKey === 'Value04')) isAllowed = true;
                    else if (diff === 'hard' && hintKey === 'Value03') isAllowed = true;

                    if (!isAllowed) {
                        this.showAlert(this.t('HINT_NOT_AVAILABLE'));
                        return;
                    }

                    const hintTxt = this.t(data[hintKey]);
                    if (!hintTxt) return;

                    let note = document.getElementById('hint-note');
                    if (!note) {
                        note = document.createElement('div');
                        note.id = 'hint-note';
                        note.className = 'note-popup fade-in';
                        layer.appendChild(note);
                    }
                    note.style.left = '50%';
                    note.style.top = '30%';
                    note.style.transform = 'translate(-50%, -50%) rotate(-2deg)';
                    note.innerText = hintTxt;
                    note.onclick = () => note.remove();
                };

                quizBox.querySelector('#hint-1').onclick = () => showHint('Value03');
                if (data.Value04) quizBox.querySelector('#hint-2').onclick = () => showHint('Value04');
                if (data.Value05) quizBox.querySelector('#hint-3').onclick = () => showHint('Value05');
            },

            handleAniEffect(data) {
                // 특정 캐릭터 래퍼(wrapper) 또는 전체 컨테이너에 효과 적용
                const target = data.Value01 === 'all' ?
                    document.getElementById('game-container') :
                    State.characters[data.Value01]?.wrapper; // 래퍼에 적용하여 위치(container)와 분리

                if (target) {
                    target.classList.add(data.Value02);
                    setTimeout(() => target.classList.remove(data.Value02), (data.Value03 || 1) * 1000);
                }
            },

            handleMove(data) {
                const char = State.characters[data.Value01];
                if (!char) return;

                let pos = data.Value02 || '50%';
                if (pos === 'center') pos = '50%';
                else if (pos === 'left') pos = '20%';
                else if (pos === 'right') pos = '80%';

                const duration = parseFloat(data.Value03 || 1);

                // wrapper 이동
                if (char.wrapper) {
                    char.wrapper.style.transition = `left ${duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
                    char.wrapper.style.left = pos;
                } else if (char.div) {
                    // Fallback if wrapper property name differs (initially it was div)
                    char.div.style.transition = `left ${duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
                    char.div.style.left = pos;
                }
            },

            handleEditCharacter(data) {
                const charId = String(data.Value01).toLowerCase();
                // KR: Value02가 이미지 파일명인 경우 경로 및 확장자 조합
                const exprName = data.Value02;
                const newExpr = exprName ? `assets/images/character/${exprName}.png` : null;
                const color = data.Value03; // Hex color for overlay
                const duration = parseFloat(data.Value04 || 0);

                if (!charId || !State.characters[charId]) return;

                const charObj = State.characters[charId];
                const imgEl = charObj.img;
                const wrapperEl = charObj.wrapper || charObj.div;

                // 1. Change Expression (Image)
                if (newExpr) {
                    if (duration > 0) {
                        imgEl.style.transition = `opacity ${duration}s`;
                        const tempImg = new Image();
                        tempImg.src = newExpr;
                        tempImg.onload = () => {
                            imgEl.style.opacity = 0;
                            setTimeout(() => {
                                imgEl.src = newExpr;
                                imgEl.style.opacity = 1;
                            }, duration * 1000);
                        };
                    } else {
                        imgEl.src = newExpr;
                    }
                }

                // 2. Color Overlay
                if (color) {
                    let existingOverlay = wrapperEl.querySelector('.char-overlay');
                    if (existingOverlay) existingOverlay.remove();

                    const overlay = document.createElement('div');
                    overlay.className = 'char-overlay absolute inset-0 pointer-events-none';
                    overlay.style.backgroundColor = color;
                    overlay.style.transition = `opacity ${duration}s ease`;
                    overlay.style.opacity = 0;

                    const maskRule = `url("${imgEl.src}") no-repeat bottom center / contain`;
                    overlay.style.webkitMask = maskRule;
                    overlay.style.mask = maskRule; // Standard property

                    wrapperEl.appendChild(overlay);

                    // Force reflow
                    overlay.offsetHeight;
                    overlay.style.opacity = 1;
                }
            },

            handleTransform(data) {
                const targetType = data.Value01;
                const scaleVal = data.Value02;
                const duration = parseFloat(data.Value04 || 0);

                let targets = [];

                if (targetType === 'all') {
                    Object.values(State.characters).forEach(c => targets.push(c.wrapper || c.div));
                    const title = document.getElementById('title-layer').firstChild;
                    if (title) targets.push(title);
                    const overlay = document.getElementById('overlay-layer').firstChild;
                    if (overlay) targets.push(overlay);
                    const dialogue = document.getElementById('dialogue-box');
                    if (dialogue) targets.push(dialogue);
                } else if (targetType === 'allcharacter') {
                    Object.values(State.characters).forEach(c => targets.push(c.wrapper || c.div));
                } else if (targetType === 'ontitle') {
                    const title = document.getElementById('title-layer').firstChild;
                    if (title) targets.push(title);
                } else if (targetType === 'onimage') {
                    const overlay = document.getElementById('overlay-layer').firstChild;
                    if (overlay) targets.push(overlay);
                } else {
                    if (State.characters[targetType]) {
                        targets.push(State.characters[targetType].wrapper || State.characters[targetType].div);
                    }
                }

                let transformStr = '';
                if (scaleVal.includes('%')) {
                    const scale = parseFloat(scaleVal) / 100;
                    transformStr = `scale(${scale})`;
                } else if (scaleVal.includes('(') && scaleVal.includes(',')) {
                    const parts = scaleVal.replace(/[()]/g, '').split(',');
                    if (parts.length === 2) {
                        transformStr = `scale(${parts[0].trim()}, ${parts[1].trim()})`;
                    }
                } else {
                    const n = parseFloat(scaleVal);
                    if (!isNaN(n)) transformStr = `scale(${n})`;
                }

                if (!transformStr) return;

                targets.forEach(el => {
                    if (el.classList.contains('char-container')) {
                        const img = el.querySelector('.char-obj');
                        if (img) {
                            img.style.transition = `transform ${duration}s ease`;
                            img.style.transform = `${transformStr} translateY(var(--char-y-offset, 0%))`;
                        }
                    } else {
                        el.style.transition = `transform ${duration}s ease`;
                        el.style.transform = transformStr;
                    }
                });
            },

            handleGifEffect(data) {
                const char = State.characters[data.Value01];
                if (!char) return;

                const gif = document.createElement('img');
                gif.src = data.Value02;
                // 캐릭터 컨테이너의 정중앙에 배치되도록 스타일 설정 (모바일 스택 상속)
                gif.className = 'absolute pointer-events-none z-50';
                gif.style.left = '50%';
                gif.style.bottom = '50%';
                gif.style.transform = 'translate(-50%, 50%)';

                // 크기 조절 (Value03: 너비, Value04: 높이 또는 배율)
                if (data.Value03) gif.style.width = data.Value03;
                if (data.Value04) gif.style.height = data.Value04;

                char.el.appendChild(gif);

                if (data.Value05) {
                    setTimeout(() => gif.remove(), data.Value05 * 1000);
                } else {
                    // 기본 2초 후 제거
                    setTimeout(() => gif.remove(), 2000);
                }
            },

            playAudio(type, path, loop = false, delay = 0) {
                // KR: 이전 예약된 재생이 있다면 취소 및 페이드 인터벌 정리
                if (State.audioPlayTimeouts[type]) {
                    clearTimeout(State.audioPlayTimeouts[type]);
                }
                if (State.audioIntervals[type]) {
                    clearInterval(State.audioIntervals[type]);
                    delete State.audioIntervals[type];
                }

                const run = () => {
                    let aud = State.audio[type];
                    if (!aud) {
                        aud = new Audio();
                        State.audio[type] = aud;
                    }
                    aud.src = path;
                    aud.loop = loop;

                    // KR: 음소거 체크 및 슬라이더 설정값 적용
                    const isMuted = State.audio.masterMute;
                    aud.volume = isMuted ? 0 : (State.settings[type + 'Vol'] || 0.5);

                    aud.play().catch(e => {
                        this.debug(`Audio play blocked for ${type}: ${e.message}`);
                        if (type === 'bgm') State.pendingTitleBGM = true;
                    });
                };

                if (delay > 0) {
                    State.audioPlayTimeouts[type] = setTimeout(run, delay * 1000);
                } else {
                    run();
                }
            },

            stopAudio(type, fade = 0) {
                // KR: 페이드아웃 중인 인터벌 정지
                if (State.audioIntervals[type]) {
                    clearInterval(State.audioIntervals[type]);
                    delete State.audioIntervals[type];
                }
                // KR: 예약된 재생 취소
                if (State.audioPlayTimeouts[type]) {
                    clearTimeout(State.audioPlayTimeouts[type]);
                    delete State.audioPlayTimeouts[type];
                }

                const aud = State.audio[type];
                if (!aud) return;

                const duration = parseFloat(fade || 0);
                if (duration > 0) {
                    let vol = aud.volume;
                    const step = vol / (duration * 20);
                    State.audioIntervals[type] = setInterval(() => {
                        vol -= step;
                        if (vol <= 0) {
                            aud.pause();
                            // KR: 정지 후 볼륨 복구 (옵션 값 기준)
                            aud.volume = State.audio.masterMute ? 0 : (State.settings[type + 'Vol'] || 0.5);
                            clearInterval(State.audioIntervals[type]);
                            delete State.audioIntervals[type];
                        } else aud.volume = vol;
                    }, 50);
                } else {
                    aud.pause();
                }
            },

            handleGoodEnd(event) {
                // 1. Black Fade In
                this.handleCoverOverlayColor({ Value01: '#000', Value02: 2, Value03: 1 }, true);

                // 2. Play Ending BGM
                this.playAudio('bgm', 'assets/audio/bgm/25. 다음 이야기로(Next Step)_Ver.2.mp3', false);

                // 3. Credits Rolling
                setTimeout(() => {
                    const creditsModal = document.getElementById('credits-modal');
                    const creditsBody = document.getElementById('credits-body');
                    creditsModal.classList.remove('hidden');
                    creditsModal.style.background = 'transparent';
                    creditsModal.style.zIndex = '3000';

                    creditsBody.style.transform = 'translateY(100%)';
                    creditsBody.style.transition = 'transform 180s linear'; // Long duration for slow roll

                    // Force reflow
                    creditsBody.offsetHeight;
                    creditsBody.style.transform = 'translateY(-150%)';

                    // Ending sequence: 180s total (bgm length assumed around 3-4 min)
                    // If song ends, return to title.
                    const bgm = State.audio['bgm'];
                    if (bgm) {
                        bgm.onended = () => {
                            this.toMenu(true); // Forced return
                        };
                    }
                }, 2000);
            },

            // --- UI ---
            toggleAuto() {
                if (State.isChoiceActive || State.isQuizActive) {
                    this.showAlert(this.t('UNAVAILABLE_INTERACTION'));
                    return;
                }
                State.settings.autoMode = !State.settings.autoMode;
                this.updateAutoBtnUI();
                if (State.settings.autoMode && !State.isTextAnimating) {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) this.executeEvent(State.events[nextRelIdx].Index);
                }
            },

            forceAutoOff() {
                State.settings.autoMode = false;
                this.updateAutoBtnUI();
            },

            updateAutoBtnUI() {
                const btn = document.getElementById('auto-btn');
                if (btn) btn.innerText = `AUTO: ${State.settings.autoMode ? 'ON' : 'OFF'}`;
            },

            toggleBacklog() {
                this.forceAutoOff();
                const modal = document.getElementById('backlog-modal');
                const content = document.getElementById('backlog-content');
                if (modal.classList.contains('hidden')) {
                    // Copy and reverse for display
                    const reversedLog = [...State.backlog].reverse();
                    content.innerHTML = reversedLog.map(item => {
                        if (item.type === 'choice') {
                            const choiceHtml = item.choices.map((c, idx) => `
                                <div class="${idx === item.selectedIndex ? 'backlog-choice-selected' : 'backlog-choice-unselected'}">
                                    ${idx === item.selectedIndex ? '▶ ' : '　 '}${this.formatText(c)}
                                </div>
                            `).join('');
                            return `
                                <div class="border-b border-white/5 pb-4 space-y-2">
                                    <div class="text-accent-gold font-bold mr-4 text-sm opacity-50">[DECISION]</div>
                                    <div class="pl-4 border-l-2 border-white/10">${choiceHtml}</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="border-b border-white/5 pb-4">
                                    <span class="text-accent-gold font-bold mr-4">[${this.formatText(item.name || 'SYSTEM')}]</span>
                                    <span>${this.formatText(item.text)}</span>
                                </div>
                            `;
                        }
                    }).join('');
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },
            showSettings() { this.showOptions(); },

            showOptions() {
                this.forceAutoOff();
                const modal = document.getElementById('options-modal');
                modal.classList.remove('hidden');
                document.getElementById('options-header').innerText = this.t('OPTIONS_MENU');
                this.switchTab('sound');
            },

            closeModal(id) {
                // DEBUG: INDEX JUMP START
                if (id === 'options-modal') {
                    const jumpInput = document.getElementById('debug-index-jump');
                    if (jumpInput && jumpInput.value.trim() !== '') {
                        const targetIndex = parseInt(jumpInput.value);
                        if (!isNaN(targetIndex)) {
                            this.jumpToIndex(targetIndex);
                        }
                    }
                }
                // DEBUG: INDEX JUMP END
                document.getElementById(id).classList.add('hidden');
            },

            switchTab(tab) {
                document.getElementById('tab-sound').classList.toggle('active', tab === 'sound');
                document.getElementById('tab-display').classList.toggle('active', tab === 'display');
                const content = document.getElementById('tab-content');
                content.innerHTML = '';

                if (tab === 'sound') {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <span>${this.t('MASTER_MUTE')}</span>
                                <input type="checkbox" onchange="Engine.updateSetting('masterMute', this.checked)" ${State.audio.masterMute ? 'checked' : ''} class="w-8 h-8">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('BGM_VOL')}</span><span>${Math.round(State.settings.bgmVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('bgmVol', this.value/100)" value="${State.settings.bgmVol * 100}">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('SFX_VOL')}</span><span>${Math.round(State.settings.sfxVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('sfxVol', this.value/100)" value="${State.settings.sfxVol * 100}">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('VOICE_VOL')}</span><span>${Math.round(State.settings.voiceVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('voiceVol', this.value/100)" value="${State.settings.voiceVol * 100}">
                            </div>
                            <!-- DEBUG: INDEX JUMP START -->
                            <div class="mt-10 pt-6 border-t border-white/10 space-y-4">
                                <div class="text-xs text-accent-gold opacity-50 tracking-widest font-bold">DEVELOPER TOOLS</div>
                                <div class="flex gap-4 items-center">
                                    <span class="flex-1 text-sm opacity-70">INDEX JUMP</span>
                                    <input type="number" id="debug-index-jump" placeholder="Index..." 
                                        class="w-32 bg-white/5 border border-white/20 p-2 rounded-lg text-sm text-center outline-none focus:border-accent-gold text-white"
                                        onkeypress="if(event.key === 'Enter') Engine.closeModal('options-modal')">
                                </div>
                            </div>
                            <!-- DEBUG: INDEX JUMP END -->
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('LANGUAGE')}</span></div>
                                <select onchange="Engine.updateSetting('lang', this.value)" class="w-full bg-white/5 border border-white/20 p-4 rounded-xl text-xl outline-none focus:border-accent-gold">
                                    <option value="KO" ${State.lang === 'KO' ? 'selected' : ''} class="bg-bg-deep">한국어 (KO)</option>
                                    <option value="EN" ${State.lang === 'EN' ? 'selected' : ''} class="bg-bg-deep">English (EN)</option>
                                    <option value="JP" ${State.lang === 'JP' ? 'selected' : ''} class="bg-bg-deep">日本語 (JP)</option>
                                    <option value="CN_S" ${State.lang === 'CN_S' ? 'selected' : ''} class="bg-bg-deep">简体中文 (CN_S)</option>
                                    <option value="CN_T" ${State.lang === 'CN_T' ? 'selected' : ''} class="bg-bg-deep">繁體中文 (CN_T)</option>
                                    <option value="ES" ${State.lang === 'ES' ? 'selected' : ''} class="bg-bg-deep">Español (ES)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('DIFFICULTY_LEVEL')}</span></div>
                                <select onchange="Engine.updateSetting('difficulty', this.value)" class="w-full bg-white/5 border border-white/20 p-4 rounded-xl text-xl outline-none focus:border-accent-gold">
                                    <option value="very-hard" ${State.settings.difficulty === 'very-hard' ? 'selected' : ''} class="bg-bg-deep">${this.t('DIFF_VERY_HARD')}</option>
                                    <option value="hard" ${State.settings.difficulty === 'hard' ? 'selected' : ''} class="bg-bg-deep">${this.t('DIFF_HARD')}</option>
                                    <option value="normal" ${State.settings.difficulty === 'normal' ? 'selected' : ''} class="bg-bg-deep">${this.t('DIFF_NORMAL')}</option>
                                    <option value="easy" ${State.settings.difficulty === 'easy' ? 'selected' : ''} class="bg-bg-deep">${this.t('DIFF_EASY')}</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('TEXT_SPEED')}</span></div>
                                <input type="range" min="10" max="100" step="10" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('textSpeed', 110 - this.value)" value="${110 - State.settings.textSpeed}">
                            </div>
                            <div class="flex justify-between items-center">
                                <span>${this.t('AUTO_MODE_TITLE')}</span>
                                <input type="checkbox" onchange="Engine.updateSetting('autoMode', this.checked)" ${State.settings.autoMode ? 'checked' : ''} class="w-8 h-8">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('DIALOGUE_OPACITY')}</span><span>${Math.round(State.settings.opacity * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('opacity', this.value/100)" value="${State.settings.opacity * 100}">
                            </div>
                        </div>
                    `;
                }
            },

            updateSetting(key, val) {
                if (key === 'masterMute') {
                    State.audio.masterMute = val;
                    // KR: 모든 재생 중인 오디오에 즉시 반영
                    Object.keys(State.audio).forEach(type => {
                        const aud = State.audio[type];
                        if (aud instanceof Audio) {
                            aud.volume = val ? 0 : (State.settings[type + 'Vol'] || 0.5);
                        }
                    });
                } else if (key.endsWith('Vol')) {
                    State.settings[key] = val;
                    const type = key.replace('Vol', ''); // bgm, sfx, voice
                    const aud = State.audio[type];
                    if (aud instanceof Audio && !State.audio.masterMute) {
                        aud.volume = val;
                    }
                } else if (key === 'lang') {
                    State.lang = val;
                    this.updateTitleMenu();
                    const optionsHeader = document.getElementById('options-header');
                    if (optionsHeader) optionsHeader.innerText = this.t('OPTIONS_MENU');
                } else if (key === 'difficulty') {
                    State.settings.difficulty = val;
                } else if (State.settings.hasOwnProperty(key)) {
                    State.settings[key] = val;
                    if (key === 'opacity') {
                        document.getElementById('dialogue-box').style.opacity = val;
                    }
                }
                this.switchTab(document.getElementById('tab-sound').classList.contains('active') ? 'sound' : 'display');
            },

            showScore() {
                const modal = document.getElementById('score-modal');
                modal.classList.remove('hidden');
                document.getElementById('score-header').innerText = this.t('SCOREBOARD_TITLE');

                const scores = JSON.parse(localStorage.getItem('aaa_scores') || '[]');
                const totalPlayers = scores.length;
                const totalTime = scores.reduce((acc, s) => acc + (s.time || 0), 0);

                document.getElementById('score-summary').innerHTML = `
                    <div><div class="text-sm opacity-50">${this.t('TOTAL_PLAYERS')}</div><div class="text-4xl font-bold">${totalPlayers}</div></div>
                    <div><div class="text-sm opacity-50">${this.t('TOTAL_TIME')}</div><div class="text-4xl font-bold">${Math.floor(totalTime / 60)}m ${totalTime % 60}s</div></div>
                `;

                document.getElementById('score-list').innerHTML = scores.slice(0, 10).map(s => `
                    <div class="flex justify-between bg-white/5 p-4 rounded-xl border border-white/10">
                        <span class="font-bold text-accent-gold">${s.name}</span>
                        <span class="opacity-70">${s.date}</span>
                        <span>${Math.floor(s.time / 60)}m ${s.time % 60}s</span>
                    </div>
                `).join('') || '<p class="text-center opacity-30 mt-10">NO DATA</p>';
            },

            showCredits() {
                document.getElementById('credits-modal').classList.remove('hidden');
            },

            showExit() {
                this.showConfirm(this.t('QUIT_CONFIRM'), () => {
                    window.close();
                });
            },

            toMenu(force = false) {
                const exitAction = () => {
                    this.closeAllModals();
                    this.clearAllTimers(); // KR: 메뉴 복귀 시 모든 예약된 이벤트 및 오디오 정리

                    // KR: 모든 현재 오디오 중지
                    Object.keys(State.audio).forEach(type => {
                        if (type !== 'masterMute') this.stopAudio(type);
                    });

                    document.getElementById('menu-layer').style.display = 'block';
                    document.getElementById('menu-layer').classList.remove('fade-out');

                    document.getElementById('system-ui').classList.add('hidden');
                    document.getElementById('dialogue-layer').style.display = 'none';
                    document.getElementById('interaction-layer').innerHTML = '';
                    document.getElementById('character-layer').innerHTML = '';
                    document.getElementById('bgimage-layer').innerHTML = '';
                    document.getElementById('bgcolor-layer').style.backgroundColor = '#000';
                    document.getElementById('title-layer').innerHTML = '';
                    document.getElementById('oncolor-layer').innerHTML = '';
                    document.getElementById('onimage-layer').innerHTML = '';
                    document.getElementById('cover-overlay-layer').innerHTML = '';

                    State.currentIndex = 0;
                    State.characters = {};
                    State.settings.autoMode = false;
                    State.isInteractionWaiting = false;
                    State.isChoiceActive = false;
                    State.isQuizActive = false;
                    State.isGameStarted = false;
                    document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                    this.showTitle(); // KR: 타이틀 BGM 시작 포함
                };

                if (force) {
                    exitAction();
                } else {
                    this.showConfirm(this.t('QUIT_CONFIRM'), exitAction);
                }
            },

            closeAllModals() {
                ['options-modal', 'score-modal', 'credits-modal', 'universal-confirm', 'universal-alert', 'backlog-modal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
            },

            showAlert(msg, cb) {
                const modal = document.getElementById('universal-alert');
                document.getElementById('alert-msg').innerHTML = this.formatText(msg);
                const btn = document.getElementById('alert-ok');
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    if (cb) cb();
                };
                modal.classList.remove('hidden');
            },

            showConfirm(msg, onYes, onNo) {
                const modal = document.getElementById('universal-confirm');
                document.getElementById('confirm-msg').innerHTML = this.formatText(msg);

                const yesBtn = document.getElementById('confirm-yes');
                const noBtn = document.getElementById('confirm-no');

                yesBtn.innerText = this.t('YES');
                noBtn.innerText = this.t('NO');

                yesBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onYes) onYes();
                };
                noBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onNo) onNo();
                };
                modal.classList.remove('hidden');
            },

            debug(msg) {
                console.log("[DEBUG]", msg);
            },

            // --- 타이머 관리 (인덱스 점프용) ---
            setSafeTimeout(cb, ms) {
                const id = setTimeout(() => {
                    State.activeTimers = State.activeTimers.filter(t => t !== id);
                    cb();
                }, ms);
                State.activeTimers.push(id);
                return id;
            },

            clearAllTimers() {
                // 1. Scene Timers
                State.activeTimers.forEach(t => clearTimeout(t));
                State.activeTimers = [];

                // 2. Audio Play Timeouts (Pending plays)
                Object.keys(State.audioPlayTimeouts).forEach(type => {
                    clearTimeout(State.audioPlayTimeouts[type]);
                    delete State.audioPlayTimeouts[type];
                });

                // 3. Audio Intervals (Fading)
                Object.keys(State.audioIntervals).forEach(type => {
                    clearInterval(State.audioIntervals[type]);
                    delete State.audioIntervals[type];
                });
            },

            jumpToIndex(index) {
                // 1. 진행 중인 효과 및 상태 중단
                State.isTextAnimating = false;
                State.isInteractionWaiting = false;
                State.isChoiceActive = false;
                State.isQuizActive = false;

                // 2. 타이머 소거 (안정적인 점프를 위해 필수)
                this.clearAllTimers();

                // 3. UI 정리 (퀴즈, 선택지, 오버레이 레이어)
                const layer = document.getElementById('interaction-layer');
                if (layer) layer.innerHTML = '';

                document.getElementById('oncolor-layer').innerHTML = '';
                document.getElementById('cover-overlay-layer').innerHTML = '';
                document.getElementById('onimage-layer').innerHTML = '';
                document.getElementById('oncolor-layer').style.pointerEvents = 'none';
                document.getElementById('cover-overlay-layer').style.pointerEvents = 'none';

                // 4. 인덱스 이동 후 실행
                this.debug(`Jump to target index: ${index}`);
                this.executeEvent(index);
            }
        }

        window.onload = () => Engine.init();
    </script>
</body>

</html>