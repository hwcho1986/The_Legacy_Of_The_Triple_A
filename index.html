<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Legacy Of The Triple A - 대괴도 AAA의 유산 v0.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-red: #b91c1c;
            --accent-gold: #d4af37;
            --glass-bg: rgba(0, 0, 0, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Outfit', 'Noto Serif KR', serif;
            color: #fff;
            user-select: none;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            background: #000;
            position: relative;
        }

        /* Layer System */
        .layer {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .layer-interactive {
            pointer-events: auto;
        }

        /* Effects & Animations */
        .fade-in {
            animation: fadeIn var(--duration, 1s) ease forwards;
        }

        .fade-out {
            animation: fadeOut var(--duration, 1s) ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .shake {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-5px, 5px);
            }

            50% {
                transform: translate(5px, -5px);
            }

            75% {
                transform: translate(-5px, -5px);
            }
        }

        .blind-in {
            clip-path: inset(0 0 100% 0);
            animation: blindIn var(--duration, 1s) ease forwards;
        }

        @keyframes blindIn {
            to {
                clip-path: inset(0 0 0 0);
            }
        }

        /* Glassmorphism UI */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .premium-btn {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), transparent);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .premium-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
        }

        /* Typewriter & Icon */
        .cursor-blink::after {
            content: '▼';
            margin-left: 8px;
            color: var(--accent-gold);
            animation: blink 0.8s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Character Transitions */
        .char-obj {
            transition: all 1s ease-in-out;
        }

        /* Disclaimer Note UI */
        .note-popup {
            background: #fdf6e3;
            color: #5c4b37;
            padding: 2rem;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), inset 0 0 50px rgba(0, 0, 0, 0.1);
            position: absolute;
            width: 400px;
            font-family: 'Noto Serif KR', serif;
            transform-origin: center;
            z-index: 100;
        }

        .note-popup::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(transparent, transparent 24px, rgba(0, 0, 0, 0.05) 25px);
            pointer-events: none;
        }

        /* Menu Selection */
        .menu-item.active,
        .menu-item:hover {
            color: var(--accent-gold);
            transform: scale(1.1);
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
            border-color: var(--accent-gold);
            background: rgba(255, 255, 255, 0.2);
        }

        .menu-item.active::before,
        .menu-item:hover::before {
            content: '▶';
            position: absolute;
            left: -40px;
            animation: bounceLeft 0.5s infinite alternate;
        }

        .backlog-choice-selected {
            color: #4ade80;
            /* emerald-400 */
            font-weight: bold;
        }

        .backlog-choice-unselected {
            text-decoration: line-through;
            opacity: 0.5;
        }

        @keyframes bounceLeft {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-10px);
            }
        }

        /* Tabs */
        .tab-btn.active {
            border-bottom: 3px solid var(--accent-gold);
            color: var(--accent-gold);
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- disclaimer -->
        <div id="disclaimer-layer" class="layer" style="z-index: 1000; background: #000; display: none;">
            <div class="flex items-center justify-center h-full p-20 text-center">
                <p id="disclaimer-text" class="text-3xl leading-loose font-serif max-w-4xl"></p>
            </div>
        </div>

        <!-- bgcolor -->
        <div id="bgcolor-layer" class="layer" style="z-index: 0; background-color: #000000;"></div>

        <!-- onbgimage (multiple) -->
        <div id="bgimage-layer" class="layer" style="z-index: 10;"></div>

        <!-- oncharacter -->
        <div id="character-layer" class="layer"
            style="z-index: 20; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5%;">
        </div>

        <!-- dialogue / speak -->
        <div id="dialogue-layer" class="layer layer-interactive" style="z-index: 40; display: none;">
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-[90%] max-w-[1400px] glass p-8 rounded-3xl cursor-pointer"
                id="dialogue-box">
                <div id="speaker-name"
                    class="text-3xl font-bold text-accent-gold mb-4 border-l-4 border-primary-red pl-4"></div>
                <div id="dialogue-text" class="text-2xl leading-relaxed font-serif min-h-[100px]"></div>
            </div>
        </div>

        <!-- oncolor / onimage -->
        <div id="overlay-layer" class="layer" style="z-index: 50;"></div>

        <!-- title / ontitle -->
        <div id="title-layer" class="layer" style="z-index: 70;"></div>

        <!-- Main Menu Layer -->
        <div id="menu-layer" class="layer layer-interactive" style="z-index: 150; background: #000; display: none;">
            <div class="flex flex-col items-center justify-center h-full space-y-12">
                <h1 id="title-logo" class="text-8xl font-cinzel text-accent-gold tracking-tighter fade-in"
                    style="--duration: 2s">THE
                    LEGACY OF<br><span class="text-white">THE TRIPLE A</span></h1>
                <div id="main-menu-list" class="flex flex-col space-y-4 w-96">
                    <button data-menu="start"
                        class="menu-item premium-btn py-6 rounded-xl text-2xl font-bold tracking-widest text-white uppercase"></button>
                    <button data-menu="options"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                    <button data-menu="score"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                    <button data-menu="credits"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                    <button data-menu="exit"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                </div>
            </div>
        </div>

        <!-- choice / quiz -->
        <div id="interaction-layer" class="layer layer-interactive" style="z-index: 80;"></div>

        <!-- System UI (Always on top) -->
        <div id="system-ui" class="absolute top-0 w-full p-6 flex justify-between items-center hidden"
            style="z-index: 100;">
            <button onclick="Engine.toggleBacklog()"
                class="premium-btn px-6 py-2 rounded-full text-sm tracking-widest uppercase text-white">Log</button>
            <div class="flex gap-4">
                <button onclick="Engine.toggleAuto()" id="auto-btn"
                    class="premium-btn px-6 py-2 rounded-full text-sm text-white">AUTO: OFF</button>
                <button onclick="Engine.showSettings()"
                    class="premium-btn px-6 py-2 rounded-full text-sm text-white">SETTING</button>
                <button onclick="Engine.toMenu()"
                    class="premium-btn px-6 py-2 rounded-full text-sm text-white">EXIT</button>
            </div>
        </div>

        <!-- Modals -->
        <div id="options-modal" class="absolute inset-0 glass z-[300] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest" id="options-header">OPTIONS</h2>
                <button onclick="Engine.closeModal('options-modal')" class="text-4xl">✕</button>
            </div>
            <div class="flex gap-10 mb-10">
                <button onclick="Engine.switchTab('sound')" id="tab-sound"
                    class="tab-btn text-2xl font-bold pb-2 active uppercase">Sound</button>
                <button onclick="Engine.switchTab('display')" id="tab-display"
                    class="tab-btn text-2xl font-bold pb-2 uppercase">Display</button>
            </div>
            <div id="tab-content" class="space-y-10 text-xl overflow-y-auto pr-4">
                <!-- Content injection -->
            </div>
        </div>

        <div id="score-modal" class="absolute inset-0 glass z-[300] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest" id="score-header">SCOREBOARD</h2>
                <button onclick="Engine.closeModal('score-modal')" class="text-4xl">✕</button>
            </div>
            <div id="score-summary" class="grid grid-cols-2 gap-10 mb-10 p-8 bg-white/5 rounded-3xl text-center">
                <!-- Summary injection -->
            </div>
            <div id="score-list" class="flex-1 overflow-y-auto space-y-4 pr-4">
                <!-- List injection -->
            </div>
        </div>

        <div id="credits-modal"
            class="absolute inset-0 glass z-[300] hidden flex flex-col items-center justify-center p-20">
            <div class="w-full max-w-4xl text-center space-y-20">
                <h2 class="text-6xl font-cinzel text-accent-gold" id="credits-header">CREDITS</h2>
                <div class="space-y-8 text-2xl leading-loose" id="credits-body">
                    <p><span class="opacity-50">Producer</span><br><b>Joe Choe</b></p>
                    <p><span class="opacity-50">Engine Development</span><br><b>Joe Choe</b></p>
                    <p><span class="opacity-50">Scenario & Design</span><br><b>Joe Choe</b></p>
                    <p><span class="opacity-50">Globalization</span><br><b>Joe Choe</b></p>
                </div>
                <button onclick="Engine.closeModal('credits-modal')"
                    class="premium-btn px-20 py-4 rounded-xl text-xl">CLOSE</button>
            </div>
        </div>

        <!-- Universal Confirm Modal -->
        <div id="universal-confirm"
            class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
            <div class="glass p-12 rounded-3xl text-center space-y-10 max-w-2xl">
                <p id="confirm-msg" class="text-3xl leading-relaxed"></p>
                <div class="flex gap-6 justify-center">
                    <button id="confirm-yes"
                        class="premium-btn px-16 py-4 rounded-xl text-2xl bg-primary-red/20 border-primary-red uppercase">YES</button>
                    <button id="confirm-no" class="premium-btn px-16 py-4 rounded-xl text-2xl uppercase">NO</button>
                </div>
            </div>
        </div>

        <!-- Universal Alert Modal -->
        <div id="universal-alert"
            class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[1000] hidden flex items-center justify-center">
            <div class="glass p-12 rounded-3xl text-center space-y-10 max-w-xl">
                <p id="alert-msg" class="text-3xl leading-relaxed"></p>
                <div class="flex justify-center">
                    <button id="alert-ok"
                        class="premium-btn px-20 py-4 rounded-xl text-2xl bg-accent-gold/20 border-accent-gold text-accent-gold uppercase">OK</button>
                </div>
            </div>
        </div>

        <div id="backlog-modal" class="absolute inset-0 glass z-[300] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest">LOG</h2>
                <button onclick="Engine.closeModal('backlog-modal')" class="text-4xl">✕</button>
            </div>
            <div id="backlog-content" class="flex-1 overflow-y-auto space-y-6 pr-4 font-serif text-xl leading-relaxed">
                <!-- Log injection -->
            </div>
        </div>

        <!-- Debug Overlay -->
        <div id="debug-overlay"
            class="absolute top-20 right-6 w-80 p-4 glass rounded-xl text-xs font-mono text-red-400 hidden"
            style="z-index: 1000;"></div>
    </div>

    <script>
        const State = {
            lang: 'KO',
            currentIndex: 0,
            eventHistory: [],
            events: [],
            localization: {},
            backlog: [],
            characters: {},
            backgrounds: {},
            audio: {
                bgm: new Audio(),
                amb: new Audio(),
                sfx: new Audio(),
                voice: new Audio(),
                masterMute: false
            },
            settings: {
                textSpeed: 30, // 10, 30, 100
                autoMode: false,
                opacity: 0.8,
                bgmVol: 0.5,
                sfxVol: 0.5,
                voiceVol: 0.8
            },
            isTextAnimating: false,
            isInteractionWaiting: false,
            isChoiceActive: false,
            isQuizActive: false,
            currentEvent: null,
            currentVoice: null,
            stats: {
                hp: 100,
                keywords: [],
                startTime: null,
                totalTime: 0
            },
            menuIndex: 0,
            isNoteVisible: false
        };

        const Engine = {
            async init() {
                try {
                    // Set language from browser
                    const browserLang = navigator.language.slice(0, 2).toUpperCase();
                    const supported = ['KO', 'EN', 'JP', 'ES'];
                    const fullSupported = { 'zh-CN': 'CN_S', 'zh-TW': 'CN_T', 'zh-HK': 'CN_T' };

                    if (fullSupported[navigator.language]) State.lang = fullSupported[navigator.language];
                    else if (supported.includes(browserLang)) State.lang = browserLang;
                    else State.lang = 'KO';

                    const [resP, resL] = await Promise.all([
                        fetch('assets/Table/PLAY.JSON'),
                        fetch('assets/Table/LOCALIZATION.JSON')
                    ]);
                    State.events = await resP.json();
                    State.events.sort((a, b) => a.Index - b.Index);
                    State.localization = await resL.json();

                    // Key listeners
                    window.addEventListener('keydown', (e) => this.handleKeyDown(e));

                    document.getElementById('game-container').addEventListener('mousedown', (e) => {
                        this.handleMouseDown(e);
                    });

                    this.showDisclaimer();

                } catch (e) {
                    this.debug(`Failed to load tables: ${e.message}`);
                }
            },

            showDisclaimer() {
                const layer = document.getElementById('disclaimer-layer');
                const text = document.getElementById('disclaimer-text');
                layer.style.display = 'block';
                text.innerText = this.t('DISCLAIMER');
                text.classList.add('fade-in');

                setTimeout(() => {
                    text.classList.remove('fade-in');
                    text.classList.add('fade-out');
                    setTimeout(() => {
                        layer.classList.add('fade-out');
                        setTimeout(() => {
                            layer.style.display = 'none';
                            this.showTitle();
                        }, 1000);
                    }, 1000);
                }, 5000);
            },

            showTitle() {
                const layer = document.getElementById('menu-layer');
                layer.style.display = 'block';
                layer.classList.remove('fade-out');
                layer.classList.add('fade-in');
                this.updateTitleMenu();
            },

            updateTitleMenu() {
                const items = document.querySelectorAll('.menu-item');
                const keys = ['START_GAME', 'OPTIONS', 'SCORE', 'CREDITS', 'EXIT'];
                const actions = ['startGame', 'showOptions', 'showScore', 'showCredits', 'showExit'];

                items.forEach((item, i) => {
                    item.innerText = this.t(keys[i]);
                    item.classList.toggle('active', i === State.menuIndex);

                    // Mouse events
                    item.onclick = (e) => {
                        e.stopPropagation();
                        State.menuIndex = i;
                        this.executeMenuAction();
                    };
                    item.onmouseenter = () => {
                        State.menuIndex = i;
                        this.updateTitleMenu();
                    };
                });
            },

            handleKeyDown(e) {
                // Menu Navigation
                if (document.getElementById('menu-layer').style.display !== 'none' && !State.isInteractionWaiting) {
                    if (e.code === 'ArrowDown' || e.code === 'KeyS') {
                        State.menuIndex = (State.menuIndex + 1) % 5;
                        this.updateTitleMenu();
                    } else if (e.code === 'ArrowUp' || e.code === 'KeyW') {
                        State.menuIndex = (State.menuIndex - 1 + 5) % 5;
                        this.updateTitleMenu();
                    } else if (e.code === 'Enter' || e.code === 'Space') {
                        this.executeMenuAction();
                    }
                    return;
                }

                // Global interaction
                if (e.code === 'Space' || e.code === 'Enter') {
                    if (State.isInteractionWaiting) this.handleGlobalInteraction();
                }
            },

            handleMouseDown(e) {
                // Clicking center to advance
                if (State.isInteractionWaiting) {
                    const cx = window.innerWidth / 2;
                    const cy = window.innerHeight / 2;
                    const dist = Math.sqrt((e.clientX - cx) ** 2 + (e.clientY - cy) ** 2);
                    if (dist < 200) { // Center click
                        this.handleGlobalInteraction();
                        return;
                    }
                }

                if (State.isInteractionWaiting) this.handleGlobalInteraction();
            },

            executeMenuAction() {
                const actions = ['startGame', 'showOptions', 'showScore', 'showCredits', 'showExit'];
                this[actions[State.menuIndex]]();
            },

            startGame() {
                const menu = document.getElementById('menu-layer');
                menu.classList.add('fade-out');
                State.stats.startTime = Date.now();
                setTimeout(() => {
                    menu.style.display = 'none';
                    document.getElementById('system-ui').classList.remove('hidden');
                    this.executeEvent(State.events[0].Index);
                }, 1000);
            },

            t(key) {
                if (!key) return '';
                if (typeof key !== 'string') return JSON.stringify(key);
                if (key.startsWith('"') && key.endsWith('"')) return key.slice(1, -1);
                if (State.localization[key]) {
                    const entry = State.localization[key];
                    return entry[State.lang] || entry['KO'] || entry['EN'] || key;
                }
                return key;
            },

            async executeEvent(index) {
                const event = State.events.find(e => e.Index === index);
                if (!event) {
                    this.debug(`Index ${index} not found`);
                    return;
                }
                const currentRelIdx = State.events.indexOf(event);
                State.currentIndex = currentRelIdx;

                console.log("Executing:", event.type, event);

                switch (event.type) {
                    case 'bgcolor':
                        const bgLayer = document.getElementById('bgcolor-layer');
                        bgLayer.style.transition = `background-color ${event.Value02 || 0}s`;
                        bgLayer.style.backgroundColor = event.Value01 || '#000000';
                        this.next(event.Index, 'Read');
                        break;

                    case 'onbgimage':
                        this.handleBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgimage':
                        this.handleOffBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'oncharacter':
                        this.handleCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcharacter':
                        this.handleOffCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'speak':
                        this.handleSpeak(event);
                        break;

                    case 'oncolor':
                        this.handleOverlayColor(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcolor':
                        this.handleOverlayColor(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onimage':
                        this.handleOverlayImage(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offimage':
                        this.handleOverlayImage(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'title':
                        this.handleTitle(event);
                        break;

                    case 'ontitle':
                        this.handleTitle(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offtitle':
                        document.getElementById('title-layer').innerHTML = '';
                        this.next(event.Index, 'Read');
                        break;

                    case 'choice':
                        this.handleChoice(event);
                        break;

                    case 'quiz01':
                        this.handleQuiz(event);
                        break;

                    case 'onbgm':
                        this.playAudio('bgm', event.Value01, event.Value02 === 'loop', event.Value03);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgm':
                        this.stopAudio('bgm', event.Value01);
                        this.next(event.Index, 'Read');
                        break;

                    case 'jump':
                        this.executeEvent(parseInt(event.Value01));
                        break;

                    case 'Wait':
                        setTimeout(() => this.next(event.Index, 'Read'), (event.Value01 || 0) * 1000);
                        break;

                    case 'anieffect':
                        this.handleAniEffect(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'next':
                        this.initNextChapter(event.Value01);
                        break;

                    case 'end':
                        this.showAlert(this.t('END_OF_CHAPTER'), () => location.reload());
                        break;

                    default:
                        this.debug(`Unknown type: ${event.type}`);
                        this.next(event.Index, 'Read');
                }
            },

            next(index, mode) {
                if (mode === 'Read') {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) {
                        this.executeEvent(State.events[nextRelIdx].Index);
                    }
                }
            },

            // --- Handlers ---
            handleBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const img = document.createElement('img');
                img.src = data.Value01;
                img.className = `layer object-cover w-full h-full fade-in`;
                img.style.setProperty('--duration', `${data.Value03 || 0}s`);
                img.dataset.num = data.Value04 || 1;

                layer.appendChild(img);
                const sorted = [...layer.querySelectorAll('img')].sort((a, b) => b.dataset.num - a.dataset.num);
                layer.innerHTML = '';
                sorted.forEach(el => layer.appendChild(el));
            },

            handleOffBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const target = layer.querySelector(`img[data-num="${data.Value01}"]`);
                if (target) {
                    target.classList.add('fade-out');
                    setTimeout(() => target.remove(), (data.Value03 || 0.5) * 1000);
                }
            },

            handleCharacter(data) {
                const layer = document.getElementById('character-layer');
                let char = State.characters[data.Value01];
                if (!char) {
                    const el = document.createElement('img');
                    el.className = 'char-obj h-full object-contain mx-[-10%]';
                    char = { el, id: data.Value01 };
                    State.characters[data.Value01] = char;
                    layer.appendChild(el);
                }

                char.el.src = `assets/images/character/${data.Value01}.png`;
                if (data.Value02 && data.Value02 !== 'normal') char.el.src = `assets/images/character/${data.Value01}_${data.Value02}.png`;

                if (data.Value04 === 'fadein') {
                    char.el.classList.add('fade-in');
                    char.el.style.setProperty('--duration', `${data.Value05 || 1}s`);
                }
            },

            handleOffCharacter(data) {
                const char = State.characters[data.Value01];
                if (char) {
                    char.el.classList.add('fade-out');
                    setTimeout(() => {
                        char.el.remove();
                        delete State.characters[data.Value01];
                    }, (data.Value05 || 0.5) * 1000);
                }
            },

            handleSpeak(data) {
                const layer = document.getElementById('dialogue-layer');
                const speaker = document.getElementById('speaker-name');
                const text = document.getElementById('dialogue-text');
                const box = document.getElementById('dialogue-box');

                layer.style.display = 'block';
                const nameStr = this.t(data.Value02);
                speaker.innerText = nameStr;

                // Highlight character
                Object.values(State.characters).forEach(c => {
                    if (c.id === data.Value01) {
                        c.el.style.transform = 'scale(1.15)';
                        c.el.style.filter = 'brightness(1.1)';
                        c.el.style.zIndex = '30';
                    } else {
                        c.el.style.transform = 'scale(1)';
                        c.el.style.filter = 'brightness(0.7)';
                        c.el.style.zIndex = '20';
                    }
                });

                const content = this.t(data.Value03);
                State.backlog.push({ name: nameStr, text: content });

                this.typeText(text, content, () => {
                    if (State.settings.autoMode) {
                        const autoWait = 1000 + (content.length * 50);
                        setTimeout(() => {
                            if (State.settings.autoMode && !State.isTextAnimating) this.next(data.Index, 'Read');
                        }, autoWait);
                    }
                });

                if (data.Value04) {
                    this.playAudio('voice', data.Value04);
                }

                State.isInteractionWaiting = true;
                State.currentEvent = data;
            },

            handleGlobalInteraction() {
                if (State.isTextAnimating) {
                    State.isTextAnimating = false;
                } else if (State.isInteractionWaiting) {
                    State.isInteractionWaiting = false;
                    this.next(State.currentEvent.Index, 'Read');
                }
            },

            typeText(el, str, cb) {
                el.innerText = '';
                el.classList.remove('cursor-blink');
                State.isTextAnimating = true;
                let i = 0;
                const speeds = { slow: 100, normal: 30, fast: 10 };
                const speed = speeds[State.settings.textSpeed] || 30;

                const timer = setInterval(() => {
                    if (!State.isTextAnimating) {
                        el.innerText = str;
                        clearInterval(timer);
                        el.classList.add('cursor-blink');
                        cb();
                        return;
                    }
                    el.innerText += str[i++];
                    if (i >= str.length) {
                        clearInterval(timer);
                        State.isTextAnimating = false;
                        el.classList.add('cursor-blink');
                        cb();
                    }
                }, speed);
            },

            handleOverlayColor(data, on) {
                const layer = document.getElementById('overlay-layer');
                if (on) {
                    layer.style.pointerEvents = 'auto';
                    const el = document.createElement('div');
                    el.className = 'layer fade-in';
                    el.style.backgroundColor = data.Value01;
                    const opacityStr = data.Value03 || '100%';
                    el.style.opacity = opacityStr.includes('%') ? parseInt(opacityStr) / 100 : opacityStr;
                    el.style.setProperty('--duration', `${data.Value02 || 0.5}s`);
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                    layer.style.pointerEvents = 'none';
                }
            },

            handleOverlayImage(data, on) {
                const layer = document.getElementById('overlay-layer');
                if (on) {
                    const el = document.createElement('img');
                    el.src = data.Value01;
                    el.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 fade-in';
                    if (data.Value02) {
                        const parts = String(data.Value02).split(',');
                        if (parts.length === 2) {
                            el.style.width = parts[0] + 'px';
                            el.style.height = parts[1] + 'px';
                        }
                    }
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                }
            },

            handleTitle(data, keep = false) {
                const layer = document.getElementById('title-layer');
                const el = document.createElement('div');
                el.className = 'absolute inset-0 flex items-center justify-center text-center p-20 z-10';
                el.style.fontFamily = data.Value01 || 'Cinzel, serif';
                el.style.fontSize = (data.Value02 || 48) + 'px';
                el.style.color = data.Value03 || '#fff';
                el.innerText = '';
                layer.appendChild(el);

                this.typeText(el, this.t(data.Value04), () => {
                    if (!keep) {
                        setTimeout(() => {
                            el.classList.add('fade-out');
                            setTimeout(() => { el.remove(); this.next(data.Index, 'Read'); }, 1000);
                        }, 2000);
                    }
                });
            },

            handleChoice(data) {
                // Force Auto-off and block it
                State.settings.autoMode = false;
                State.isChoiceActive = true;
                document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                const layer = document.getElementById('interaction-layer');
                const container = document.createElement('div');
                container.className = 'flex flex-col gap-6 items-center justify-center h-full bg-black/40';

                const choices = [];
                choices.push({ text: this.t(data.Value01), target: data.Value02 });
                if (data.Value03) choices.push({ text: this.t(data.Value03), target: data.Value04 });

                const addBtn = (choice, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'premium-btn glass px-20 py-8 rounded-2xl text-2xl w-[600px] text-white';
                    btn.innerText = choice.text;
                    btn.onclick = () => {
                        State.isChoiceActive = false; // Reset flag

                        // Record to backlog with selection info
                        State.backlog.push({
                            type: 'choice',
                            choices: choices.map(c => c.text),
                            selectedIndex: idx
                        });

                        layer.innerHTML = '';
                        this.executeEvent(choice.target);
                    };
                    container.appendChild(btn);
                };

                choices.forEach((c, idx) => addBtn(c, idx));
                layer.appendChild(container);
            },

            handleQuiz(data) {
                // Force Auto-off and block it
                State.settings.autoMode = false;
                State.isQuizActive = true;
                document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                const layer = document.getElementById('interaction-layer');
                layer.innerHTML = '';
                const quizBox = document.createElement('div');
                quizBox.className = 'absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm';
                quizBox.innerHTML = `
                    <div class="glass p-12 rounded-[3rem] w-[800px] text-center">
                        <div class="text-xl opacity-60 mb-8 border-b border-white/10 pb-4 tracking-[0.5em]">QUERY NODE</div>
                        <div class="text-3xl mb-12 font-serif">${this.t(data.Value01)}</div>
                        <input id="quiz-input" autocomplete="off" class="w-full bg-white/5 border border-white/20 p-6 rounded-xl text-3xl mb-8 focus:border-accent-gold outline-none text-center" placeholder="...">
                        <div class="flex gap-4 mb-8">
                            <button id="hint-1" class="premium-btn p-4 rounded-xl flex-1 text-xs text-white">HINT 1</button>
                            ${data.Value04 ? `<button id="hint-2" class="premium-btn p-4 rounded-xl flex-1 text-xs text-white">HINT 2</button>` : ''}
                            ${data.Value05 ? `<button id="hint-3" class="premium-btn p-4 rounded-xl flex-1 text-xs text-white">HINT 3</button>` : ''}
                        </div>
                        <button id="quiz-submit" class="premium-btn w-full p-6 rounded-xl text-2xl bg-primary-red/20 border-primary-red text-white">EXECUTE</button>
                    </div>
                `;
                layer.appendChild(quizBox);

                const input = quizBox.querySelector('#quiz-input');
                input.focus();

                const answers = Array.isArray(data.Value02) ? data.Value02 : [data.Value02];

                const check = () => {
                    const val = input.value.toLowerCase().replace(/\s/g, '');
                    const isCorrect = answers.some(a => String(a).toLowerCase().replace(/\s/g, '') === val);
                    if (isCorrect) {
                        State.isQuizActive = false; // Reset flag
                        layer.innerHTML = '';
                        this.next(data.Index, 'Read');
                    } else {
                        quizBox.querySelector('.glass').classList.add('shake');
                        setTimeout(() => quizBox.querySelector('.glass').classList.remove('shake'), 500);
                        input.value = '';
                    }
                };

                quizBox.querySelector('#quiz-submit').onclick = check;
                input.onkeydown = (e) => { if (e.key === 'Enter') check(); };

                const showHint = (hintKey) => {
                    const hintTxt = this.t(data[hintKey]);
                    if (!hintTxt) return;

                    let note = document.getElementById('hint-note');
                    if (!note) {
                        note = document.createElement('div');
                        note.id = 'hint-note';
                        note.className = 'note-popup fade-in';
                        layer.appendChild(note);
                    }
                    note.style.left = '50%';
                    note.style.top = '30%';
                    note.style.transform = 'translate(-50%, -50%) rotate(-2deg)';
                    note.innerText = hintTxt;
                    note.onclick = () => note.remove();
                };

                quizBox.querySelector('#hint-1').onclick = () => showHint('Value03');
                if (data.Value04) quizBox.querySelector('#hint-2').onclick = () => showHint('Value04');
                if (data.Value05) quizBox.querySelector('#hint-3').onclick = () => showHint('Value05');
            },

            handleAniEffect(data) {
                const target = data.Value01 === 'all' ? document.getElementById('game-container') : (State.characters[data.Value01]?.el);
                if (target) {
                    target.classList.add(data.Value02);
                    setTimeout(() => target.classList.remove(data.Value02), (data.Value03 || 1) * 1000);
                }
            },

            playAudio(type, path, loop = false, delay = 0) {
                setTimeout(() => {
                    let aud = State.audio[type];
                    if (!aud) aud = new Audio();
                    aud.src = path;
                    aud.loop = loop;
                    aud.volume = (State.settings[type + 'Vol'] || 0.5);
                    aud.play().catch(e => console.log("Audio play blocked", e));
                }, delay * 1000);
            },

            stopAudio(type, fade = 0) {
                const aud = State.audio[type];
                if (!aud) return;
                if (fade > 0) {
                    let vol = aud.volume;
                    const interval = setInterval(() => {
                        vol -= 0.05;
                        if (vol <= 0) {
                            aud.pause();
                            clearInterval(interval);
                        } else aud.volume = vol;
                    }, fade * 100);
                } else aud.pause();
            },

            // --- UI ---
            toggleAuto() {
                if (State.isChoiceActive || State.isQuizActive) {
                    this.showAlert(this.t('UNAVAILABLE_INTERACTION'));
                    return;
                }
                State.settings.autoMode = !State.settings.autoMode;
                document.getElementById('auto-btn').innerText = `AUTO: ${State.settings.autoMode ? 'ON' : 'OFF'}`;
                if (State.settings.autoMode && !State.isTextAnimating) {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) this.executeEvent(State.events[nextRelIdx].Index);
                }
            },
            toggleBacklog() {
                const modal = document.getElementById('backlog-modal');
                const content = document.getElementById('backlog-content');
                if (modal.classList.contains('hidden')) {
                    content.innerHTML = State.backlog.map(item => {
                        if (item.type === 'choice') {
                            const choiceHtml = item.choices.map((c, idx) => `
                                <div class="${idx === item.selectedIndex ? 'backlog-choice-selected' : 'backlog-choice-unselected'}">
                                    ${idx === item.selectedIndex ? '▶ ' : '　 '}${c}
                                </div>
                            `).join('');
                            return `
                                <div class="border-b border-white/5 pb-4 space-y-2">
                                    <div class="text-accent-gold font-bold mr-4 text-sm opacity-50">[DECISION]</div>
                                    <div class="pl-4 border-l-2 border-white/10">${choiceHtml}</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="border-b border-white/5 pb-4">
                                    <span class="text-accent-gold font-bold mr-4">[${item.name || 'SYSTEM'}]</span>
                                    <span>${item.text}</span>
                                </div>
                            `;
                        }
                    }).join('');
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },
            showSettings() { this.showOptions(); },

            showOptions() {
                const modal = document.getElementById('options-modal');
                modal.classList.remove('hidden');
                document.getElementById('options-header').innerText = this.t('OPTIONS');
                this.switchTab('sound');
            },

            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
            },

            switchTab(tab) {
                document.getElementById('tab-sound').classList.toggle('active', tab === 'sound');
                document.getElementById('tab-display').classList.toggle('active', tab === 'display');
                const content = document.getElementById('tab-content');
                content.innerHTML = '';

                if (tab === 'sound') {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <span>${this.t('MASTER_MUTE')}</span>
                                <input type="checkbox" onchange="Engine.updateSetting('masterMute', this.checked)" ${State.audio.masterMute ? 'checked' : ''} class="w-8 h-8">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('BGM_VOL')}</span><span>${Math.round(State.settings.bgmVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('bgmVol', this.value/100)" value="${State.settings.bgmVol * 100}">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('SFX_VOL')}</span><span>${Math.round(State.settings.sfxVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('sfxVol', this.value/100)" value="${State.settings.sfxVol * 100}">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('VOICE_VOL')}</span><span>${Math.round(State.settings.voiceVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('voiceVol', this.value/100)" value="${State.settings.voiceVol * 100}">
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('TEXT_SPEED')}</span></div>
                                <input type="range" min="10" max="100" step="10" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('textSpeed', 110 - this.value)" value="${110 - State.settings.textSpeed}">
                            </div>
                            <div class="flex justify-between items-center">
                                <span>${this.t('AUTO_MODE_TITLE')}</span>
                                <input type="checkbox" onchange="Engine.updateSetting('autoMode', this.checked)" ${State.settings.autoMode ? 'checked' : ''} class="w-8 h-8">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('DIALOGUE_OPACITY')}</span><span>${Math.round(State.settings.opacity * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('opacity', this.value/100)" value="${State.settings.opacity * 100}">
                            </div>
                        </div>
                    `;
                }
            },

            updateSetting(key, val) {
                if (key === 'masterMute') {
                    State.audio.masterMute = val;
                } else if (State.settings.hasOwnProperty(key)) {
                    State.settings[key] = val;
                    if (key === 'opacity') {
                        document.getElementById('dialogue-box').style.opacity = val;
                    }
                }
                this.switchTab(document.getElementById('tab-sound').classList.contains('active') ? 'sound' : 'display');
            },

            showScore() {
                const modal = document.getElementById('score-modal');
                modal.classList.remove('hidden');
                document.getElementById('score-header').innerText = this.t('SCORE');

                const scores = JSON.parse(localStorage.getItem('aaa_scores') || '[]');
                const totalPlayers = scores.length;
                const totalTime = scores.reduce((acc, s) => acc + (s.time || 0), 0);

                document.getElementById('score-summary').innerHTML = `
                    <div><div class="text-sm opacity-50">${this.t('TOTAL_PLAYERS')}</div><div class="text-4xl font-bold">${totalPlayers}</div></div>
                    <div><div class="text-sm opacity-50">${this.t('TOTAL_TIME')}</div><div class="text-4xl font-bold">${Math.floor(totalTime / 60)}m ${totalTime % 60}s</div></div>
                `;

                document.getElementById('score-list').innerHTML = scores.slice(0, 10).map(s => `
                    <div class="flex justify-between bg-white/5 p-4 rounded-xl border border-white/10">
                        <span class="font-bold text-accent-gold">${s.name}</span>
                        <span class="opacity-70">${s.date}</span>
                        <span>${Math.floor(s.time / 60)}m ${s.time % 60}s</span>
                    </div>
                `).join('') || '<p class="text-center opacity-30 mt-10">NO DATA</p>';
            },

            showCredits() {
                document.getElementById('credits-modal').classList.remove('hidden');
            },

            showExit() {
                this.showConfirm(this.t('QUIT_CONFIRM'), () => {
                    window.close();
                });
            },

            toMenu() {
                this.showConfirm(this.t('QUIT_CONFIRM'), () => {
                    this.closeAllModals();
                    document.getElementById('menu-layer').style.display = 'block';
                    document.getElementById('menu-layer').classList.remove('fade-out');
                    document.getElementById('system-ui').classList.add('hidden');
                    document.getElementById('dialogue-layer').style.display = 'none';
                    document.getElementById('interaction-layer').innerHTML = '';
                    document.getElementById('character-layer').innerHTML = '';
                    document.getElementById('bgimage-layer').innerHTML = '';
                    document.getElementById('bgcolor-layer').style.backgroundColor = '#000';
                    document.getElementById('title-layer').innerHTML = '';

                    this.stopAudio('bgm');
                    this.stopAudio('amb');
                    this.stopAudio('voice');

                    State.currentIndex = 0;
                    State.characters = {};
                    State.settings.autoMode = false;
                    State.isInteractionWaiting = false;
                    State.isChoiceActive = false;
                    State.isQuizActive = false;
                    document.getElementById('auto-btn').innerText = `AUTO: OFF`;
                    this.updateTitleMenu();
                });
            },

            closeAllModals() {
                ['options-modal', 'score-modal', 'credits-modal', 'universal-confirm', 'universal-alert', 'backlog-modal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
            },

            showAlert(msg, cb) {
                const modal = document.getElementById('universal-alert');
                document.getElementById('alert-msg').innerText = msg;
                const btn = document.getElementById('alert-ok');
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    if (cb) cb();
                };
                modal.classList.remove('hidden');
            },

            showConfirm(msg, onYes, onNo) {
                const modal = document.getElementById('universal-confirm');
                document.getElementById('confirm-msg').innerText = msg;

                const yesBtn = document.getElementById('confirm-yes');
                const noBtn = document.getElementById('confirm-no');

                yesBtn.innerText = this.t('YES');
                noBtn.innerText = this.t('NO');

                yesBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onYes) onYes();
                };
                noBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onNo) onNo();
                };
                modal.classList.remove('hidden');
            },

            debug(msg) {
                console.log("[DEBUG]", msg);
            }
        }

        window.onload = () => Engine.init();
    </script>
</body>

</html>