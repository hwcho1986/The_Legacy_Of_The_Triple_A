<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Legacy Of The Triple A - 대괴도 AAA의 유산 v0.8.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="assets/js/data_loader.js"></script>
    <style>
        :root {
            --primary-red: #8b0000;
            --accent-gold: #c5a059;
            --bg-deep: #121212;
            --glass-bg: rgba(18, 18, 18, 0.85);
            --glass-border: rgba(197, 160, 89, 0.2);
            --text-main: #e0e0e0;
            --font-serif: 'Cinzel', 'Noto Serif KR', serif;
            --font-sans: 'Outfit', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-deep);
            font-family: var(--font-sans);
            color: var(--text-main);
            user-select: none;
            height: 100vh;
            /* Fallback for older browsers */
            height: 100dvh;
            /* Dynamic viewport height for mobile */
            width: 100vw;
        }

        #game-container {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #000;
            position: relative;
        }

        /* Layer System */
        .layer {
            position: absolute;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .layer-interactive {
            pointer-events: auto;
        }

        /* Effects & Animations */
        .fade-in {
            animation: fadeIn var(--duration, 1s) ease forwards;
        }

        .fade-out {
            animation: fadeOut var(--duration, 1s) ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        .shake {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translate(0, 0);
            }

            25% {
                transform: translate(-5px, 5px);
            }

            50% {
                transform: translate(5px, -5px);
            }

            75% {
                transform: translate(-5px, -5px);
            }
        }

        .blind-in {
            clip-path: inset(0 0 100% 0);
            animation: blindIn var(--duration, 1s) ease forwards;
        }

        @keyframes blindIn {
            to {
                clip-path: inset(0 0 0 0);
            }
        }

        /* Glassmorphism UI */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .premium-btn {
            background: linear-gradient(135deg, rgba(197, 160, 89, 0.1), transparent);
            border: 1px solid var(--glass-border);
            transition: all 0.4s cubic-bezier(0.2, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .premium-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(197, 160, 89, 0.2), transparent);
            transition: 0.5s;
        }

        .premium-btn:hover {
            background: rgba(197, 160, 89, 0.15);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(197, 160, 89, 0.2);
        }

        .premium-btn:hover::after {
            left: 100%;
        }

        /* Typewriter & Icon */
        .cursor-blink::after {
            content: '▼';
            margin-left: 8px;
            color: var(--accent-gold);
            animation: blink 0.8s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        /* Character Transitions & Framing */
        /* Character Transitions & Framing - Optimized for V-Rule */
        .char-container {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: auto;
            /* Height based ensures consistent "upper body" visibility on all aspect ratios */
            height: 85vh;
            max-height: 90vh;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            transition: left 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center center;
            pointer-events: none;
            z-index: 20;
            will-change: transform, left;

            /* Center-based generic positioning system */
            transform: translateX(-50%);

            --char-scale: 1;
            --char-y-offset: 0%;
        }

        .char-obj {
            height: 100% !important;
            width: auto !important;
            object-fit: contain;
            object-position: bottom center;
            filter: drop-shadow(0 10px 40px rgba(0, 0, 0, 0.9));
            pointer-events: none;
            display: block;

            transform: scale(var(--char-scale)) translateY(var(--char-y-offset));
            transform-origin: center center;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 768px) {
            .char-container {
                /* Mobile: Height slightly smaller to avoid header conflict, but still huge enough to show chest */
                height: 80vh;
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 0;
            }

            20% {
                opacity: 0.1;
            }

            80% {
                opacity: 0.1;
            }

            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .floating-shape {
            position: absolute;
            background: var(--accent-gold);
            pointer-events: none;
            z-index: 1;
            opacity: 0;
            animation: float 15s linear infinite;
        }

        .note-popup {
            position: absolute;
            background: #fff;
            color: #000;
            padding: 20px 40px;
            border-radius: 4px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.05);
            font-family: 'Noto Serif KR', serif;
            font-size: 1.25rem;
            z-index: 2200;
            /* 퀴즈 상단보다 위 */
            max-width: 300px;
            pointer-events: auto;
            cursor: pointer;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .note-popup::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(transparent, transparent 24px, rgba(0, 0, 0, 0.05) 25px);
            pointer-events: none;
        }

        /* Menu Selection */
        .menu-item.active,
        .menu-item:hover {
            color: var(--accent-gold);
            transform: scale(1.05);
            text-shadow: 0 0 25px rgba(197, 160, 89, 0.6);
            border-color: var(--accent-gold);
            background: rgba(197, 160, 89, 0.1);
        }

        .menu-item.active::before,
        .menu-item:hover::before {
            content: '▶';
            position: absolute;
            left: -30px;
            color: var(--accent-gold);
            animation: bounceLeft 0.5s infinite alternate;
        }

        @keyframes bounceLeft {
            from {
                transform: translateX(0);
            }

            to {
                transform: translateX(-10px);
            }
        }

        .backlog-choice-selected {
            color: #4ade80;
            font-weight: bold;
            text-decoration: underline;
        }

        .backlog-choice-unselected {
            text-decoration: line-through;
            opacity: 0.4;
        }

        /* Tabs */
        .tab-btn.active {
            border-bottom: 2px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Mobile Responsive Overrides */
        @media (max-width: 768px) {
            .text-8xl {
                font-size: 3.5rem !important;
            }

            .text-6xl {
                font-size: 2.25rem !important;
            }

            .text-3xl {
                font-size: 1.25rem !important;
            }

            .text-2xl {
                font-size: 1.1rem !important;
            }

            .p-20 {
                padding: 1.5rem !important;
            }

            .p-12 {
                padding: 1.25rem !important;
            }

            #main-menu-list {
                width: 90%;
            }

            #dialogue-box {
                padding: 1.5rem;
                bottom: 2rem;
                width: 95% !important;
                max-width: none !important;
            }

            #speaker-name {
                font-size: 1.2rem;
            }

            #dialogue-text {
                font-size: 1.1rem;
                min-height: 70px;
            }

            .modal-content {
                width: 95% !important;
                padding: 1.5rem !important;
            }

            .premium-btn {
                padding: 0.75rem !important;
            }

            .menu-item {
                font-size: 1.25rem !important;
                padding: 0.5rem 0 !important;
            }
        }

        /* Ambient Pattern */
        .ambient-pattern {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0l30 30-30 30L0 30z' fill-opacity='0.02' fill='%23c5a059' fill-rule='evenodd'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 5;
            opacity: 0.5;
        }

        #ambient-canvas {
            position: absolute;
            inset: 0;
            z-index: 15;
            /* Behind characters */
            pointer-events: none;
            mix-blend-mode: screen;
        }
    </style>
</head>

<body>
    <div id="game-container">
        <!-- Ambient Layers -->
        <div class="ambient-pattern"></div>
        <div id="shapes-container" class="layer" style="z-index: 2; pointer-events: none;"></div>
        <canvas id="ambient-canvas"></canvas>

        <!-- disclaimer -->
        <div id="disclaimer-layer" class="layer" style="z-index: 1000; background: #000; display: none;">
            <div class="flex items-center justify-center h-full p-20 text-center">
                <p id="disclaimer-text" class="text-2xl leading-loose font-serif max-w-4xl"></p>
            </div>
        </div>

        <!-- bgcolor -->
        <div id="bgcolor-layer" class="layer" style="z-index: 0; background-color: #000000;"></div>

        <!-- onbgimage (multiple) -->
        <div id="bgimage-layer" class="layer" style="z-index: 10;"></div>

        <!-- oncharacter -->
        <div id="character-layer" class="layer"
            style="z-index: 20; display: flex; align-items: flex-end; justify-content: center;">
        </div>

        <!-- dialogue / speak -->
        <div id="dialogue-layer" class="layer layer-interactive" style="z-index: 400; display: none;">
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 w-[95%] max-w-[1200px] glass p-10 rounded-2xl border-l-[6px] border-primary-red shadow-2xl"
                id="dialogue-box">
                <div id="speaker-name"
                    class="text-2xl font-bold text-accent-gold mb-3 tracking-widest uppercase border-b border-accent-gold/20 pb-2 inline-block">
                </div>
                <div id="dialogue-text" class="text-xl leading-relaxed font-serif min-h-[100px] text-white/90"></div>
                <div class="absolute bottom-4 right-6 text-accent-gold/30 text-xs tracking-widest font-sans uppercase">
                    A.A.A. Legacy System</div>
            </div>
        </div>

        <!-- oncolor / onimage -->
        <div id="overlay-layer" class="layer" style="z-index: 50;"></div>

        <!-- title / ontitle -->
        <div id="title-layer" class="layer" style="z-index: 70;"></div>

        <!-- Main Menu Layer -->
        <div id="menu-layer" class="layer layer-interactive" style="z-index: 600; background: #000; display: none;">
            <div class="flex flex-col items-center justify-center h-full space-y-12">
                <h1 id="title-logo"
                    class="text-6xl md:text-8xl font-cinzel text-accent-gold tracking-tighter fade-in text-center px-4"
                    style="--duration: 2s">THE
                    LEGACY OF<br><span class="text-white">THE TRIPLE A</span></h1>
                <div id="main-menu-list" class="flex flex-col space-y-4 w-full max-w-sm px-6">
                    <button data-menu="start"
                        class="menu-item premium-btn py-6 rounded-xl text-2xl font-bold tracking-widest text-white uppercase"></button>
                    <button data-menu="options"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                    <button data-menu="score"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                    <button data-menu="credits"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                    <button data-menu="exit"
                        class="menu-item premium-btn py-4 rounded-xl text-xl text-white/80 uppercase"></button>
                </div>
            </div>
        </div>

        <!-- interaction layer -->
        <div id="interaction-layer" class="layer layer-interactive" style="z-index: 450;"></div>

        <!-- onovercolor / offovercolor (highest overlay) -->
        <div id="cover-overlay-layer" class="layer" style="z-index: 600;"></div>

        <!-- System UI (Always on top) -->
        <div id="system-ui" class="absolute top-0 w-full p-3 md:p-6 flex justify-between items-center hidden"
            style="z-index: 500;">
            <button onclick="Engine.toggleBacklog()"
                class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm tracking-widest uppercase text-white">Log</button>
            <div class="flex gap-2 md:gap-4">
                <button onclick="Engine.toggleAuto()" id="auto-btn"
                    class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm text-white">AUTO:
                    OFF</button>
                <button onclick="Engine.showSettings()"
                    class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm text-white">SETTING</button>
                <button onclick="Engine.toMenu()"
                    class="premium-btn px-4 py-2 md:px-6 md:py-2 rounded-full text-xs md:text-sm text-white">EXIT</button>
            </div>
        </div>

        <!-- Modals -->
        <div id="options-modal" class="absolute inset-0 glass z-[2000] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest" id="options-header">OPTIONS</h2>
                <button onclick="Engine.closeModal('options-modal')" class="text-4xl">✕</button>
            </div>
            <div class="flex gap-10 mb-10">
                <button onclick="Engine.switchTab('sound')" id="tab-sound"
                    class="tab-btn text-2xl font-bold pb-2 active uppercase">Sound</button>
                <button onclick="Engine.switchTab('display')" id="tab-display"
                    class="tab-btn text-2xl font-bold pb-2 uppercase">Display</button>
            </div>
            <div id="tab-content" class="space-y-10 text-xl overflow-y-auto pr-4">
                <!-- Content injection -->
            </div>
        </div>

        <div id="score-modal" class="absolute inset-0 glass z-[2000] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest" id="score-header">SCOREBOARD</h2>
                <button onclick="Engine.closeModal('score-modal')" class="text-4xl">✕</button>
            </div>
            <div id="score-summary" class="grid grid-cols-2 gap-10 mb-10 p-8 bg-white/5 rounded-3xl text-center">
                <!-- Summary injection -->
            </div>
            <div id="score-list" class="flex-1 overflow-y-auto space-y-4 pr-4">
                <!-- List injection -->
            </div>
        </div>

        <div id="credits-modal"
            class="absolute inset-0 glass z-[2000] hidden flex flex-col items-center justify-center p-20">
            <div class="w-full max-w-4xl text-center space-y-20">
                <h2 class="text-6xl font-cinzel text-accent-gold" id="credits-header">CREDITS</h2>
                <div class="space-y-8 text-2xl leading-loose" id="credits-body">
                    <p><span class="opacity-50">Producer</span><br><b>Joe Choe</b></p>
                    <p><span class="opacity-50">Engine Development</span><br><b>Joe Choe</b></p>
                    <p><span class="opacity-50">Scenario & Design</span><br><b>Joe Choe</b></p>
                    <p><span class="opacity-50">Globalization</span><br><b>Joe Choe</b></p>
                </div>
                <button onclick="Engine.closeModal('credits-modal')"
                    class="premium-btn px-20 py-4 rounded-xl text-xl">CLOSE</button>
            </div>
        </div>

        <!-- Universal Confirm Modal -->
        <div id="universal-confirm"
            class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[2100] hidden flex items-center justify-center">
            <div class="glass p-12 rounded-3xl text-center space-y-10 max-w-2xl">
                <p id="confirm-msg" class="text-3xl leading-relaxed"></p>
                <div class="flex gap-6 justify-center">
                    <button id="confirm-yes"
                        class="premium-btn px-16 py-4 rounded-xl text-2xl bg-primary-red/20 border-primary-red uppercase">YES</button>
                    <button id="confirm-no" class="premium-btn px-16 py-4 rounded-xl text-2xl uppercase">NO</button>
                </div>
            </div>
        </div>

        <!-- Universal Alert Modal -->
        <div id="universal-alert"
            class="absolute inset-0 bg-black/80 backdrop-blur-sm z-[2100] hidden flex items-center justify-center">
            <div class="glass p-12 rounded-3xl text-center space-y-10 max-w-xl">
                <p id="alert-msg" class="text-3xl leading-relaxed"></p>
                <div class="flex justify-center">
                    <button id="alert-ok"
                        class="premium-btn px-20 py-4 rounded-xl text-2xl bg-accent-gold/20 border-accent-gold text-accent-gold uppercase">OK</button>
                </div>
            </div>
        </div>

        <div id="backlog-modal" class="absolute inset-0 glass z-[2000] hidden flex flex-col p-20">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-4">
                <h2 class="text-4xl font-cinzel tracking-widest">LOG</h2>
                <button onclick="Engine.closeModal('backlog-modal')" class="text-4xl">✕</button>
            </div>
            <div id="backlog-content" class="flex-1 overflow-y-auto space-y-6 pr-4 font-serif text-xl leading-relaxed">
                <!-- Log injection -->
            </div>
        </div>

        <!-- Debug Overlay -->
        <div id="debug-overlay"
            class="absolute top-20 right-6 w-80 p-4 glass rounded-xl text-xs font-mono text-red-400 hidden"
            style="z-index: 1000;"></div>
    </div>

    <script>
        const State = {
            lang: 'KO',
            currentIndex: 0,
            eventHistory: [],
            events: [],
            localization: {},
            backlog: [],
            characters: {},
            backgrounds: {},
            audio: {
                bgm: new Audio(),
                amb: new Audio(),
                sfx: new Audio(),
                voice: new Audio(),
                masterMute: false
            },
            settings: {
                textSpeed: 30, // 10, 30, 100
                autoMode: false,
                opacity: 0.8,
                bgmVol: 0.5,
                sfxVol: 0.5,
                voiceVol: 0.8
            },
            isTextAnimating: false,
            isInteractionWaiting: false,
            isChoiceActive: false,
            isQuizActive: false,
            currentEvent: null,
            currentVoice: null,
            stats: {
                hp: 100,
                keywords: [],
                startTime: null,
                totalTime: 0
            },
            menuIndex: 0,
            isNoteVisible: false
        };

        const Engine = {
            async init() {
                try {
                    // Set language from browser
                    const browserLang = navigator.language.slice(0, 2).toUpperCase();
                    const supported = ['KO', 'EN', 'JP', 'ES'];
                    const fullSupported = { 'zh-CN': 'CN_S', 'zh-TW': 'CN_T', 'zh-HK': 'CN_T' };

                    if (fullSupported[navigator.language]) State.lang = fullSupported[navigator.language];
                    else if (supported.includes(browserLang)) State.lang = browserLang;
                    else State.lang = 'KO';

                    if (fullSupported[navigator.language]) State.lang = fullSupported[navigator.language];
                    else if (supported.includes(browserLang)) State.lang = browserLang;
                    else State.lang = 'KO';

                    // Use DataLoader to fetch data (Google Sheets or Local fallback)
                    const data = await DataLoader.loadData();
                    State.events = data.events;
                    State.localization = data.localization;

                    // Key listeners
                    window.addEventListener('keydown', (e) => this.handleKeyDown(e));

                    document.getElementById('game-container').addEventListener('mousedown', (e) => {
                        this.handleMouseDown(e);
                    });

                    this.initAmbient();
                    this.showDisclaimer();

                } catch (e) {
                    this.debug(`Failed to load tables: ${e.message}`);
                }
            },

            initAmbient() {
                const canvas = document.getElementById('ambient-canvas');
                const ctx = canvas.getContext('2d');
                let w, h, particles = [];

                const resize = () => {
                    w = canvas.width = window.innerWidth;
                    h = canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', resize);
                resize();

                class Particle {
                    constructor() {
                        this.init();
                    }
                    init() {
                        this.x = Math.random() * w;
                        this.y = Math.random() * h;
                        this.size = Math.random() * 2 + 0.5;
                        this.speedX = Math.random() * 0.5 - 0.25;
                        this.speedY = Math.random() * 0.5 - 0.25;
                        this.opacity = Math.random() * 0.5;
                    }
                    update() {
                        this.x += this.speedX;
                        this.y += this.speedY;
                        if (this.x < 0 || this.x > w || this.y < 0 || this.y > h) this.init();
                    }
                    draw() {
                        ctx.fillStyle = `rgba(197, 160, 89, ${this.opacity})`;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                for (let i = 0; i < 50; i++) particles.push(new Particle());

                const animate = () => {
                    ctx.clearRect(0, 0, w, h);
                    particles.forEach(p => {
                        p.update();
                        p.draw();
                    });
                    requestAnimationFrame(animate);
                };
                animate();

                // Add geometric shapes
                const container = document.getElementById('shapes-container');
                for (let i = 0; i < 15; i++) {
                    const shape = document.createElement('div');
                    shape.className = 'floating-shape';
                    const size = Math.random() * 40 + 10;
                    shape.style.width = size + 'px';
                    shape.style.height = size + 'px';
                    shape.style.left = Math.random() * 100 + 'vw';
                    shape.style.top = '110vh';
                    shape.style.animationDelay = Math.random() * 20 + 's';
                    shape.style.clipPath = Math.random() > 0.5 ? 'polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)' : 'none';
                    container.appendChild(shape);
                }
            },

            showDisclaimer() {
                const layer = document.getElementById('disclaimer-layer');
                const text = document.getElementById('disclaimer-text');
                layer.style.display = 'block';
                text.innerHTML = this.formatText(this.t('DISCLAIMER'));
                text.classList.add('fade-in');

                setTimeout(() => {
                    text.classList.remove('fade-in');
                    text.classList.add('fade-out');
                    setTimeout(() => {
                        layer.classList.add('fade-out');
                        setTimeout(() => {
                            layer.style.display = 'none';
                            this.showTitle();
                        }, 1000);
                    }, 1000);
                }, 5000);
            },

            showTitle() {
                const layer = document.getElementById('menu-layer');
                layer.style.display = 'block';
                layer.classList.remove('fade-out');
                layer.classList.add('fade-in');
                this.updateTitleMenu();
            },

            updateTitleMenu() {
                const items = document.querySelectorAll('.menu-item');
                const keys = ['START_GAME', 'OPTIONS', 'SCORE', 'CREDITS', 'EXIT'];
                const actions = ['startGame', 'showOptions', 'showScore', 'showCredits', 'showExit'];

                items.forEach((item, i) => {
                    item.innerText = this.t(keys[i]);
                    item.classList.toggle('active', i === State.menuIndex);

                    // Mouse events
                    item.onclick = (e) => {
                        e.stopPropagation();
                        State.menuIndex = i;
                        this.executeMenuAction();
                    };
                    item.onmouseenter = () => {
                        State.menuIndex = i;
                        this.updateTitleMenu();
                    };
                });
            },

            handleKeyDown(e) {
                // Menu Navigation
                if (document.getElementById('menu-layer').style.display !== 'none' && !State.isInteractionWaiting) {
                    if (e.code === 'ArrowDown' || e.code === 'KeyS') {
                        State.menuIndex = (State.menuIndex + 1) % 5;
                        this.updateTitleMenu();
                    } else if (e.code === 'ArrowUp' || e.code === 'KeyW') {
                        State.menuIndex = (State.menuIndex - 1 + 5) % 5;
                        this.updateTitleMenu();
                    } else if (e.code === 'Enter' || e.code === 'Space') {
                        this.executeMenuAction();
                    }
                    return;
                }

                // Global interaction
                if (e.code === 'Space' || e.code === 'Enter') {
                    if (State.isInteractionWaiting) this.handleGlobalInteraction();
                }
            },

            handleMouseDown(e) {
                // Clicking center to advance
                if (State.isInteractionWaiting) {
                    const cx = window.innerWidth / 2;
                    const cy = window.innerHeight / 2;
                    const dist = Math.sqrt((e.clientX - cx) ** 2 + (e.clientY - cy) ** 2);
                    if (dist < 200) { // Center click
                        this.handleGlobalInteraction();
                        return;
                    }
                }

                if (State.isInteractionWaiting) this.handleGlobalInteraction();
            },

            executeMenuAction() {
                const actions = ['startGame', 'showOptions', 'showScore', 'showCredits', 'showExit'];
                this[actions[State.menuIndex]]();
            },

            startGame() {
                const menu = document.getElementById('menu-layer');
                menu.classList.add('fade-out');
                State.stats.startTime = Date.now();
                setTimeout(() => {
                    menu.style.display = 'none';
                    document.getElementById('system-ui').classList.remove('hidden');
                    this.executeEvent(State.events[0].Index);
                }, 1000);
            },

            t(key) {
                if (!key) return '';
                if (typeof key !== 'string') return JSON.stringify(key);
                // Remove quote stripping to allow quoted text display as requested
                // if (key.startsWith('"') && key.endsWith('"')) return key.slice(1, -1);
                if (State.localization[key]) {
                    const entry = State.localization[key];
                    return entry[State.lang] || entry['KO'] || entry['EN'] || key;
                }
                return key;
            },

            formatText(str) {
                if (!str) return '';
                let formatted = str.replace(/\/n|\\n/g, '<br>');
                // 색상 태그 처리: [#RRGGBB][텍스트][-] 또는 [RRGGBB][텍스트][-] 형식
                formatted = formatted.replace(/\[(#?[A-Za-z0-9]+)\](.*?)\[-\]/g, (match, p1, p2) => {
                    // #이 이미 포함되어 있으면 그대로 사용, 6자리 hex면 # 추가
                    let color = p1;
                    if (p1.startsWith('#')) {
                        color = p1; // #ff0000 형식
                    } else if (/^[0-9A-Fa-f]{6}$/.test(p1)) {
                        color = `#${p1}`; // ff0000 형식 -> #ff0000
                    }
                    // 그 외는 색상 이름으로 간주 (red, blue 등)
                    return `<span style="color: ${color}">${p2}</span>`;
                });
                return formatted;
            },

            async executeEvent(index) {
                const event = State.events.find(e => e.Index === index);
                if (!event) {
                    this.debug(`Index ${index} not found`);
                    return;
                }
                const currentRelIdx = State.events.indexOf(event);
                State.currentIndex = currentRelIdx;

                console.log("Executing:", event.type, event);

                // Auto-clear title layer when moving to a new non-title event
                if (event.type !== 'title' && event.type !== 'ontitle') {
                    document.getElementById('title-layer').innerHTML = '';
                }

                switch (event.type) {
                    case 'bgcolor':
                        const bgLayer = document.getElementById('bgcolor-layer');
                        bgLayer.style.transition = `background-color ${event.Value02 || 0}s`;
                        bgLayer.style.backgroundColor = event.Value01 || '#000000';
                        this.next(event.Index, 'Read');
                        break;

                    case 'onbgimage':
                        this.handleBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgimage':
                        this.handleOffBGImage(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'oncharacter':
                        this.handleCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcharacter':
                        this.handleOffCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onspeak':
                        this.handleOnSpeak(event);
                        break;

                    case 'offspeak':
                        this.handleOffSpeak(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'oncolor':
                        this.handleOverlayColor(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offcolor':
                        this.handleOverlayColor(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onimage':
                        this.handleOverlayImage(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offimage':
                        this.handleOverlayImage(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onovercolor':
                        this.handleCoverOverlayColor(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offovercolor':
                        this.handleCoverOverlayColor(event, false);
                        this.next(event.Index, 'Read');
                        break;

                    case 'title':
                        this.handleTitle(event);
                        break;

                    case 'ontitle':
                        this.handleTitle(event, true);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offtitle':
                        document.getElementById('title-layer').innerHTML = '';
                        this.next(event.Index, 'Read');
                        break;

                    case 'choice':
                        this.handleChoice(event);
                        break;

                    case 'quiz01':
                        this.handleQuiz(event);
                        break;

                    case 'onbgm':
                        this.playAudio('bgm', event.Value01, event.Value02 === 'loop', event.Value03);
                        this.next(event.Index, 'Read');
                        break;

                    case 'offbgm':
                        this.stopAudio('bgm', event.Value01);
                        this.next(event.Index, 'Read');
                        break;

                    case 'jump':
                        this.executeEvent(parseInt(event.Value01));
                        break;

                    case 'onamb':
                        this.playAudio('amb', event.Value01, true, event.Value03); // Loop default for AMB
                        this.next(event.Index, 'Read');
                        break;

                    case 'offamb':
                        this.stopAudio('amb', event.Value01);
                        this.next(event.Index, 'Read');
                        break;

                    case 'onsfx':
                    case 'sdx': // Fallback for typo in user request
                        this.playAudio('sfx', event.Value01, false, event.Value03);
                        this.next(event.Index, 'Read');
                        break;

                    case 'Wait':
                        setTimeout(() => this.next(event.Index, 'Read'), parseFloat(event.Value01 || 0) * 1000);
                        break;

                    case 'anieffect':
                        this.handleAniEffect(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'move':
                        this.handleMove(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'editcharacter':
                        this.handleEditCharacter(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'transform':
                        this.handleTransform(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'gifeffect':
                        this.handleGifEffect(event);
                        this.next(event.Index, 'Read');
                        break;

                    case 'next':
                        this.initNextChapter(event.Value01);
                        break;

                    case 'end':
                        this.showAlert(this.t('END_OF_CHAPTER'), () => location.reload());
                        break;

                    default:
                        this.debug(`Unknown type: ${event.type}`);
                        this.next(event.Index, 'Read');
                }
            },

            next(index, mode) {
                if (mode === 'Read') {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) {
                        this.executeEvent(State.events[nextRelIdx].Index);
                    }
                }
            },

            // --- Handlers ---
            handleBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const img = document.createElement('img');
                img.src = data.Value01;
                img.className = `layer object-cover w-full h-full fade-in`;
                img.style.setProperty('--duration', `${data.Value03 || 0}s`);
                img.dataset.num = data.Value04 || 1;

                layer.appendChild(img);
                const sorted = [...layer.querySelectorAll('img')].sort((a, b) => b.dataset.num - a.dataset.num);
                layer.innerHTML = '';
                sorted.forEach(el => layer.appendChild(el));
            },

            handleOffBGImage(data) {
                const layer = document.getElementById('bgimage-layer');
                const target = layer.querySelector(`img[data-num="${data.Value01}"]`);
                if (target) {
                    target.classList.add('fade-out');
                    setTimeout(() => target.remove(), (data.Value03 || 0.5) * 1000);
                }
            },

            handleCharacter(data) {
                const layer = document.getElementById('character-layer');
                let char = State.characters[data.Value01];
                if (!char) {
                    const container = document.createElement('div');
                    container.className = 'char-container';

                    // Wrapper for effects (shake etc) to avoid conflict with positioning
                    const wrapper = document.createElement('div');
                    wrapper.className = 'char-effect-wrap';
                    wrapper.style.width = '100%';
                    wrapper.style.height = '100%';
                    wrapper.style.display = 'flex';
                    wrapper.style.alignItems = 'flex-end';
                    wrapper.style.justifyContent = 'center';

                    const el = document.createElement('img');
                    el.className = 'char-obj';

                    wrapper.appendChild(el);
                    container.appendChild(wrapper);
                    layer.appendChild(container);

                    char = { el: container, wrapper: wrapper, img: el, id: data.Value01 };
                    State.characters[data.Value01] = char;
                }

                const imgPath = data.Value02 && data.Value02 !== 'normal' ?
                    `assets/images/character/${data.Value01}_${data.Value02}.png` :
                    `assets/images/character/${data.Value01}.png`;

                char.img.src = imgPath;

                // X좌표 설정 (반응형 대응)
                let pos = data.Value03 || '50%';
                // Normalize keywords to percentages
                if (pos === 'center') pos = '50%';
                if (pos === 'left') pos = '15%'; // More strict on mobile
                if (pos === 'right') pos = '85%';

                // PC override for wider spacing if needed, but percentages work well generally
                if (window.innerWidth > 768) {
                    if (pos === '15%') pos = '20%';
                    if (pos === '85%') pos = '80%';
                }

                char.el.style.left = pos;

                if (data.Value04 === 'fadein') {
                    char.el.classList.add('fade-in');
                    char.el.style.setProperty('--duration', `${data.Value05 || 1}s`);
                }
            },
            handleOffCharacter(data) {
                const char = State.characters[data.Value01];
                if (char) {
                    char.el.classList.add('fade-out');
                    setTimeout(() => {
                        char.el.remove();
                        delete State.characters[data.Value01];
                    }, (data.Value05 || 0.5) * 1000);
                }
            },

            handleOnSpeak(data) {
                const layer = document.getElementById('dialogue-layer');
                const speaker = document.getElementById('speaker-name');
                const text = document.getElementById('dialogue-text');
                const box = document.getElementById('dialogue-box');

                layer.style.display = 'block';
                layer.classList.remove('fade-out');
                layer.style.opacity = '1';

                const nameStr = this.t(data.Value02);
                speaker.innerText = nameStr;

                // Highlight character (CSS 변수 활용하여 기존 변환 상태 유지)
                Object.values(State.characters).forEach(c => {
                    if (c.id === data.Value01) {
                        c.el.style.setProperty('--char-scale', '1.05'); // Active speaker slight zoom
                        c.el.style.setProperty('--char-y-offset', '0%');
                        c.el.style.filter = 'brightness(1.1) drop-shadow(0 0 30px rgba(197, 160, 89, 0.4))';
                        c.el.style.zIndex = '30';
                    } else {
                        c.el.style.setProperty('--char-scale', '0.95');
                        c.el.style.setProperty('--char-y-offset', '2%'); // Inactive slightly down
                        c.el.style.filter = 'brightness(0.5) constrast(1.2)';
                        c.el.style.zIndex = '20';
                    }
                });

                const content = this.t(data.Value03);
                State.backlog.push({ name: nameStr, text: content });

                this.typeText(text, content, () => {
                    if (State.settings.autoMode) {
                        const autoWait = 1000 + (content.length * 50);
                        setTimeout(() => {
                            if (State.settings.autoMode && !State.isTextAnimating) this.next(data.Index, 'Read');
                        }, autoWait);
                    }
                });

                if (data.Value04) {
                    this.playAudio('voice', data.Value04);
                }

                State.isInteractionWaiting = true;
                State.currentEvent = data;
            },

            handleOffSpeak(data) {
                const layer = document.getElementById('dialogue-layer');
                const duration = data.Value01 || 0.5;
                layer.style.setProperty('--duration', `${duration}s`);
                layer.classList.add('fade-out');
                setTimeout(() => {
                    layer.style.display = 'none';
                    layer.classList.remove('fade-out');
                }, duration * 1000);
            },

            handleGlobalInteraction() {
                if (State.isTextAnimating) {
                    State.isTextAnimating = false;
                } else if (State.isInteractionWaiting) {
                    State.isInteractionWaiting = false;
                    this.next(State.currentEvent.Index, 'Read');
                }
            },

            typeText(el, str, cb) {
                el.innerHTML = '';
                el.classList.remove('cursor-blink');
                State.isTextAnimating = true;

                let formatted = this.formatText(str);

                // 모든 일반 텍스트 문자를 개별 스판으로 래핑하여 초기에는 숨김 처리
                const temp = document.createElement('div');
                temp.innerHTML = formatted;

                const wrapLetters = (node) => {
                    if (node.nodeType === 3) {
                        const text = node.textContent;
                        const fragment = document.createDocumentFragment();
                        for (let char of text) {
                            const span = document.createElement('span');
                            span.style.opacity = '0';
                            span.style.transition = 'opacity 0.1s';
                            span.className = 'typing-char';
                            span.textContent = char;
                            fragment.appendChild(span);
                        }
                        node.parentNode.replaceChild(fragment, node);
                    } else if (node.nodeType === 1) {
                        Array.from(node.childNodes).forEach(wrapLetters);
                    }
                };
                wrapLetters(temp);
                el.innerHTML = temp.innerHTML;

                const chars = el.querySelectorAll('.typing-char');
                let i = 0;
                const speeds = { slow: 100, normal: 30, fast: 10 };
                const speed = speeds[State.settings.textSpeed] || 30;

                const timer = setInterval(() => {
                    if (!State.isTextAnimating) {
                        chars.forEach(c => c.style.opacity = '1');
                        clearInterval(timer);
                        el.classList.add('cursor-blink');
                        cb();
                        return;
                    }

                    if (i < chars.length) {
                        chars[i++].style.opacity = '1';
                    } else {
                        clearInterval(timer);
                        State.isTextAnimating = false;
                        el.classList.add('cursor-blink');
                        cb();
                    }
                }, speed);
            },

            handleOverlayColor(data, on) {
                const layer = document.getElementById('overlay-layer');
                if (on) {
                    layer.style.pointerEvents = 'auto';
                    const el = document.createElement('div');
                    el.className = 'layer fade-in';
                    el.style.backgroundColor = data.Value01;
                    const opacityStr = data.Value03 || '100%';
                    el.style.opacity = opacityStr.includes('%') ? parseInt(opacityStr) / 100 : opacityStr;
                    el.style.setProperty('--duration', `${data.Value02 || 0.5}s`);
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                    layer.style.pointerEvents = 'none';
                }
            },

            handleOverlayImage(data, on) {
                const layer = document.getElementById('overlay-layer');
                if (on) {
                    const el = document.createElement('img');
                    el.src = data.Value01;
                    el.className = 'absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 fade-in';
                    if (data.Value02) {
                        const parts = String(data.Value02).split(',');
                        if (parts.length === 2) {
                            el.style.width = parts[0] + 'px';
                            el.style.height = parts[1] + 'px';
                        }
                    }
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                }
            },

            handleCoverOverlayColor(data, on) {
                const layer = document.getElementById('cover-overlay-layer');
                if (on) {
                    layer.style.pointerEvents = 'auto';
                    const el = document.createElement('div');
                    el.className = 'layer fade-in';
                    el.style.backgroundColor = data.Value01;
                    const opacityStr = data.Value03 || '100%';
                    el.style.opacity = opacityStr.includes('%') ? parseInt(opacityStr) / 100 : opacityStr;
                    el.style.setProperty('--duration', `${data.Value02 || 0.5}s`);
                    layer.appendChild(el);
                } else {
                    layer.innerHTML = '';
                    layer.style.pointerEvents = 'none';
                }
            },

            handleTitle(data, keep = false) {
                const layer = document.getElementById('title-layer');
                layer.innerHTML = ''; // Fix stacking

                const el = document.createElement('div');
                el.className = 'absolute inset-0 flex items-center justify-center text-center p-10 md:p-20 z-10';
                el.style.whiteSpace = 'pre-wrap'; // Preserve spaces
                el.style.fontFamily = data.Value01 || 'Cinzel, serif';
                el.style.fontSize = `clamp(1.5rem, ${(data.Value02 || 48) / 19.2}vw, 8rem)`;
                el.style.color = data.Value03 || '#fff';
                el.innerText = '';

                layer.appendChild(el);

                const titleText = this.t(data.Value04);

                // Log title
                State.backlog.push({ name: 'TITLE', text: titleText });

                this.typeText(el, titleText, () => {
                    if (!keep) {
                        State.isInteractionWaiting = true;
                        State.currentEvent = data;

                        if (State.settings.autoMode) {
                            const autoWait = 2000;
                            setTimeout(() => {
                                if (State.settings.autoMode && State.isInteractionWaiting && State.currentEvent === data) {
                                    this.handleGlobalInteraction();
                                }
                            }, autoWait);
                        }
                    }
                });
            },

            handleChoice(data) {
                // Force Auto-off and block it
                State.settings.autoMode = false;
                State.isChoiceActive = true;
                document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                const layer = document.getElementById('interaction-layer');
                const container = document.createElement('div');
                container.className = 'flex flex-col gap-6 items-center justify-center h-full bg-black/40';

                const choices = [];
                choices.push({ text: this.t(data.Value01), target: data.Value02 });
                if (data.Value03) choices.push({ text: this.t(data.Value03), target: data.Value04 });

                const addBtn = (choice, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'premium-btn glass px-20 py-8 rounded-2xl text-2xl w-[600px] text-white';
                    btn.innerText = choice.text;
                    btn.onclick = () => {
                        State.isChoiceActive = false; // Reset flag

                        // Record to backlog with selection info
                        State.backlog.push({
                            type: 'choice',
                            choices: choices.map(c => c.text),
                            selectedIndex: idx
                        });

                        layer.innerHTML = '';
                        this.executeEvent(choice.target);
                    };
                    container.appendChild(btn);
                };

                choices.forEach((c, idx) => addBtn(c, idx));
                layer.appendChild(container);
            },

            handleQuiz(data) {
                // Force Auto-off and block it
                State.settings.autoMode = false;
                State.isQuizActive = true;

                // Log Quiz
                const qText = this.t(data.Value01);
                State.backlog.push({ name: 'QUIZ', text: qText });

                document.getElementById('auto-btn').innerText = `AUTO: OFF`;

                const layer = document.getElementById('interaction-layer');
                layer.innerHTML = '';
                const quizBox = document.createElement('div');
                quizBox.className = 'absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm';
                quizBox.innerHTML = `
                    <div class="glass p-6 md:p-12 rounded-[2rem] md:rounded-[3rem] w-[95%] md:w-[800px] text-center">
                        <div class="text-sm md:text-xl opacity-60 mb-4 md:mb-8 border-b border-white/10 pb-2 md:pb-4 tracking-[0.3em] md:tracking-[0.5em]">QUERY NODE</div>
                        <div class="text-xl md:text-3xl mb-8 md:mb-12 font-serif">${this.t(data.Value01)}</div>
                        <input id="quiz-input" autocomplete="off" class="w-full bg-white/5 border border-white/20 p-4 md:p-6 rounded-xl text-xl md:text-3xl mb-6 md:mb-8 focus:border-accent-gold outline-none text-center" placeholder="...">
                        <div class="flex gap-2 md:gap-4 mb-6 md:mb-8">
                            <button id="hint-1" class="premium-btn p-3 md:p-4 rounded-xl flex-1 text-[10px] md:text-xs text-white">HINT 1</button>
                            ${data.Value04 ? `<button id="hint-2" class="premium-btn p-3 md:p-4 rounded-xl flex-1 text-[10px] md:text-xs text-white">HINT 2</button>` : ''}
                            ${data.Value05 ? `<button id="hint-3" class="premium-btn p-3 md:p-4 rounded-xl flex-1 text-[10px] md:text-xs text-white">HINT 3</button>` : ''}
                        </div>
                        <button id="quiz-submit" class="premium-btn w-full p-4 md:p-6 rounded-xl text-lg md:text-2xl bg-primary-red/20 border-primary-red text-white">EXECUTE</button>
                    </div>
                `;
                layer.appendChild(quizBox);

                const input = quizBox.querySelector('#quiz-input');
                input.focus();

                const answers = Array.isArray(data.Value02) ? data.Value02 : [data.Value02];

                const check = () => {
                    const val = input.value.toLowerCase().replace(/\s/g, '');
                    const isCorrect = answers.some(a => String(a).toLowerCase().replace(/\s/g, '') === val);
                    if (isCorrect) {
                        State.isQuizActive = false; // Reset flag
                        layer.innerHTML = '';
                        this.next(data.Index, 'Read');
                    } else {
                        quizBox.querySelector('.glass').classList.add('shake');
                        setTimeout(() => quizBox.querySelector('.glass').classList.remove('shake'), 500);
                        input.value = '';
                    }
                };

                quizBox.querySelector('#quiz-submit').onclick = check;
                input.onkeydown = (e) => { if (e.key === 'Enter') check(); };

                const showHint = (hintKey) => {
                    const hintTxt = this.t(data[hintKey]);
                    if (!hintTxt) return;

                    let note = document.getElementById('hint-note');
                    if (!note) {
                        note = document.createElement('div');
                        note.id = 'hint-note';
                        note.className = 'note-popup fade-in';
                        layer.appendChild(note);
                    }
                    note.style.left = '50%';
                    note.style.top = '30%';
                    note.style.transform = 'translate(-50%, -50%) rotate(-2deg)';
                    note.innerText = hintTxt;
                    note.onclick = () => note.remove();
                };

                quizBox.querySelector('#hint-1').onclick = () => showHint('Value03');
                if (data.Value04) quizBox.querySelector('#hint-2').onclick = () => showHint('Value04');
                if (data.Value05) quizBox.querySelector('#hint-3').onclick = () => showHint('Value05');
            },

            handleAniEffect(data) {
                // 특정 캐릭터 래퍼(wrapper) 또는 전체 컨테이너에 효과 적용
                const target = data.Value01 === 'all' ?
                    document.getElementById('game-container') :
                    State.characters[data.Value01]?.wrapper; // 래퍼에 적용하여 위치(container)와 분리

                if (target) {
                    target.classList.add(data.Value02);
                    setTimeout(() => target.classList.remove(data.Value02), (data.Value03 || 1) * 1000);
                }
            },

            handleMove(data) {
                const char = State.characters[data.Value01];
                if (!char) return;

                let pos = data.Value02 || '50%';
                if (pos === 'center') pos = '50%';
                else if (pos === 'left') pos = '20%';
                else if (pos === 'right') pos = '80%';

                const duration = parseFloat(data.Value03 || 1);

                // wrapper 이동
                if (char.wrapper) {
                    char.wrapper.style.transition = `left ${duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
                    char.wrapper.style.left = pos;
                } else if (char.div) {
                    // Fallback if wrapper property name differs (initially it was div)
                    char.div.style.transition = `left ${duration}s cubic-bezier(0.4, 0, 0.2, 1)`;
                    char.div.style.left = pos;
                }
            },

            handleEditCharacter(data) {
                const charId = data.Value01;
                const newExpr = data.Value02; // Image path
                const color = data.Value03; // Hex color for overlay
                const duration = parseFloat(data.Value04 || 0);

                if (!charId || !State.characters[charId]) return;

                const charObj = State.characters[charId];
                const imgEl = charObj.img;
                const wrapperEl = charObj.wrapper || charObj.div;

                // 1. Change Expression (Image)
                if (newExpr) {
                    if (duration > 0) {
                        imgEl.style.transition = `opacity ${duration}s`;
                        const tempImg = new Image();
                        tempImg.src = newExpr;
                        tempImg.onload = () => {
                            imgEl.style.opacity = 0;
                            setTimeout(() => {
                                imgEl.src = newExpr;
                                imgEl.style.opacity = 1;
                            }, duration * 1000);
                        };
                    } else {
                        imgEl.src = newExpr;
                    }
                }

                // 2. Color Overlay
                if (color) {
                    let existingOverlay = wrapperEl.querySelector('.char-overlay');
                    if (existingOverlay) existingOverlay.remove();

                    const overlay = document.createElement('div');
                    overlay.className = 'char-overlay absolute inset-0 pointer-events-none';
                    overlay.style.backgroundColor = color;
                    overlay.style.transition = `opacity ${duration}s ease`;
                    overlay.style.opacity = 0;

                    overlay.style.webkitMaskImage = `url("${imgEl.src}")`;
                    overlay.style.webkitMaskRepeat = 'no-repeat';
                    overlay.style.webkitMaskPosition = 'bottom center';
                    overlay.style.webkitMaskSize = 'contain';

                    wrapperEl.appendChild(overlay);

                    // Force reflow
                    overlay.offsetHeight;
                    overlay.style.opacity = 1;
                }
            },

            handleTransform(data) {
                const targetType = data.Value01;
                const scaleVal = data.Value02;
                const duration = parseFloat(data.Value04 || 0);

                let targets = [];

                if (targetType === 'all') {
                    Object.values(State.characters).forEach(c => targets.push(c.wrapper || c.div));
                    const title = document.getElementById('title-layer').firstChild;
                    if (title) targets.push(title);
                    const overlay = document.getElementById('overlay-layer').firstChild;
                    if (overlay) targets.push(overlay);
                    const dialogue = document.getElementById('dialogue-box');
                    if (dialogue) targets.push(dialogue);
                } else if (targetType === 'allcharacter') {
                    Object.values(State.characters).forEach(c => targets.push(c.wrapper || c.div));
                } else if (targetType === 'ontitle') {
                    const title = document.getElementById('title-layer').firstChild;
                    if (title) targets.push(title);
                } else if (targetType === 'onimage') {
                    const overlay = document.getElementById('overlay-layer').firstChild;
                    if (overlay) targets.push(overlay);
                } else {
                    if (State.characters[targetType]) {
                        targets.push(State.characters[targetType].wrapper || State.characters[targetType].div);
                    }
                }

                let transformStr = '';
                if (scaleVal.includes('%')) {
                    const scale = parseFloat(scaleVal) / 100;
                    transformStr = `scale(${scale})`;
                } else if (scaleVal.includes('(') && scaleVal.includes(',')) {
                    const parts = scaleVal.replace(/[()]/g, '').split(',');
                    if (parts.length === 2) {
                        transformStr = `scale(${parts[0].trim()}, ${parts[1].trim()})`;
                    }
                } else {
                    const n = parseFloat(scaleVal);
                    if (!isNaN(n)) transformStr = `scale(${n})`;
                }

                if (!transformStr) return;

                targets.forEach(el => {
                    if (el.classList.contains('char-container')) {
                        const img = el.querySelector('.char-obj');
                        if (img) {
                            img.style.transition = `transform ${duration}s ease`;
                            img.style.transform = `${transformStr} translateY(var(--char-y-offset, 0%))`;
                        }
                    } else {
                        el.style.transition = `transform ${duration}s ease`;
                        el.style.transform = transformStr;
                    }
                });
            },

            handleGifEffect(data) {
                const char = State.characters[data.Value01];
                if (!char) return;

                const gif = document.createElement('img');
                gif.src = data.Value02;
                // 캐릭터 컨테이너의 정중앙에 배치되도록 스타일 설정 (모바일 스택 상속)
                gif.className = 'absolute pointer-events-none z-50';
                gif.style.left = '50%';
                gif.style.bottom = '50%';
                gif.style.transform = 'translate(-50%, 50%)';

                // 크기 조절 (Value03: 너비, Value04: 높이 또는 배율)
                if (data.Value03) gif.style.width = data.Value03;
                if (data.Value04) gif.style.height = data.Value04;

                char.el.appendChild(gif);

                if (data.Value05) {
                    setTimeout(() => gif.remove(), data.Value05 * 1000);
                } else {
                    // 기본 2초 후 제거
                    setTimeout(() => gif.remove(), 2000);
                }
            },

            playAudio(type, path, loop = false, delay = 0) {
                setTimeout(() => {
                    let aud = State.audio[type];
                    if (!aud) aud = new Audio();
                    aud.src = path;
                    aud.loop = loop;
                    aud.volume = (State.settings[type + 'Vol'] || 0.5);
                    aud.play().catch(e => console.log("Audio play blocked", e));
                }, delay * 1000);
            },

            stopAudio(type, fade = 0) {
                const aud = State.audio[type];
                if (!aud) return;
                if (fade > 0) {
                    let vol = aud.volume;
                    const interval = setInterval(() => {
                        vol -= 0.05;
                        if (vol <= 0) {
                            aud.pause();
                            clearInterval(interval);
                        } else aud.volume = vol;
                    }, fade * 100);
                } else aud.pause();
            },

            // --- UI ---
            toggleAuto() {
                if (State.isChoiceActive || State.isQuizActive) {
                    this.showAlert(this.t('UNAVAILABLE_INTERACTION'));
                    return;
                }
                State.settings.autoMode = !State.settings.autoMode;
                document.getElementById('auto-btn').innerText = `AUTO: ${State.settings.autoMode ? 'ON' : 'OFF'}`;
                if (State.settings.autoMode && !State.isTextAnimating) {
                    const nextRelIdx = State.currentIndex + 1;
                    if (nextRelIdx < State.events.length) this.executeEvent(State.events[nextRelIdx].Index);
                }
            },
            toggleBacklog() {
                const modal = document.getElementById('backlog-modal');
                const content = document.getElementById('backlog-content');
                if (modal.classList.contains('hidden')) {
                    content.innerHTML = State.backlog.map(item => {
                        if (item.type === 'choice') {
                            const choiceHtml = item.choices.map((c, idx) => `
                                <div class="${idx === item.selectedIndex ? 'backlog-choice-selected' : 'backlog-choice-unselected'}">
                                    ${idx === item.selectedIndex ? '▶ ' : '　 '}${c}
                                </div>
                            `).join('');
                            return `
                                <div class="border-b border-white/5 pb-4 space-y-2">
                                    <div class="text-accent-gold font-bold mr-4 text-sm opacity-50">[DECISION]</div>
                                    <div class="pl-4 border-l-2 border-white/10">${choiceHtml}</div>
                                </div>
                            `;
                        } else {
                            return `
                                <div class="border-b border-white/5 pb-4">
                                    <span class="text-accent-gold font-bold mr-4">[${item.name || 'SYSTEM'}]</span>
                                    <span>${item.text}</span>
                                </div>
                            `;
                        }
                    }).join('');
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            },
            showSettings() { this.showOptions(); },

            showOptions() {
                const modal = document.getElementById('options-modal');
                modal.classList.remove('hidden');
                document.getElementById('options-header').innerText = this.t('OPTIONS');
                this.switchTab('sound');
            },

            closeModal(id) {
                document.getElementById(id).classList.add('hidden');
            },

            switchTab(tab) {
                document.getElementById('tab-sound').classList.toggle('active', tab === 'sound');
                document.getElementById('tab-display').classList.toggle('active', tab === 'display');
                const content = document.getElementById('tab-content');
                content.innerHTML = '';

                if (tab === 'sound') {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="flex justify-between items-center">
                                <span>${this.t('MASTER_MUTE')}</span>
                                <input type="checkbox" onchange="Engine.updateSetting('masterMute', this.checked)" ${State.audio.masterMute ? 'checked' : ''} class="w-8 h-8">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('BGM_VOL')}</span><span>${Math.round(State.settings.bgmVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('bgmVol', this.value/100)" value="${State.settings.bgmVol * 100}">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('SFX_VOL')}</span><span>${Math.round(State.settings.sfxVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('sfxVol', this.value/100)" value="${State.settings.sfxVol * 100}">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('VOICE_VOL')}</span><span>${Math.round(State.settings.voiceVol * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('voiceVol', this.value/100)" value="${State.settings.voiceVol * 100}">
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="space-y-6">
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('TEXT_SPEED')}</span></div>
                                <input type="range" min="10" max="100" step="10" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('textSpeed', 110 - this.value)" value="${110 - State.settings.textSpeed}">
                            </div>
                            <div class="flex justify-between items-center">
                                <span>${this.t('AUTO_MODE_TITLE')}</span>
                                <input type="checkbox" onchange="Engine.updateSetting('autoMode', this.checked)" ${State.settings.autoMode ? 'checked' : ''} class="w-8 h-8">
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between"><span>${this.t('DIALOGUE_OPACITY')}</span><span>${Math.round(State.settings.opacity * 100)}%</span></div>
                                <input type="range" class="w-full h-2 bg-white/20 rounded-lg accent-gold" oninput="Engine.updateSetting('opacity', this.value/100)" value="${State.settings.opacity * 100}">
                            </div>
                        </div>
                    `;
                }
            },

            updateSetting(key, val) {
                if (key === 'masterMute') {
                    State.audio.masterMute = val;
                } else if (State.settings.hasOwnProperty(key)) {
                    State.settings[key] = val;
                    if (key === 'opacity') {
                        document.getElementById('dialogue-box').style.opacity = val;
                    }
                }
                this.switchTab(document.getElementById('tab-sound').classList.contains('active') ? 'sound' : 'display');
            },

            showScore() {
                const modal = document.getElementById('score-modal');
                modal.classList.remove('hidden');
                document.getElementById('score-header').innerText = this.t('SCORE');

                const scores = JSON.parse(localStorage.getItem('aaa_scores') || '[]');
                const totalPlayers = scores.length;
                const totalTime = scores.reduce((acc, s) => acc + (s.time || 0), 0);

                document.getElementById('score-summary').innerHTML = `
                    <div><div class="text-sm opacity-50">${this.t('TOTAL_PLAYERS')}</div><div class="text-4xl font-bold">${totalPlayers}</div></div>
                    <div><div class="text-sm opacity-50">${this.t('TOTAL_TIME')}</div><div class="text-4xl font-bold">${Math.floor(totalTime / 60)}m ${totalTime % 60}s</div></div>
                `;

                document.getElementById('score-list').innerHTML = scores.slice(0, 10).map(s => `
                    <div class="flex justify-between bg-white/5 p-4 rounded-xl border border-white/10">
                        <span class="font-bold text-accent-gold">${s.name}</span>
                        <span class="opacity-70">${s.date}</span>
                        <span>${Math.floor(s.time / 60)}m ${s.time % 60}s</span>
                    </div>
                `).join('') || '<p class="text-center opacity-30 mt-10">NO DATA</p>';
            },

            showCredits() {
                document.getElementById('credits-modal').classList.remove('hidden');
            },

            showExit() {
                this.showConfirm(this.t('QUIT_CONFIRM'), () => {
                    window.close();
                });
            },

            toMenu() {
                this.showConfirm(this.t('QUIT_CONFIRM'), () => {
                    this.closeAllModals();
                    document.getElementById('menu-layer').style.display = 'block';
                    document.getElementById('menu-layer').classList.remove('fade-out');
                    document.getElementById('system-ui').classList.add('hidden');
                    document.getElementById('dialogue-layer').style.display = 'none';
                    document.getElementById('interaction-layer').innerHTML = '';
                    document.getElementById('character-layer').innerHTML = '';
                    document.getElementById('bgimage-layer').innerHTML = '';
                    document.getElementById('bgcolor-layer').style.backgroundColor = '#000';
                    document.getElementById('title-layer').innerHTML = '';

                    this.stopAudio('bgm');
                    this.stopAudio('amb');
                    this.stopAudio('voice');

                    State.currentIndex = 0;
                    State.characters = {};
                    State.settings.autoMode = false;
                    State.isInteractionWaiting = false;
                    State.isChoiceActive = false;
                    State.isQuizActive = false;
                    document.getElementById('auto-btn').innerText = `AUTO: OFF`;
                    this.updateTitleMenu();
                });
            },

            closeAllModals() {
                ['options-modal', 'score-modal', 'credits-modal', 'universal-confirm', 'universal-alert', 'backlog-modal'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
            },

            showAlert(msg, cb) {
                const modal = document.getElementById('universal-alert');
                document.getElementById('alert-msg').innerHTML = this.formatText(msg);
                const btn = document.getElementById('alert-ok');
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    if (cb) cb();
                };
                modal.classList.remove('hidden');
            },

            showConfirm(msg, onYes, onNo) {
                const modal = document.getElementById('universal-confirm');
                document.getElementById('confirm-msg').innerHTML = this.formatText(msg);

                const yesBtn = document.getElementById('confirm-yes');
                const noBtn = document.getElementById('confirm-no');

                yesBtn.innerText = this.t('YES');
                noBtn.innerText = this.t('NO');

                yesBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onYes) onYes();
                };
                noBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onNo) onNo();
                };
                modal.classList.remove('hidden');
            },

            debug(msg) {
                console.log("[DEBUG]", msg);
            }
        }

        window.onload = () => Engine.init();
    </script>
</body>

</html>